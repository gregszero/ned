{"type":"file-history-snapshot","messageId":"2a16f9a6-b9ac-47c4-b037-39bf0d9bffda","snapshot":{"messageId":"2a16f9a6-b9ac-47c4-b037-39bf0d9bffda","trackedFileBackups":{},"timestamp":"2026-02-21T02:10:15.794Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"SessionStart","hookName":"SessionStart:clear","command":"entire hooks claude-code session-start"},"parentToolUseID":"1ee16a15-af00-4986-98bb-02c0507cf573","toolUseID":"1ee16a15-af00-4986-98bb-02c0507cf573","timestamp":"2026-02-21T02:10:15.765Z","uuid":"c3b9b903-bf1f-4aac-b9fb-e5b5e9616b6d"}
{"parentUuid":"c3b9b903-bf1f-4aac-b9fb-e5b5e9616b6d","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":"Implement the following plan:\n\n# Plan: Update README.md and CLAUDE.md\n\n## Context\n\nThe codebase has grown significantly beyond what README.md and CLAUDE.md document. The inner agent prompt (`workspace/CLAUDE.md`) is well-maintained and comprehensive, but the developer-facing docs are stale. The framework now has ~38 MCP tools (docs say 18), 18 models, documents/data tables/approvals/Gmail/Python support — none reflected in README or CLAUDE.md.\n\nThe goal: these files should accurately describe the framework as a platform where AI builds its own automation — skills, workflows, triggers, heartbeats, data tables, documents, approvals — all token-efficiently.\n\n## Changes\n\n### 1. Update `README.md`\n\n**Tool count fixes** (appears in 5 places):\n- Diagram: \"...18 tools\" → \"...38 tools\"\n- Paragraph below diagram: \"18 MCP tools\" → \"38 MCP tools\"\n- Architecture table: \"18 tools + 6 resources\" → \"38 tools + 6 resources\"\n- MCP Tools heading/intro: \"18 MCP tools\" → \"38 MCP tools\"\n\n**Add missing features sections** (after Workflows section, before MCP Tools):\n\n- **Documents** — Upload/parse/generate files (PDF, CSV, Excel, text). Extracted text available to agent. Token-efficient: parse once, read many times.\n- **Dynamic Data Tables** — AI creates real SQLite tables on the fly with custom schemas. Full CRUD via tools. Used for structured data the agent needs to track.\n- **Approvals** — Human-in-the-loop gates. Standalone or as workflow steps. Optional timeout with auto-expiry. Events emitted on decision.\n- **Gmail Integration** — Full OAuth2 Gmail: search, read, send, draft, modify labels. 6 dedicated tools.\n- **Python Support** — Run Python code alongside Ruby. Virtualenv management. Python skills auto-discovered from `skills/`.\n\n**Update MCP Tools table** — Add all missing tools:\n- `manage_python`, `update_canvas`, document tools (3), data table tools (5), approval tools (3), Gmail tools (6)\n\n**Update Workflows section** — Add `approval` step type to the table.\n\n**Update Widgets table** — Add: `data_table` (dynamic), `approval`, `computer_use`, `scheduled_jobs`, `settings`, `website`.\n\n### 2. Update `CLAUDE.md`\n\n**Update Existing MCP Tools table** — Currently lists only 8 tools. Replace with complete list of all ~38 tools grouped by category:\n- Core (run_code, run_skill, manage_python, send_message)\n- Scheduling (schedule_task)\n- Pages & Canvas (create_page, get_canvas, update_canvas, add/update/remove_canvas_component, define_widget)\n- Documents (create_document, read_document, list_documents)\n- Data Tables (create_data_table, list_data_tables, query_data_table, insert/update/delete_data_record)\n- Approvals (create_approval, list_approvals, resolve_approval)\n- Automation (create_notification, create_trigger, create_workflow, create/update/list_heartbeats)\n- Web (web_fetch, start_computer_use)\n- Gmail (gmail_search, gmail_read, gmail_send, gmail_draft, gmail_modify, gmail_labels)\n\n**Update Event System** — Add missing event types:\n- `workflow:completed:*` / `workflow:failed:*`\n- `approval:approved:*` / `approval:rejected:*` / `approval:expired:*`\n\n**Update Workflow step types** — Add `approval` step type.\n\n**Add missing concern** — `HasJsonDefaults` alongside `HasStatus`.\n\n**Update Key Files table** — Add:\n- `fang/skill_loader.rb` — Skill discovery and execution\n- `fang/python_runner.rb` — Python virtualenv and code execution\n- `fang/document_parser.rb` — Multi-format document text extraction\n- `fang/gmail.rb` — Gmail OAuth2 integration\n- `fang/whatsapp.rb` — WhatsApp message routing\n- `fang/system_profile.rb` — Host system capability detection\n\n**Update CSS tokens** — Current values in CLAUDE.md don't match actual `style.css`. Update light/dark values to match reality.\n\n**Update Architecture section** — Add `fang/computer_use/` to the tree.\n\n### 3. Files to modify\n\n- `/home/greg/Developer/openfang/README.md`\n- `/home/greg/Developer/openfang/CLAUDE.md`\n\n### 4. Verification\n\n- Read both files after editing to confirm accuracy\n- Cross-reference tool counts against `fang/tools/` directory listing\n- Ensure no stale references remain (e.g., \"18 tools\")\n\n\nIf you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /home/greg/.REDACTED.jsonl"},"uuid":"2a16f9a6-b9ac-47c4-b037-39bf0d9bffda","timestamp":"2026-02-21T02:10:15.717Z","planContent":"# Plan: Update README.md and CLAUDE.md\n\n## Context\n\nThe codebase has grown significantly beyond what README.md and CLAUDE.md document. The inner agent prompt (`workspace/CLAUDE.md`) is well-maintained and comprehensive, but the developer-facing docs are stale. The framework now has ~38 MCP tools (docs say 18), 18 models, documents/data tables/approvals/Gmail/Python support — none reflected in README or CLAUDE.md.\n\nThe goal: these files should accurately describe the framework as a platform where AI builds its own automation — skills, workflows, triggers, heartbeats, data tables, documents, approvals — all token-efficiently.\n\n## Changes\n\n### 1. Update `README.md`\n\n**Tool count fixes** (appears in 5 places):\n- Diagram: \"...18 tools\" → \"...38 tools\"\n- Paragraph below diagram: \"18 MCP tools\" → \"38 MCP tools\"\n- Architecture table: \"18 tools + 6 resources\" → \"38 tools + 6 resources\"\n- MCP Tools heading/intro: \"18 MCP tools\" → \"38 MCP tools\"\n\n**Add missing features sections** (after Workflows section, before MCP Tools):\n\n- **Documents** — Upload/parse/generate files (PDF, CSV, Excel, text). Extracted text available to agent. Token-efficient: parse once, read many times.\n- **Dynamic Data Tables** — AI creates real SQLite tables on the fly with custom schemas. Full CRUD via tools. Used for structured data the agent needs to track.\n- **Approvals** — Human-in-the-loop gates. Standalone or as workflow steps. Optional timeout with auto-expiry. Events emitted on decision.\n- **Gmail Integration** — Full OAuth2 Gmail: search, read, send, draft, modify labels. 6 dedicated tools.\n- **Python Support** — Run Python code alongside Ruby. Virtualenv management. Python skills auto-discovered from `skills/`.\n\n**Update MCP Tools table** — Add all missing tools:\n- `manage_python`, `update_canvas`, document tools (3), data table tools (5), approval tools (3), Gmail tools (6)\n\n**Update Workflows section** — Add `approval` step type to the table.\n\n**Update Widgets table** — Add: `data_table` (dynamic), `approval`, `computer_use`, `scheduled_jobs`, `settings`, `website`.\n\n### 2. Update `CLAUDE.md`\n\n**Update Existing MCP Tools table** — Currently lists only 8 tools. Replace with complete list of all ~38 tools grouped by category:\n- Core (run_code, run_skill, manage_python, send_message)\n- Scheduling (schedule_task)\n- Pages & Canvas (create_page, get_canvas, update_canvas, add/update/remove_canvas_component, define_widget)\n- Documents (create_document, read_document, list_documents)\n- Data Tables (create_data_table, list_data_tables, query_data_table, insert/update/delete_data_record)\n- Approvals (create_approval, list_approvals, resolve_approval)\n- Automation (create_notification, create_trigger, create_workflow, create/update/list_heartbeats)\n- Web (web_fetch, start_computer_use)\n- Gmail (gmail_search, gmail_read, gmail_send, gmail_draft, gmail_modify, gmail_labels)\n\n**Update Event System** — Add missing event types:\n- `workflow:completed:*` / `workflow:failed:*`\n- `approval:approved:*` / `approval:rejected:*` / `approval:expired:*`\n\n**Update Workflow step types** — Add `approval` step type.\n\n**Add missing concern** — `HasJsonDefaults` alongside `HasStatus`.\n\n**Update Key Files table** — Add:\n- `fang/skill_loader.rb` — Skill discovery and execution\n- `fang/python_runner.rb` — Python virtualenv and code execution\n- `fang/document_parser.rb` — Multi-format document text extraction\n- `fang/gmail.rb` — Gmail OAuth2 integration\n- `fang/whatsapp.rb` — WhatsApp message routing\n- `fang/system_profile.rb` — Host system capability detection\n\n**Update CSS tokens** — Current values in CLAUDE.md don't match actual `style.css`. Update light/dark values to match reality.\n\n**Update Architecture section** — Add `fang/computer_use/` to the tree.\n\n### 3. Files to modify\n\n- `/home/greg/Developer/openfang/README.md`\n- `/home/greg/Developer/openfang/CLAUDE.md`\n\n### 4. Verification\n\n- Read both files after editing to confirm accuracy\n- Cross-reference tool counts against `fang/tools/` directory listing\n- Ensure no stale references remain (e.g., \"18 tools\")\n"}
{"parentUuid":"2a16f9a6-b9ac-47c4-b037-39bf0d9bffda","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Vj8sDWYmJeTunNxUi3Yh8j","type":"message","role":"assistant","content":[{"type":"text","text":"\n\nI'll start by reading the current files and gathering the actual tool/model counts to ensure accuracy."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5928,"cache_read_input_tokens":18770,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5928},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQF2jQAGKHe6db1hep9","type":"assistant","uuid":"fbe0a830-ba29-473a-85da-fd07c97a0300","timestamp":"2026-02-21T02:10:18.735Z"}
{"parentUuid":"fbe0a830-ba29-473a-85da-fd07c97a0300","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Vj8sDWYmJeTunNxUi3Yh8j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FFf9EjbKG2P1pxzadMUvCM","name":"Read","input":{"file_path":"/home/greg/Developer/openfang/README.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5928,"cache_read_input_tokens":18770,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5928},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQF2jQAGKHe6db1hep9","type":"assistant","uuid":"26304d55-6a51-4567-8f75-0999d19def80","timestamp":"2026-02-21T02:10:19.167Z"}
{"parentUuid":"26304d55-6a51-4567-8f75-0999d19def80","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01FFf9EjbKG2P1pxzadMUvCM","toolUseID":"toolu_01FFf9EjbKG2P1pxzadMUvCM","timestamp":"2026-02-21T02:10:19.174Z","uuid":"367e9f97-df8f-4247-adf3-f5ca78ea5385"}
{"parentUuid":"26304d55-6a51-4567-8f75-0999d19def80","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FFf9EjbKG2P1pxzadMUvCM","type":"tool_result","content":"     1→# OpenFang\n     2→\n     3→A personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n     4→\n     5→OpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n     6→\n     7→---\n     8→\n     9→## How It Works\n    10→\n    11→```\n    12→You ──► Web UI ──► Conversation ──► Claude CLI subprocess\n    13→                                         │\n    14→                                         ▼\n    15→                                    MCP Tool Server\n    16→                                    ┌──────────────┐\n    17→                                    │  run_code     │\n    18→                                    │  run_skill    │\n    19→                                    │  schedule_task│\n    20→                                    │  create_page  │\n    21→                                    │  web_fetch    │\n    22→                                    │  ...18 tools  │\n    23→                                    └──────┬───────┘\n    24→                                           │\n    25→                                    ┌──────▼───────┐\n    26→                                    │  ActiveRecord │\n    27→                                    │  SQLite / PG  │\n    28→                                    └──────┬───────┘\n    29→                                           │\n    30→                                    ┌──────▼───────┐\n    31→                                    │  SSE / Turbo  │\n    32→                                    │  Streams      │\n    33→                                    └──────┬───────┘\n    34→                                           │\n    35→                                           ▼\n    36→                                    Real-time UI update\n    37→```\n    38→\n    39→When you send a message, OpenFang spawns a `claude` CLI subprocess with access to 18 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n    40→\n    41→---\n    42→\n    43→## Architecture\n    44→\n    45→Everything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n    46→\n    47→| Layer | Technology | Purpose |\n    48→|---|---|---|\n    49→| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n    50→| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n    51→| Tool protocol | **FastMCP** (SSE) | 18 tools + 6 resources exposed to Claude |\n    52→| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n    53→| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n    54→| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n    55→| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n    56→| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n    57→\n    58→### Project Structure\n    59→\n    60→```\n    61→openfang.rb                 # CLI entrypoint (Thor)\n    62→fang/\n    63→├── agent.rb                # Spawns claude CLI, streams NDJSON\n    64→├── bootstrap.rb            # Loads everything, connects DB\n    65→├── mcp_server.rb           # Auto-discovers tools & resources\n    66→├── scheduler.rb            # Rufus recurring jobs\n    67→├── event_bus.rb            # In-process pub/sub\n    68→├── skill_loader.rb         # Loads skills from skills/\n    69→├── models/                 # ActiveRecord models\n    70→├── tools/                  # MCP tools (auto-registered)\n    71→├── resources/              # MCP resources (auto-registered)\n    72→├── widgets/                # Canvas widget types\n    73→├── jobs/                   # ActiveJob classes\n    74→└── concerns/               # Shared model behavior\n    75→web/\n    76→├── app.rb                  # All Roda routes\n    77→├── views/                  # ERB templates\n    78→├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n    79→└── public/                 # Static assets, CSS, JS\n    80→skills/                     # Ruby skill files (auto-loaded)\n    81→workspace/\n    82→├── CLAUDE.md               # System prompt for the inner agent\n    83→├── .mcp.json               # MCP server config for subprocess\n    84→└── migrations/             # Database migrations\n    85→```\n    86→\n    87→---\n    88→\n    89→## Features\n    90→\n    91→### Canvas Pages — Persistent, Widget-Based Dashboards\n    92→\n    93→Every page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n    94→\n    95→Widgets are self-rendering Ruby classes. Built-in types include:\n    96→\n    97→| Widget | What It Does |\n    98→|---|---|\n    99→| `metric` | Big number with trend indicator, auto-refreshes from data source |\n   100→| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n   101→| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n   102→| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n   103→| `weather` | Current conditions via Open-Meteo API |\n   104→| `hacker_news` | Top stories from HN |\n   105→| `clock` | Live clock with configurable timezone |\n   106→| `note` | Editable markdown |\n   107→| `banner` | Colored alert bar |\n   108→| `list` | Items with optional links, auto-refresh from data source |\n   109→\n   110→Claude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n   111→\n   112→Widgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n   113→\n   114→---\n   115→\n   116→### Skills — Reusable Ruby Code That Saves Tokens\n   117→\n   118→Skills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n   119→\n   120→```ruby\n   121→class WeatherCheck < Fang::Skill\n   122→  description \"Check weather for a city\"\n   123→  param :city, :string, required: true\n   124→\n   125→  def call(city:)\n   126→    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n   127→    { temperature: response[\"current\"][\"temperature_2m\"] }\n   128→  end\n   129→end\n   130→```\n   131→\n   132→After that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n   133→\n   134→The `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n   135→\n   136→**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n   137→\n   138→---\n   139→\n   140→### Scheduling — Cron, One-Shot, and Relative Times\n   141→\n   142→The `schedule_task` tool handles any time-based request:\n   143→\n   144→```\n   145→\"Remind me in 2 hours\"          → relative time parsing\n   146→\"Run deploy check tomorrow\"     → natural date parsing\n   147→\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n   148→```\n   149→\n   150→Scheduled tasks can either:\n   151→- **Run a skill** directly (zero tokens — pure Ruby execution)\n   152→- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n   153→\n   154→Recurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n   155→\n   156→The scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n   157→\n   158→---\n   159→\n   160→### Heartbeats — Token-Efficient Monitoring\n   161→\n   162→Heartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n   163→\n   164→**How it works:**\n   165→\n   166→```\n   167→┌─────────────────────────────────────────────────────┐\n   168→│  Every 30 seconds, the scheduler checks due beats   │\n   169→└──────────────────────┬──────────────────────────────┘\n   170→                       │\n   171→                       ▼\n   172→┌──────────────────────────────────────────────────────┐\n   173→│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n   174→│  e.g., check disk space, query an API, count errors  │\n   175→└──────────────────────┬───────────────────────────────┘\n   176→                       │\n   177→              Is result meaningful?\n   178→              (not nil, not empty, not false)\n   179→                       │\n   180→            ┌──────────┴──────────┐\n   181→            │                     │\n   182→         NO ▼                  YES ▼\n   183→    ┌───────────┐        ┌─────────────────┐\n   184→    │  Skip.    │        │  NOW invoke the  │\n   185→    │  Log it.  │        │  agent with the  │\n   186→    │  Move on. │        │  result data.    │\n   187→    │  (free)   │        │  (tokens spent)  │\n   188→    └───────────┘        └─────────────────┘\n   189→```\n   190→\n   191→A heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n   192→\n   193→The `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n   194→\n   195→Each heartbeat has a `prompt_template` with interpolation:\n   196→\n   197→```\n   198→\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n   199→```\n   200→\n   201→---\n   202→\n   203→### Events, Triggers, and Workflows\n   204→\n   205→**EventBus** is an in-process pub/sub that ties the system together:\n   206→\n   207→```ruby\n   208→EventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n   209→```\n   210→\n   211→Events are emitted automatically by:\n   212→- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n   213→- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n   214→- Notification creation → `notification:created:*`\n   215→- Workflow completion → `workflow:completed:*`\n   216→\n   217→**Triggers** listen for events via glob patterns and fire actions:\n   218→\n   219→```\n   220→Pattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\n   221→Pattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n   222→```\n   223→\n   224→Triggers auto-disable after 5 consecutive failures for safety.\n   225→\n   226→**Workflows** are multi-step pipelines with data passing between steps:\n   227→\n   228→| Step Type | What It Does |\n   229→|---|---|\n   230→| `skill` | Runs a skill, stores result in context |\n   231→| `prompt` | Sends a message to Claude, gets a response |\n   232→| `condition` | Evaluates an expression, optionally skips to a step |\n   233→| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n   234→| `notify` | Creates a notification |\n   235→\n   236→Steps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n   237→\n   238→```\n   239→Step 1 (skill: \"check_status\")    → result stored as context.check_status\n   240→Step 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\n   241→Step 3 (notify: \"Action taken: {{context.step_2}}\")\n   242→```\n   243→\n   244→Workflows can auto-start on a trigger event or be kicked off immediately.\n   245→\n   246→---\n   247→\n   248→### MCP Tools & Resources\n   249→\n   250→Claude interacts with OpenFang through 18 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n   251→\n   252→**Tools** (auto-discovered from `fang/tools/`):\n   253→\n   254→| Tool | Purpose |\n   255→|---|---|\n   256→| `run_code` | Execute arbitrary Ruby with full model access |\n   257→| `run_skill` | Execute a saved skill by name |\n   258→| `send_message` | Send a message to the conversation |\n   259→| `schedule_task` | Schedule a one-shot or recurring task |\n   260→| `create_page` | Create a new canvas page |\n   261→| `create_notification` | Push a real-time notification |\n   262→| `create_trigger` | Set up an event-driven trigger |\n   263→| `create_workflow` | Build a multi-step automation pipeline |\n   264→| `create_heartbeat` | Set up a token-efficient monitor |\n   265→| `update_heartbeat` | Modify a heartbeat's config |\n   266→| `list_heartbeats` | View all heartbeats and their stats |\n   267→| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n   268→| `get_canvas` | Read current page's widget layout |\n   269→| `update_canvas` | Set page HTML content |\n   270→| `add_canvas_component` | Add a widget to the canvas |\n   271→| `update_canvas_component` | Modify a widget's position/content/data |\n   272→| `remove_canvas_component` | Remove a widget |\n   273→| `define_widget` | Create a new widget type (writes Ruby to disk) |\n   274→\n   275→**Resources** (context the agent can read):\n   276→\n   277→| Resource | What It Provides |\n   278→|---|---|\n   279→| `config://user` | All config key/values, framework version |\n   280→| `conversation://current` | Current conversation context, last 10 messages |\n   281→| `skills://available` | All registered skills with usage counts |\n   282→| `database://schema` | Full schema: tables, columns, indexes, row counts |\n   283→| `gems://available` | All bundled gems and versions |\n   284→| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n   285→\n   286→**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n   287→\n   288→---\n   289→\n   290→### Real-Time Web UI\n   291→\n   292→The UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n   293→\n   294→**What updates in real time:**\n   295→- Chat messages stream in as Claude generates them (thinking → tool use → text)\n   296→- Canvas widgets refresh when data changes\n   297→- Notifications appear instantly in the bell menu\n   298→- Heartbeat monitor updates after each run\n   299→\n   300→**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n   301→\n   302→**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n   303→\n   304→---\n   305→\n   306→### WhatsApp Integration\n   307→\n   308→Optional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n   309→\n   310→---\n   311→\n   312→## Quick Start\n   313→\n   314→### Requirements\n   315→\n   316→- Ruby 3.3+\n   317→- SQLite3 (or PostgreSQL)\n   318→- Claude Code CLI (`claude`) installed and authenticated\n   319→\n   320→### Setup\n   321→\n   322→```bash\n   323→git clone https://github.com/youruser/openfang.git\n   324→cd openfang\n   325→./setup.sh\n   326→```\n   327→\n   328→### Authentication\n   329→\n   330→OpenFang needs an Anthropic API key for the agent subprocess:\n   331→\n   332→```bash\n   333→export ANTHROPIC_API_KEY=\"sk-ant-...\"\n   334→```\n   335→\n   336→### Running\n   337→\n   338→```bash\n   339→./openfang.rb server        # Web UI on port 3000\n   340→./openfang.rb console       # IRB with all models loaded\n   341→./openfang.rb db:migrate    # Run pending migrations\n   342→./openfang.rb mcp           # MCP server standalone (port 9292)\n   343→```\n   344→\n   345→Open `http://localhost:3000` and start chatting.\n   346→\n   347→---\n   348→\n   349→## Adding a Skill\n   350→\n   351→Create `skills/my_skill.rb`:\n   352→\n   353→```ruby\n   354→class MySkill < Fang::Skill\n   355→  description \"What this skill does\"\n   356→  param :name, :string, required: true, description: \"Who to greet\"\n   357→\n   358→  def call(name:)\n   359→    send_message(\"Hello, #{name}!\")\n   360→    { greeted: name }\n   361→  end\n   362→end\n   363→```\n   364→\n   365→Restart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n   366→\n   367→Or let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n   368→\n   369→---\n   370→\n   371→## Adding an MCP Tool\n   372→\n   373→Create `fang/tools/my_tool.rb`:\n   374→\n   375→```ruby\n   376→module Fang\n   377→  module Tools\n   378→    class MyTool < FastMcp::Tool\n   379→      tool_name 'my_tool'\n   380→      description 'What this tool does'\n   381→\n   382→      arguments do\n   383→        required(:input).filled(:string).description('The input')\n   384→      end\n   385→\n   386→      def call(input:)\n   387→        { success: true, result: input.upcase }\n   388→      rescue => e\n   389→        { success: false, error: e.message }\n   390→      end\n   391→    end\n   392→  end\n   393→end\n   394→```\n   395→\n   396→Restart. Auto-discovered via `ObjectSpace`.\n   397→\n   398→---\n   399→\n   400→## Token Efficiency by Design\n   401→\n   402→OpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n   403→\n   404→| Pattern | How It Saves Tokens |\n   405→|---|---|\n   406→| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n   407→| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n   408→| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n   409→| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n   410→| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n   411→\n   412→The philosophy: Claude's job is to *build the automation*, not *be the automation*.\n   413→\n   414→---\n   415→\n   416→## License\n   417→\n   418→MIT\n   419→"}]},"uuid":"3a1168a4-1c3a-4034-a548-ad0e92fafeec","timestamp":"2026-02-21T02:10:19.174Z","toolUseResult":{"type":"text","file":{"filePath":"/home/greg/Developer/openfang/README.md","content":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...18 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 18 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 18 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 18 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","numLines":419,"startLine":1,"totalLines":419}},"sourceToolAssistantUUID":"26304d55-6a51-4567-8f75-0999d19def80"}
{"parentUuid":"3a1168a4-1c3a-4034-a548-ad0e92fafeec","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Vj8sDWYmJeTunNxUi3Yh8j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019csaqsxLh1juJKQ9VTydGh","name":"Read","input":{"file_path":"/home/greg/Developer/openfang/CLAUDE.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5928,"cache_read_input_tokens":18770,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5928},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQF2jQAGKHe6db1hep9","type":"assistant","uuid":"90129729-52bf-40e6-b45e-f4f9a4376c6b","timestamp":"2026-02-21T02:10:19.628Z"}
{"parentUuid":"90129729-52bf-40e6-b45e-f4f9a4376c6b","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_019csaqsxLh1juJKQ9VTydGh","toolUseID":"toolu_019csaqsxLh1juJKQ9VTydGh","timestamp":"2026-02-21T02:10:19.635Z","uuid":"fe1e6964-adb7-4239-8db6-14858ce11b42"}
{"parentUuid":"90129729-52bf-40e6-b45e-f4f9a4376c6b","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019csaqsxLh1juJKQ9VTydGh","type":"tool_result","content":"     1→# OpenFang — Claude Code Guide\n     2→\n     3→## What This Is\n     4→\n     5→A personal AI assistant framework (\"OpenFang\") built in Ruby. It combines a Roda web UI, ActiveRecord models (SQLite), FastMCP tool server, and a Claude Code CLI subprocess as the agent runtime.\n     6→\n     7→## Architecture\n     8→\n     9→```\n    10→openfang.rb (entrypoint) → Fang::CLI (Thor)\n    11→├── web/app.rb          Roda web server (port 3000)\n    12→├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n    13→├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n    14→├── fang/bootstrap.rb     Loads everything, connects DB\n    15→└── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n    16→```\n    17→\n    18→**Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process.\n    19→\n    20→**Agent execution**: When a user sends a message, `AgentExecutorJob` runs `Fang::Agent.execute`, which spawns a `claude` CLI subprocess with MCP tools. The subprocess uses `workspace/.mcp.json` and `workspace/CLAUDE.md` as its system prompt.\n    21→\n    22→## Key Conventions\n    23→\n    24→- **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed.\n    25→- **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.\n    26→- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`).\n    27→\n    28→## Running the App\n    29→\n    30→```bash\n    31→./openfang.rb server        # Start web UI on port 3000\n    32→./openfang.rb console       # IRB with all models loaded\n    33→./openfang.rb db:migrate    # Run pending migrations\n    34→./openfang.rb mcp           # Start MCP server standalone\n    35→```\n    36→\n    37→## Adding a New MCP Tool\n    38→\n    39→1. Create `fang/tools/my_tool.rb`:\n    40→\n    41→```ruby\n    42→# frozen_string_literal: true\n    43→\n    44→module Fang\n    45→  module Tools\n    46→    class MyTool < FastMcp::Tool\n    47→      tool_name 'my_tool'\n    48→      description 'What this tool does'\n    49→\n    50→      arguments do\n    51→        required(:name).filled(:string).description('Argument description')\n    52→        optional(:option).filled(:string).description('Optional argument')\n    53→      end\n    54→\n    55→      def call(name:, option: nil)\n    56→        # Tool logic here — all Fang:: models are available\n    57→        { success: true, result: 'done' }\n    58→      rescue => e\n    59→        { success: false, error: e.message }\n    60→      end\n    61→    end\n    62→  end\n    63→end\n    64→```\n    65→\n    66→2. Restart the server. The tool is auto-discovered.\n    67→\n    68→## Adding a Route/View\n    69→\n    70→1. Add route in `web/app.rb` following Roda `r.on` / `r.is` patterns\n    71→2. Create ERB template in `web/views/`\n    72→3. Add nav link in `web/views/layout.erb` sidebar `<nav>` section\n    73→\n    74→## Adding a Model\n    75→\n    76→1. Create migration in `workspace/migrations/YYYYMMDDNNNNNN_description.rb`:\n    77→\n    78→```ruby\n    79→class CreateThings < ActiveRecord::Migration[8.0]\n    80→  def change\n    81→    create_table :things do |t|\n    82→      t.string :name, null: false\n    83→      t.timestamps\n    84→    end\n    85→  end\n    86→end\n    87→```\n    88→\n    89→2. Create model in `fang/models/thing.rb`:\n    90→\n    91→```ruby\n    92→module Fang\n    93→  class Thing < ActiveRecord::Base\n    94→    self.table_name = 'things'\n    95→  end\n    96→end\n    97→```\n    98→\n    99→3. Run `./openfang.rb db:migrate`\n   100→\n   101→## Adding an API Client\n   102→\n   103→`Fang::ApplicationClient` (`fang/application_client.rb`) is a base HTTP client using `Net::HTTP`. Subclasses get their own `Response`, `Error`, `NotFound`, etc. classes automatically.\n   104→\n   105→1. Create `fang/clients/my_service_client.rb`:\n   106→\n   107→```ruby\n   108→# frozen_string_literal: true\n   109→\n   110→module Fang\n   111→  module Clients\n   112→    class MyService < ApplicationClient\n   113→      BASE_URI = \"https://api.myservice.com/v1\"\n   114→\n   115→      # Override if the API uses a different auth scheme\n   116→      # def authorization_header = { \"X-API-Key\" => token }\n   117→\n   118→      def widgets\n   119→        get(\"/widgets\")\n   120→      rescue *NET_HTTP_ERRORS\n   121→        raise Error, \"Unable to fetch widgets\"\n   122→      end\n   123→\n   124→      def create_widget(name:)\n   125→        post(\"/widgets\", body: { name: name })\n   126→      end\n   127→    end\n   128→  end\n   129→end\n   130→```\n   131→\n   132→2. Restart the server. Clients in `fang/clients/` are auto-loaded.\n   133→\n   134→### Key features\n   135→\n   136→- **HTTP methods**: `get`, `post`, `patch`, `put`, `delete` — all accept `headers:`, `query:`, `body:`, `form_data:`\n   137→- **JSON by default**: Request bodies are serialized to JSON. Responses with `application/json` are parsed to `OpenStruct` for dot-access (e.g., `response.name`).\n   138→- **Auth**: Pass `token:` on init. Override `authorization_header` for non-Bearer schemes.\n   139→- **Error handling**: Raises typed errors (`NotFound`, `Unauthorized`, `RateLimit`, etc.). Rescue `*NET_HTTP_ERRORS` for network failures.\n   140→- **Pagination**: `with_pagination(path) { |response| next_page_or_nil }` loops until the block returns nil.\n   141→- **Custom response parsers**: Override per-client with `Response::PARSER[\"text/html\"] = ->(r) { Nokogiri::HTML(r.body) }`\n   142→\n   143→### Usage\n   144→\n   145→```ruby\n   146→client = Fang::Clients::MyService.new(token: ENV[\"MY_SERVICE_API_KEY\"])\n   147→client.widgets          # => Response with dot-access to parsed JSON\n   148→client.create_widget(name: \"Foo\")\n   149→```\n   150→\n   151→## Design System\n   152→\n   153→Clean, minimal shadcn/ui-inspired design with terminal green accent. Supports light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows.\n   154→\n   155→### CSS Tokens (defined in `web/public/css/style.css`)\n   156→\n   157→Light and dark mode tokens are defined as CSS custom properties. The `--fang-*` aliases are used by Tailwind classes.\n   158→\n   159→| Token | Light | Dark | Usage |\n   160→|---|---|---|---|\n   161→| `--background` | `#ffffff` | `#09090b` | Page background |\n   162→| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n   163→| `--card` | `#ffffff` | `#18181b` | Card backgrounds |\n   164→| `--muted` | `#f1f5f9` | `#27272a` | Muted backgrounds |\n   165→| `--muted-foreground` | `#64748b` | `#a1a1aa` | Muted text |\n   166→| `--primary` | `#16a34a` | `#22c55e` | Accent (green) |\n   167→| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n   168→| `--border` | `#e2e8f0` | `#27272a` | Borders |\n   169→| `--ring` | `#16a34a` | `#22c55e` | Focus rings |\n   170→\n   171→### Components\n   172→- **`.card`** — rounded card with subtle border and shadow\n   173→- **`.badge`** — pill label (variants: `.success`, `.error`, `.warning`, `.info`)\n   174→- **`button`** — green bg, rounded. Variants: `.ghost`, `.outline`, `.sm`, `.xs`, `.icon`\n   175→- **`.chat-msg.user`** / **`.chat-msg.ai`** — rounded chat bubbles\n   176→- **`.prose-bubble`** — markdown content inside chat bubbles\n   177→- **`.section-heading`** — card section titles\n   178→- **`.msg-meta`** — chat message metadata (small, uppercase, muted)\n   179→- **`.notification-unread`** — unread notification left border accent\n   180→- **`.nav-trigger`** — hamburger menu button\n   181→- **`.notification-badge`** — small pill badge for notification counts\n   182→\n   183→### Rules\n   184→- **No inline styles** — all styling via Tailwind utilities or CSS classes\n   185→- **No `text-transform: uppercase`** on headings — use `font-semibold tracking-tight`\n   186→\n   187→Tailwind CSS is loaded via CDN with custom colors: `fang-bg`, `fang-fg`, `fang-muted`, `fang-muted-fg`, `fang-accent`, `fang-accent-fg`, `fang-border`, `fang-card`, `fang-primary`, `fang-ring`.\n   188→\n   189→## Event System\n   190→\n   191→`Fang::EventBus` is a simple in-process pub/sub for decoupled automation. Call `EventBus.emit(\"event:name\", data)` to fire an event. Triggers and workflows listen for matching events.\n   192→\n   193→**Emit points** are wired into:\n   194→- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n   195→- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n   196→- `Notification#broadcast!` → `notification:created:*`\n   197→\n   198→**Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt.\n   199→\n   200→**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.\n   201→\n   202→## Key Files\n   203→\n   204→| File | Purpose |\n   205→|---|---|\n   206→| `openfang.rb` | CLI entrypoint |\n   207→| `fang/bootstrap.rb` | Framework loader |\n   208→| `fang/agent.rb` | Claude subprocess execution |\n   209→| `fang/mcp_server.rb` | FastMCP tool/resource registration |\n   210→| `fang/application_client.rb` | Base HTTP API client (subclass for new integrations) |\n   211→| `fang/event_bus.rb` | In-process event pub/sub for triggers and workflows |\n   212→| `web/app.rb` | All Roda routes |\n   213→| `web/views/layout.erb` | Main layout with sidebar nav |\n   214→| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n   215→| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n   216→| `web/public/css/style.css` | Complete design system |\n   217→| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n   218→| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n   219→\n   220→## Existing MCP Tools\n   221→\n   222→| Tool | File | Purpose |\n   223→|---|---|---|\n   224→| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n   225→| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n   226→| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n   227→| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n   228→| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n   229→| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n   230→| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n   231→| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |\n   232→"}]},"uuid":"51a38f38-b2c9-467e-8024-b565e317c53f","timestamp":"2026-02-21T02:10:19.634Z","toolUseResult":{"type":"text","file":{"filePath":"/home/greg/Developer/openfang/CLAUDE.md","content":"# OpenFang — Claude Code Guide\n\n## What This Is\n\nA personal AI assistant framework (\"OpenFang\") built in Ruby. It combines a Roda web UI, ActiveRecord models (SQLite), FastMCP tool server, and a Claude Code CLI subprocess as the agent runtime.\n\n## Architecture\n\n```\nopenfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb          Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n└── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n```\n\n**Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process.\n\n**Agent execution**: When a user sends a message, `AgentExecutorJob` runs `Fang::Agent.execute`, which spawns a `claude` CLI subprocess with MCP tools. The subprocess uses `workspace/.mcp.json` and `workspace/CLAUDE.md` as its system prompt.\n\n## Key Conventions\n\n- **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed.\n- **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.\n- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`).\n\n## Running the App\n\n```bash\n./openfang.rb server        # Start web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # Start MCP server standalone\n```\n\n## Adding a New MCP Tool\n\n1. Create `fang/tools/my_tool.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:name).filled(:string).description('Argument description')\n        optional(:option).filled(:string).description('Optional argument')\n      end\n\n      def call(name:, option: nil)\n        # Tool logic here — all Fang:: models are available\n        { success: true, result: 'done' }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. The tool is auto-discovered.\n\n## Adding a Route/View\n\n1. Add route in `web/app.rb` following Roda `r.on` / `r.is` patterns\n2. Create ERB template in `web/views/`\n3. Add nav link in `web/views/layout.erb` sidebar `<nav>` section\n\n## Adding a Model\n\n1. Create migration in `workspace/migrations/YYYYMMDDNNNNNN_description.rb`:\n\n```ruby\nclass CreateThings < ActiveRecord::Migration[8.0]\n  def change\n    create_table :things do |t|\n      t.string :name, null: false\n      t.timestamps\n    end\n  end\nend\n```\n\n2. Create model in `fang/models/thing.rb`:\n\n```ruby\nmodule Fang\n  class Thing < ActiveRecord::Base\n    self.table_name = 'things'\n  end\nend\n```\n\n3. Run `./openfang.rb db:migrate`\n\n## Adding an API Client\n\n`Fang::ApplicationClient` (`fang/application_client.rb`) is a base HTTP client using `Net::HTTP`. Subclasses get their own `Response`, `Error`, `NotFound`, etc. classes automatically.\n\n1. Create `fang/clients/my_service_client.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Clients\n    class MyService < ApplicationClient\n      BASE_URI = \"https://api.myservice.com/v1\"\n\n      # Override if the API uses a different auth scheme\n      # def authorization_header = { \"X-API-Key\" => token }\n\n      def widgets\n        get(\"/widgets\")\n      rescue *NET_HTTP_ERRORS\n        raise Error, \"Unable to fetch widgets\"\n      end\n\n      def create_widget(name:)\n        post(\"/widgets\", body: { name: name })\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. Clients in `fang/clients/` are auto-loaded.\n\n### Key features\n\n- **HTTP methods**: `get`, `post`, `patch`, `put`, `delete` — all accept `headers:`, `query:`, `body:`, `form_data:`\n- **JSON by default**: Request bodies are serialized to JSON. Responses with `application/json` are parsed to `OpenStruct` for dot-access (e.g., `response.name`).\n- **Auth**: Pass `token:` on init. Override `authorization_header` for non-Bearer schemes.\n- **Error handling**: Raises typed errors (`NotFound`, `Unauthorized`, `RateLimit`, etc.). Rescue `*NET_HTTP_ERRORS` for network failures.\n- **Pagination**: `with_pagination(path) { |response| next_page_or_nil }` loops until the block returns nil.\n- **Custom response parsers**: Override per-client with `Response::PARSER[\"text/html\"] = ->(r) { Nokogiri::HTML(r.body) }`\n\n### Usage\n\n```ruby\nclient = Fang::Clients::MyService.new(token: ENV[\"MY_SERVICE_API_KEY\"])\nclient.widgets          # => Response with dot-access to parsed JSON\nclient.create_widget(name: \"Foo\")\n```\n\n## Design System\n\nClean, minimal shadcn/ui-inspired design with terminal green accent. Supports light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows.\n\n### CSS Tokens (defined in `web/public/css/style.css`)\n\nLight and dark mode tokens are defined as CSS custom properties. The `--fang-*` aliases are used by Tailwind classes.\n\n| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#ffffff` | `#09090b` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#ffffff` | `#18181b` | Card backgrounds |\n| `--muted` | `#f1f5f9` | `#27272a` | Muted backgrounds |\n| `--muted-foreground` | `#64748b` | `#a1a1aa` | Muted text |\n| `--primary` | `#16a34a` | `#22c55e` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#e2e8f0` | `#27272a` | Borders |\n| `--ring` | `#16a34a` | `#22c55e` | Focus rings |\n\n### Components\n- **`.card`** — rounded card with subtle border and shadow\n- **`.badge`** — pill label (variants: `.success`, `.error`, `.warning`, `.info`)\n- **`button`** — green bg, rounded. Variants: `.ghost`, `.outline`, `.sm`, `.xs`, `.icon`\n- **`.chat-msg.user`** / **`.chat-msg.ai`** — rounded chat bubbles\n- **`.prose-bubble`** — markdown content inside chat bubbles\n- **`.section-heading`** — card section titles\n- **`.msg-meta`** — chat message metadata (small, uppercase, muted)\n- **`.notification-unread`** — unread notification left border accent\n- **`.nav-trigger`** — hamburger menu button\n- **`.notification-badge`** — small pill badge for notification counts\n\n### Rules\n- **No inline styles** — all styling via Tailwind utilities or CSS classes\n- **No `text-transform: uppercase`** on headings — use `font-semibold tracking-tight`\n\nTailwind CSS is loaded via CDN with custom colors: `fang-bg`, `fang-fg`, `fang-muted`, `fang-muted-fg`, `fang-accent`, `fang-accent-fg`, `fang-border`, `fang-card`, `fang-primary`, `fang-ring`.\n\n## Event System\n\n`Fang::EventBus` is a simple in-process pub/sub for decoupled automation. Call `EventBus.emit(\"event:name\", data)` to fire an event. Triggers and workflows listen for matching events.\n\n**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n\n**Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt.\n\n**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.\n\n## Key Files\n\n| File | Purpose |\n|---|---|\n| `openfang.rb` | CLI entrypoint |\n| `fang/bootstrap.rb` | Framework loader |\n| `fang/agent.rb` | Claude subprocess execution |\n| `fang/mcp_server.rb` | FastMCP tool/resource registration |\n| `fang/application_client.rb` | Base HTTP API client (subclass for new integrations) |\n| `fang/event_bus.rb` | In-process event pub/sub for triggers and workflows |\n| `web/app.rb` | All Roda routes |\n| `web/views/layout.erb` | Main layout with sidebar nav |\n| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n| `web/public/css/style.css` | Complete design system |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n\n## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |\n","numLines":232,"startLine":1,"totalLines":232}},"sourceToolAssistantUUID":"90129729-52bf-40e6-b45e-f4f9a4376c6b"}
{"parentUuid":"51a38f38-b2c9-467e-8024-b565e317c53f","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Vj8sDWYmJeTunNxUi3Yh8j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015WvLtb89eJX8cBArg18x3q","name":"Bash","input":{"command":"ls /home/greg/Developer/openfang/fang/tools/*.rb | wc -l && echo \"---\" && ls /home/greg/Developer/openfang/fang/tools/*.rb","description":"Count and list all MCP tools"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5928,"cache_read_input_tokens":18770,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5928},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQF2jQAGKHe6db1hep9","type":"assistant","uuid":"ec2cf951-788a-4013-8f99-adeae62a02c8","timestamp":"2026-02-21T02:10:20.906Z"}
{"parentUuid":"ec2cf951-788a-4013-8f99-adeae62a02c8","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Vj8sDWYmJeTunNxUi3Yh8j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01732Hs8MET4vXsJSvLYtu6Z","name":"Read","input":{"file_path":"/home/greg/Developer/openfang/web/public/css/style.css","limit":80},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5928,"cache_read_input_tokens":18770,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5928},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQF2jQAGKHe6db1hep9","type":"assistant","uuid":"f13fc50e-90d7-4087-92f2-89868f2e170a","timestamp":"2026-02-21T02:10:21.550Z"}
{"parentUuid":"ec2cf951-788a-4013-8f99-adeae62a02c8","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015WvLtb89eJX8cBArg18x3q","type":"tool_result","content":"38\n---\n/home/greg/Developer/openfang/fang/tools/add_canvas_component_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_approval_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_data_table_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_document_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_heartbeat_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_notification_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_page_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_trigger_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_workflow_tool.rb\n/home/greg/Developer/openfang/fang/tools/define_widget_tool.rb\n/home/greg/Developer/openfang/fang/tools/delete_data_record_tool.rb\n/home/greg/Developer/openfang/fang/tools/get_canvas_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_draft_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_labels_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_modify_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_read_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_search_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_send_tool.rb\n/home/greg/Developer/openfang/fang/tools/insert_data_record_tool.rb\n/home/greg/Developer/openfang/fang/tools/list_approvals_tool.rb\n/home/greg/Developer/openfang/fang/tools/list_data_tables_tool.rb\n/home/greg/Developer/openfang/fang/tools/list_documents_tool.rb\n/home/greg/Developer/openfang/fang/tools/list_heartbeats_tool.rb\n/home/greg/Developer/openfang/fang/tools/manage_python_tool.rb\n/home/greg/Developer/openfang/fang/tools/query_data_table_tool.rb\n/home/greg/Developer/openfang/fang/tools/read_document_tool.rb\n/home/greg/Developer/openfang/fang/tools/remove_canvas_component_tool.rb\n/home/greg/Developer/openfang/fang/tools/resolve_approval_tool.rb\n/home/greg/Developer/openfang/fang/tools/run_code_tool.rb\n/home/greg/Developer/openfang/fang/tools/run_skill_tool.rb\n/home/greg/Developer/openfang/fang/tools/schedule_task_tool.rb\n/home/greg/Developer/openfang/fang/tools/send_message_tool.rb\n/home/greg/Developer/openfang/fang/tools/start_computer_use_tool.rb\n/home/greg/Developer/openfang/fang/tools/update_canvas_component_tool.rb\n/home/greg/Developer/openfang/fang/tools/update_canvas_tool.rb\n/home/greg/Developer/openfang/fang/tools/update_data_record_tool.rb\n/home/greg/Developer/openfang/fang/tools/update_heartbeat_tool.rb\n/home/greg/Developer/openfang/fang/tools/web_fetch_tool.rb","is_error":false}]},"uuid":"b24db522-05e7-4184-a856-251f0fb8ee7c","timestamp":"2026-02-21T02:10:31.435Z","toolUseResult":{"stdout":"38\n---\n/home/greg/Developer/openfang/fang/tools/add_canvas_component_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_approval_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_data_table_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_document_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_heartbeat_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_notification_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_page_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_trigger_tool.rb\n/home/greg/Developer/openfang/fang/tools/create_workflow_tool.rb\n/home/greg/Developer/openfang/fang/tools/define_widget_tool.rb\n/home/greg/Developer/openfang/fang/tools/delete_data_record_tool.rb\n/home/greg/Developer/openfang/fang/tools/get_canvas_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_draft_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_labels_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_modify_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_read_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_search_tool.rb\n/home/greg/Developer/openfang/fang/tools/gmail_send_tool.rb\n/home/greg/Developer/openfang/fang/tools/insert_data_record_tool.rb\n/home/greg/Developer/openfang/fang/tools/list_approvals_tool.rb\n/home/greg/Developer/openfang/fang/tools/list_data_tables_tool.rb\n/home/greg/Developer/openfang/fang/tools/list_documents_tool.rb\n/home/greg/Developer/openfang/fang/tools/list_heartbeats_tool.rb\n/home/greg/Developer/openfang/fang/tools/manage_python_tool.rb\n/home/greg/Developer/openfang/fang/tools/query_data_table_tool.rb\n/home/greg/Developer/openfang/fang/tools/read_document_tool.rb\n/home/greg/Developer/openfang/fang/tools/remove_canvas_component_tool.rb\n/home/greg/Developer/openfang/fang/tools/resolve_approval_tool.rb\n/home/greg/Developer/openfang/fang/tools/run_code_tool.rb\n/home/greg/Developer/openfang/fang/tools/run_skill_tool.rb\n/home/greg/Developer/openfang/fang/tools/schedule_task_tool.rb\n/home/greg/Developer/openfang/fang/tools/send_message_tool.rb\n/home/greg/Developer/openfang/fang/tools/start_computer_use_tool.rb\n/home/greg/Developer/openfang/fang/tools/update_canvas_component_tool.rb\n/home/greg/Developer/openfang/fang/tools/update_canvas_tool.rb\n/home/greg/Developer/openfang/fang/tools/update_data_record_tool.rb\n/home/greg/Developer/openfang/fang/tools/update_heartbeat_tool.rb\n/home/greg/Developer/openfang/fang/tools/web_fetch_tool.rb","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"ec2cf951-788a-4013-8f99-adeae62a02c8"}
{"parentUuid":"b24db522-05e7-4184-a856-251f0fb8ee7c","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01732Hs8MET4vXsJSvLYtu6Z","toolUseID":"toolu_01732Hs8MET4vXsJSvLYtu6Z","timestamp":"2026-02-21T02:10:31.444Z","uuid":"6b87731c-e2c4-4148-bbe7-1e7b052148d0"}
{"parentUuid":"f13fc50e-90d7-4087-92f2-89868f2e170a","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01732Hs8MET4vXsJSvLYtu6Z","type":"tool_result","content":"     1→/* ============================================\n     2→   OpenFang — shadcn/ui Design System\n     3→   Clean · Minimal · Terminal Green Accent · Light/Dark\n     4→   ============================================ */\n     5→\n     6→/* --- Design Tokens (Light Mode) --- */\n     7→:root {\n     8→  --background: #c8ccd1;\n     9→  --foreground: #0f172a;\n    10→  --card: #dde0e4;\n    11→  --card-foreground: #0f172a;\n    12→  --muted: #b8bcc2;\n    13→  --muted-foreground: #4a5568;\n    14→  --accent: #e8f5ec;\n    15→  --accent-foreground: #14532d;\n    16→  --primary: #16a34a;\n    17→  --primary-foreground: #ffffff;\n    18→  --border: #a8adb4;\n    19→  --ring: #16a34a;\n    20→  --input: #e8eaee;\n    21→  --destructive: #dc2626;\n    22→  --destructive-foreground: #ffffff;\n    23→\n    24→  /* Shadow scale */\n    25→  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);\n    26→  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);\n    27→  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);\n    28→\n    29→  /* Border radius scale */\n    30→  --radius-sm: 0.25rem;\n    31→  --radius-md: 0.375rem;\n    32→  --radius-lg: 0.5rem;\n    33→\n    34→  /* Backward-compat aliases */\n    35→  --fang-bg: var(--background);\n    36→  --fang-fg: var(--foreground);\n    37→  --fang-muted: var(--muted);\n    38→  --fang-muted-fg: var(--muted-foreground);\n    39→  --fang-accent: var(--primary);\n    40→  --fang-accent-fg: var(--primary-foreground);\n    41→  --fang-border: var(--border);\n    42→  --fang-card: var(--card);\n    43→}\n    44→\n    45→/* --- Dark Mode --- */\n    46→@media (prefers-color-scheme: dark) {\n    47→  :root {\n    48→    --background: #1a1a1e;\n    49→    --foreground: #fafafa;\n    50→    --card: #242428;\n    51→    --card-foreground: #fafafa;\n    52→    --muted: #2e2e33;\n    53→    --muted-foreground: #9a9aaa;\n    54→    --accent: #2e2e33;\n    55→    --accent-foreground: #22c55e;\n    56→    --primary: #16a34a;\n    57→    --primary-foreground: #ffffff;\n    58→    --border: #3a3a40;\n    59→    --ring: #16a34a;\n    60→    --input: var(--background);\n    61→    --destructive: #ef4444;\n    62→    --destructive-foreground: #ffffff;\n    63→\n    64→    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);\n    65→    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);\n    66→    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.3);\n    67→  }\n    68→}\n    69→\n    70→/* --- Element Base Styles --- */\n    71→\n    72→body {\n    73→  background: var(--background);\n    74→  color: var(--foreground);\n    75→  font-family: 'Inter', system-ui, sans-serif;\n    76→  line-height: 1.5;\n    77→}\n    78→\n    79→h1, h2, h3, h4, h5, h6 {\n    80→  font-weight: 600;"}]},"uuid":"9d11035a-4224-4a6d-b750-b2c96bc7919d","timestamp":"2026-02-21T02:10:31.444Z","toolUseResult":{"type":"text","file":{"filePath":"/home/greg/Developer/openfang/web/public/css/style.css","content":"/* ============================================\n   OpenFang — shadcn/ui Design System\n   Clean · Minimal · Terminal Green Accent · Light/Dark\n   ============================================ */\n\n/* --- Design Tokens (Light Mode) --- */\n:root {\n  --background: #c8ccd1;\n  --foreground: #0f172a;\n  --card: #dde0e4;\n  --card-foreground: #0f172a;\n  --muted: #b8bcc2;\n  --muted-foreground: #4a5568;\n  --accent: #e8f5ec;\n  --accent-foreground: #14532d;\n  --primary: #16a34a;\n  --primary-foreground: #ffffff;\n  --border: #a8adb4;\n  --ring: #16a34a;\n  --input: #e8eaee;\n  --destructive: #dc2626;\n  --destructive-foreground: #ffffff;\n\n  /* Shadow scale */\n  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);\n  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);\n  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);\n\n  /* Border radius scale */\n  --radius-sm: 0.25rem;\n  --radius-md: 0.375rem;\n  --radius-lg: 0.5rem;\n\n  /* Backward-compat aliases */\n  --fang-bg: var(--background);\n  --fang-fg: var(--foreground);\n  --fang-muted: var(--muted);\n  --fang-muted-fg: var(--muted-foreground);\n  --fang-accent: var(--primary);\n  --fang-accent-fg: var(--primary-foreground);\n  --fang-border: var(--border);\n  --fang-card: var(--card);\n}\n\n/* --- Dark Mode --- */\n@media (prefers-color-scheme: dark) {\n  :root {\n    --background: #1a1a1e;\n    --foreground: #fafafa;\n    --card: #242428;\n    --card-foreground: #fafafa;\n    --muted: #2e2e33;\n    --muted-foreground: #9a9aaa;\n    --accent: #2e2e33;\n    --accent-foreground: #22c55e;\n    --primary: #16a34a;\n    --primary-foreground: #ffffff;\n    --border: #3a3a40;\n    --ring: #16a34a;\n    --input: var(--background);\n    --destructive: #ef4444;\n    --destructive-foreground: #ffffff;\n\n    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);\n    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);\n    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.3);\n  }\n}\n\n/* --- Element Base Styles --- */\n\nbody {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: 'Inter', system-ui, sans-serif;\n  line-height: 1.5;\n}\n\nh1, h2, h3, h4, h5, h6 {\n  font-weight: 600;","numLines":80,"startLine":1,"totalLines":1602}},"sourceToolAssistantUUID":"f13fc50e-90d7-4087-92f2-89868f2e170a"}
{"parentUuid":"9d11035a-4224-4a6d-b750-b2c96bc7919d","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_0155hJ8d9yo2QXfTcETtXiCX","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good, I have all the info I need. Let me also check for a few files mentioned in the plan to verify they exist.","signature":"EpcCCkYICxgCKkD0t5XupJV2oRuOBYJxjP9i8EeDRUZYCaEkvqmXWqjiM9e9FgANMSOm+q/wYn83WMOKGI11DR5YQdpRzXNLeWpSEgyeoU8GNY72emHZjXUaDPM8vxbh2mN0JNel2SIwrxnjp3YXbIWP5Qqc4U2w60fNKrzllkuyQf9NFrlOfFnTaCslPouIhpz7j5eJQvp1Kn9RQOFWFrvP1a/GzTMQpI2NksrwPJR1M3NN/a3YZY8BPttNnkEdelqdCbnIvlwc9SjJzfSKgyPNm/5Fn8JmB/gMlLSLJ6L2gTcfMJdLheWH8s3PVFhruGr94axV0CsawzFRJYKiw2QQLBTE98ktjYaNP3vqwq5pu1Prd/zSpnsXGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":12434,"cache_read_input_tokens":24698,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":12434},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQG9XxbRDwZrkZUg5P7","type":"assistant","uuid":"a48e8002-4e57-4770-ac84-dc99ec4f3425","timestamp":"2026-02-21T02:10:34.448Z"}
{"parentUuid":"a48e8002-4e57-4770-ac84-dc99ec4f3425","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_0155hJ8d9yo2QXfTcETtXiCX","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me verify the additional files mentioned in the plan exist and check widget types."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":12434,"cache_read_input_tokens":24698,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":12434},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQG9XxbRDwZrkZUg5P7","type":"assistant","uuid":"45342796-9cae-4851-b29a-2a403e944477","timestamp":"2026-02-21T02:10:35.286Z"}
{"parentUuid":"45342796-9cae-4851-b29a-2a403e944477","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_0155hJ8d9yo2QXfTcETtXiCX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GkWXRjea4R5vTEK1Z2djRq","name":"Bash","input":{"command":"ls /home/greg/Developer/openfang/fang/widgets/*.rb 2>/dev/null | xargs -I{} basename {} .rb","description":"List widget types"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":12434,"cache_read_input_tokens":24698,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":12434},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQG9XxbRDwZrkZUg5P7","type":"assistant","uuid":"215d11f0-3147-4e0f-8cab-929078a8b28d","timestamp":"2026-02-21T02:10:36.545Z"}
{"parentUuid":"215d11f0-3147-4e0f-8cab-929078a8b28d","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_0155hJ8d9yo2QXfTcETtXiCX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RoGcWhrUGR7XQWsFtXEooA","name":"Bash","input":{"command":"for f in fang/skill_loader.rb fang/python_runner.rb fang/document_parser.rb fang/gmail.rb fang/whatsapp.rb fang/system_profile.rb fang/computer_use; do test -e \"/home/greg/Developer/openfang/$f\" && echo \"EXISTS: $f\" || echo \"MISSING: $f\"; done","description":"Check existence of files mentioned in plan"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":12434,"cache_read_input_tokens":24698,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":12434},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQG9XxbRDwZrkZUg5P7","type":"assistant","uuid":"9396f53b-c37b-47c7-9b66-8020b740c1f7","timestamp":"2026-02-21T02:10:38.791Z"}
{"parentUuid":"9396f53b-c37b-47c7-9b66-8020b740c1f7","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_0155hJ8d9yo2QXfTcETtXiCX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QM9jRWQFB1DVKWjmgkq6QM","name":"Bash","input":{"command":"ls /home/greg/Developer/openfang/fang/concerns/*.rb 2>/dev/null","description":"List concerns"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":12434,"cache_read_input_tokens":24698,"output_tokens":389,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":12434,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQG9XxbRDwZrkZUg5P7","type":"assistant","uuid":"8912f96b-b665-4002-94c4-39d2cea7cd63","timestamp":"2026-02-21T02:10:39.405Z"}
{"parentUuid":"215d11f0-3147-4e0f-8cab-929078a8b28d","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GkWXRjea4R5vTEK1Z2djRq","type":"tool_result","content":"approval_widget\nbanner_widget\nbase_widget\nchart_widget\nclock_widget\ncomputer_use_widget\ndata_table_widget\nhacker_news_widget\nheartbeat_monitor_widget\nlist_widget\nmetric_widget\nnote_widget\nscheduled_jobs_widget\nsettings_widget\ntable_widget\nweather_widget\nwebsite_widget","is_error":false}]},"uuid":"8c6fadff-872a-45b0-afaf-28b23f05532c","timestamp":"2026-02-21T02:11:04.429Z","toolUseResult":{"stdout":"approval_widget\nbanner_widget\nbase_widget\nchart_widget\nclock_widget\ncomputer_use_widget\ndata_table_widget\nhacker_news_widget\nheartbeat_monitor_widget\nlist_widget\nmetric_widget\nnote_widget\nscheduled_jobs_widget\nsettings_widget\ntable_widget\nweather_widget\nwebsite_widget","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"215d11f0-3147-4e0f-8cab-929078a8b28d"}
{"parentUuid":"9396f53b-c37b-47c7-9b66-8020b740c1f7","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RoGcWhrUGR7XQWsFtXEooA","type":"tool_result","content":"EXISTS: fang/skill_loader.rb\nEXISTS: fang/python_runner.rb\nEXISTS: fang/document_parser.rb\nEXISTS: fang/gmail.rb\nEXISTS: fang/whatsapp.rb\nEXISTS: fang/system_profile.rb\nEXISTS: fang/computer_use","is_error":false}]},"uuid":"023dd6d8-6042-4e94-bca4-97fe4d2e366e","timestamp":"2026-02-21T02:11:05.994Z","toolUseResult":{"stdout":"EXISTS: fang/skill_loader.rb\nEXISTS: fang/python_runner.rb\nEXISTS: fang/document_parser.rb\nEXISTS: fang/gmail.rb\nEXISTS: fang/whatsapp.rb\nEXISTS: fang/system_profile.rb\nEXISTS: fang/computer_use","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"9396f53b-c37b-47c7-9b66-8020b740c1f7"}
{"parentUuid":"8912f96b-b665-4002-94c4-39d2cea7cd63","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QM9jRWQFB1DVKWjmgkq6QM","type":"tool_result","content":"/home/greg/Developer/openfang/fang/concerns/has_json_defaults.rb\n/home/greg/Developer/openfang/fang/concerns/has_status.rb","is_error":false}]},"uuid":"1309a61c-2f9d-4e35-9bc8-36ba77fd45ae","timestamp":"2026-02-21T02:11:06.054Z","toolUseResult":{"stdout":"/home/greg/Developer/openfang/fang/concerns/has_json_defaults.rb\n/home/greg/Developer/openfang/fang/concerns/has_status.rb","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"8912f96b-b665-4002-94c4-39d2cea7cd63"}
{"parentUuid":"1309a61c-2f9d-4e35-9bc8-36ba77fd45ae","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Bvb7WmW8Hv4KunNnSWoRCx","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good, I have all the data I need. Now let me create the task list and start editing both files. I'll work on README.md and CLAUDE.md.\n\nLet me count: 38 tools confirmed. Let me now make all the edits.\n\nFor README.md I need to:\n1. Fix \"18 tools\" → \"38 tools\" in 4 places\n2. Add new feature sections after Workflows\n3. Update MCP Tools table with all 38 tools\n4. Update Workflows step types table (add `approval`)\n5. Update Widgets table (add missing widgets)\n\n\nFor CLAUDE.md I need to update the MCP Tools table with all entries, add the missing events to the Event System, include the `approval` step type, add the `HasJsonDefaults` concern, refresh the Key Files table, update the CSS tokens, and revise the Architecture tree. I'll handle both files with multiple edits.","signature":"Ep4HCkYICxgCKkDBk9BBkMJCcSHB/gAHMxeT85KDCEaNPwMhz/ZY5oC5Q2TWUXYeA+LzWApp5IoFy7JIoBwvzulQTC4LkEv5YYBAEgxW5q3CddHGZFF1fjkaDLe4xZizOogNtC9HByIwCc5p+JMyElGSmrr7QelUF4hOCSaH2X9vJbP0qn/kPYi0UAaVuVS31EjARqnoI0XxKoUGrVSmotQaAzwi1slZ+Kqr/9DQyxwxDOLT3xZXNQ77VtZmcI65ipPY+KyghYh/0nhppKNrwjTAZgt7CB4G1lSc+LJg6+DxSOiTVJS7R+3HfPboUYzJxmgdfpTvwoPtSvg1ZJsxpfrnvOu3P1hfw7mDHltGRMu2G4fi08ZC5P1qSybvAF6XSetSh62oD0Or/B4uhCNmZm/RH59STigvWGrIxauz+gYuTq/wKOn1FrjKYVxl4lPVi8Cnl1zNOVjW7dI67+GbyGhBhEuxC2LwziyKmGAX/uXdCZDVVdH9siJ4AITKtJsUiRXq5CPWANJ3shSXUdYU6xwpx48BiqzrAaWTB/T/4rbVdDNPPMQDQxTsm7hIq9mU9dkvAS/2efeXSKWzYbqNQ329AbMztvQMj2XEvJCqgG3SUSCw9/FPqsOnkSTZe+tVWSLVcNQUJymh0Tz94UzQt5hIdn6/V0SAvLZKK94APTs6/b4uCfKYzJcJxske5eI2KaWimwrTzmicOV6B00uOmdpnvTH4JwyhF5xxPgy8NsJ2Iu8HE/CP4L1N/9TrlMlHmkZjz3i4ZkuoLvBjlPTgVgl8x251/A+JpYD/nJur5MJ5G5rgcCyYgFhPu1qR18wN0EYGuG66KyMpCLPb72evcaRJCWHkXn9PghlIvteHyDPyeQNuUEZHxePeNPU8/kTHQfQoadLwctvvi7q98iJPTMWKQTR9XamYY47t7woPKSCMbNt7JnlsFPG/d+LQX21w3AwURZ9NZ9yF7olPFdsaflND/wkt0FFGghJfZgWGOkaNtgTU1plhgIgHnaxEYN5WUp2IVtZWHHtvjfEOFbwdVekh4eJ7noQzDk6oNmXLMz+7ovBg+/YhZkrqmtIIr6orm4rd5D3WKprrX7eWFGJY0TbnJr3WqQj6Y5pd+/fhMvFKzIindDPvIBGBsMM/NNBufKM49YaT3aCdM8IeqWTSgNA9gcl98Pv/mlg6e3RsfDDE/QbHGrBho2sV1xE22Huw9YxMtb++xbU11p5Eyhpj/CIYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":669,"cache_read_input_tokens":37132,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":669},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQJhswTJEKjwd4VVDm9","type":"assistant","uuid":"36292b98-341e-4bc8-ad16-c4dc82d203ac","timestamp":"2026-02-21T02:11:14.338Z"}
{"parentUuid":"36292b98-341e-4bc8-ad16-c4dc82d203ac","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Bvb7WmW8Hv4KunNnSWoRCx","type":"message","role":"assistant","content":[{"type":"text","text":"I have all the data. 38 tools confirmed, widget types verified, all referenced files exist. Let me make the edits now."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":669,"cache_read_input_tokens":37132,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":669},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQJhswTJEKjwd4VVDm9","type":"assistant","uuid":"2c3961d0-ffa3-4521-80d8-b6376d583e7b","timestamp":"2026-02-21T02:11:14.630Z"}
{"parentUuid":"2c3961d0-ffa3-4521-80d8-b6376d583e7b","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Bvb7WmW8Hv4KunNnSWoRCx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RU5F213qg1rXuV2Vz74eSj","name":"TaskCreate","input":{"subject":"Update README.md with accurate tool counts and new features","description":"Fix 18→38 tool counts, add Documents/Data Tables/Approvals/Gmail/Python sections, update MCP tools table, widgets table, and workflow step types","activeForm":"Updating README.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":669,"cache_read_input_tokens":37132,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":669},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQJhswTJEKjwd4VVDm9","type":"assistant","uuid":"4b0cd80d-b2ae-40a4-af10-bd8df205d77c","timestamp":"2026-02-21T02:11:16.787Z"}
{"parentUuid":"4b0cd80d-b2ae-40a4-af10-bd8df205d77c","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RU5F213qg1rXuV2Vz74eSj","type":"tool_result","content":"Task #1 created successfully: Update README.md with accurate tool counts and new features"}]},"uuid":"28d2c757-9558-471c-a682-1368867caa5c","timestamp":"2026-02-21T02:11:17.329Z","toolUseResult":{"task":{"id":"1","subject":"Update README.md with accurate tool counts and new features"}},"sourceToolAssistantUUID":"4b0cd80d-b2ae-40a4-af10-bd8df205d77c"}
{"parentUuid":"28d2c757-9558-471c-a682-1368867caa5c","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Bvb7WmW8Hv4KunNnSWoRCx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013ocRyUPeGmE39MoHvFurJR","name":"TaskCreate","input":{"subject":"Update CLAUDE.md with complete tool list and missing sections","description":"Replace MCP tools table, update events, workflow steps, concerns, key files, CSS tokens, architecture tree","activeForm":"Updating CLAUDE.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":669,"cache_read_input_tokens":37132,"output_tokens":511,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":669,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQJhswTJEKjwd4VVDm9","type":"assistant","uuid":"88f7b722-91d9-46cd-9b30-1cbf7ff2357b","timestamp":"2026-02-21T02:11:18.214Z"}
{"parentUuid":"88f7b722-91d9-46cd-9b30-1cbf7ff2357b","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013ocRyUPeGmE39MoHvFurJR","type":"tool_result","content":"Task #2 created successfully: Update CLAUDE.md with complete tool list and missing sections"}]},"uuid":"63781019-902b-4b31-9436-4c300827117e","timestamp":"2026-02-21T02:11:18.216Z","toolUseResult":{"task":{"id":"2","subject":"Update CLAUDE.md with complete tool list and missing sections"}},"sourceToolAssistantUUID":"88f7b722-91d9-46cd-9b30-1cbf7ff2357b"}
{"parentUuid":"63781019-902b-4b31-9436-4c300827117e","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01FpSjV8FZFp4uW4528cmA3C","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CGstDKnAgF5vhUCGXitaoC","name":"TaskUpdate","input":{"taskId":"1","status":"in_progress"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":600,"cache_read_input_tokens":37801,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":600},"output_tokens":26,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQKbZxcQPjuoHhXizvx","type":"assistant","uuid":"a6455616-5e1d-4b25-9aa4-3346d547f42c","timestamp":"2026-02-21T02:11:20.671Z"}
{"parentUuid":"a6455616-5e1d-4b25-9aa4-3346d547f42c","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CGstDKnAgF5vhUCGXitaoC","type":"tool_result","content":"Updated task #1 status"}]},"uuid":"ce87f9c3-1b52-4eff-af51-86f6bed2972e","timestamp":"2026-02-21T02:11:20.673Z","toolUseResult":{"success":true,"taskId":"1","updatedFields":["status"],"statusChange":{"from":"pending","to":"in_progress"}},"sourceToolAssistantUUID":"a6455616-5e1d-4b25-9aa4-3346d547f42c"}
{"parentUuid":"ce87f9c3-1b52-4eff-af51-86f6bed2972e","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01QResq4x21nkS8w8u7DiDFb","type":"message","role":"assistant","content":[{"type":"text","text":"Starting with README.md — fixing tool counts first:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":90,"cache_read_input_tokens":38401,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":90},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQKn4jrKcmQ4Y5XDbMN","type":"assistant","uuid":"f8759814-5da7-47c1-a66c-8398d30b3de4","timestamp":"2026-02-21T02:11:23.027Z"}
{"type":"file-history-snapshot","messageId":"5815309b-9490-41cf-b690-16f78620d520","snapshot":{"messageId":"2a16f9a6-b9ac-47c4-b037-39bf0d9bffda","trackedFileBackups":{"README.md":{"backupFileName":"d67d4985e8911acf@v1","version":1,"backupTime":"2026-02-21T02:11:24.277Z"}},"timestamp":"2026-02-21T02:10:15.794Z"},"isSnapshotUpdate":true}
{"parentUuid":"f8759814-5da7-47c1-a66c-8398d30b3de4","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01QResq4x21nkS8w8u7DiDFb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Q5uZ6UbkopMjtXP3rXyet3","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/README.md","old_string":"│  ...18 tools  │","new_string":"│  ...38 tools  │"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":90,"cache_read_input_tokens":38401,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":90},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQKn4jrKcmQ4Y5XDbMN","type":"assistant","uuid":"5815309b-9490-41cf-b690-16f78620d520","timestamp":"2026-02-21T02:11:24.256Z"}
{"parentUuid":"5815309b-9490-41cf-b690-16f78620d520","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Q5uZ6UbkopMjtXP3rXyet3","toolUseID":"toolu_01Q5uZ6UbkopMjtXP3rXyet3","timestamp":"2026-02-21T02:11:24.280Z","uuid":"ee59c481-8773-4ae2-ba33-320a573c8f23"}
{"parentUuid":"5815309b-9490-41cf-b690-16f78620d520","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Q5uZ6UbkopMjtXP3rXyet3","type":"tool_result","content":"The file /home/greg/Developer/openfang/README.md has been updated successfully."}]},"uuid":"35ab09f4-9802-404c-ab1c-87989fc1fee5","timestamp":"2026-02-21T02:11:24.280Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/README.md","oldString":"│  ...18 tools  │","newString":"│  ...38 tools  │","originalFile":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...18 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 18 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 18 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 18 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":19,"oldLines":7,"newStart":19,"newLines":7,"lines":["                                     │  schedule_task│","                                     │  create_page  │","                                     │  web_fetch    │","-                                    │  ...18 tools  │","+                                    │  ...38 tools  │","                                     └──────┬───────┘","                                            │","                                     ┌──────▼───────┐"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"5815309b-9490-41cf-b690-16f78620d520"}
{"parentUuid":"35ab09f4-9802-404c-ab1c-87989fc1fee5","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01QResq4x21nkS8w8u7DiDFb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015rKQHBAvTVGz7cJmDocUoa","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/README.md","old_string":"access to 18 MCP tools","new_string":"access to 38 MCP tools"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":90,"cache_read_input_tokens":38401,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":90},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQKn4jrKcmQ4Y5XDbMN","type":"assistant","uuid":"d0612f89-79af-4d9a-a6b8-6088c4e986f0","timestamp":"2026-02-21T02:11:24.974Z"}
{"parentUuid":"d0612f89-79af-4d9a-a6b8-6088c4e986f0","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_015rKQHBAvTVGz7cJmDocUoa","toolUseID":"toolu_015rKQHBAvTVGz7cJmDocUoa","timestamp":"2026-02-21T02:11:24.982Z","uuid":"f406d5e4-7bbb-4feb-9f67-688278ba0cea"}
{"parentUuid":"d0612f89-79af-4d9a-a6b8-6088c4e986f0","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015rKQHBAvTVGz7cJmDocUoa","type":"tool_result","content":"The file /home/greg/Developer/openfang/README.md has been updated successfully."}]},"uuid":"ee923321-b3f6-4856-88a8-45593eb80d82","timestamp":"2026-02-21T02:11:24.981Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/README.md","oldString":"access to 18 MCP tools","newString":"access to 38 MCP tools","originalFile":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...38 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 18 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 18 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 18 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":36,"oldLines":7,"newStart":36,"newLines":7,"lines":["                                     Real-time UI update"," ```"," ","-When you send a message, OpenFang spawns a `claude` CLI subprocess with access to 18 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.","+When you send a message, OpenFang spawns a `claude` CLI subprocess with access to 38 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events."," "," ---"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d0612f89-79af-4d9a-a6b8-6088c4e986f0"}
{"parentUuid":"ee923321-b3f6-4856-88a8-45593eb80d82","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01QResq4x21nkS8w8u7DiDFb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RapFtf8XtFDft2jVhqdSx1","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/README.md","old_string":"18 tools + 6 resources exposed to Claude","new_string":"38 tools + 6 resources exposed to Claude"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":90,"cache_read_input_tokens":38401,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":90},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQKn4jrKcmQ4Y5XDbMN","type":"assistant","uuid":"3b2a6495-40aa-4841-9873-d5a7e3f8fb54","timestamp":"2026-02-21T02:11:25.999Z"}
{"parentUuid":"3b2a6495-40aa-4841-9873-d5a7e3f8fb54","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01RapFtf8XtFDft2jVhqdSx1","toolUseID":"toolu_01RapFtf8XtFDft2jVhqdSx1","timestamp":"2026-02-21T02:11:26.006Z","uuid":"0855ed51-7297-42b6-9e39-98189f99a6a5"}
{"parentUuid":"3b2a6495-40aa-4841-9873-d5a7e3f8fb54","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RapFtf8XtFDft2jVhqdSx1","type":"tool_result","content":"The file /home/greg/Developer/openfang/README.md has been updated successfully."}]},"uuid":"925ae1b7-2e50-4766-8d35-1fc4efb65d45","timestamp":"2026-02-21T02:11:26.005Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/README.md","oldString":"18 tools + 6 resources exposed to Claude","newString":"38 tools + 6 resources exposed to Claude","originalFile":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...38 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 38 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 18 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 18 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":48,"oldLines":7,"newStart":48,"newLines":7,"lines":[" |---|---|---|"," | Web server | **Roda** + Puma | Lightweight routing, port 3000 |"," | Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |","-| Tool protocol | **FastMCP** (SSE) | 18 tools + 6 resources exposed to Claude |","+| Tool protocol | **FastMCP** (SSE) | 38 tools + 6 resources exposed to Claude |"," | Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |"," | Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |"," | Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"3b2a6495-40aa-4841-9873-d5a7e3f8fb54"}
{"parentUuid":"925ae1b7-2e50-4766-8d35-1fc4efb65d45","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01QResq4x21nkS8w8u7DiDFb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01L16kkHSNXCoLRu7Uq3LVuV","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/README.md","old_string":"through 18 MCP tools and 6 resources","new_string":"through 38 MCP tools and 6 resources"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":90,"cache_read_input_tokens":38401,"output_tokens":447,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":90,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQKn4jrKcmQ4Y5XDbMN","type":"assistant","uuid":"511f1ab2-8fdc-45aa-93af-710a6ddeb52d","timestamp":"2026-02-21T02:11:26.831Z"}
{"parentUuid":"511f1ab2-8fdc-45aa-93af-710a6ddeb52d","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01L16kkHSNXCoLRu7Uq3LVuV","toolUseID":"toolu_01L16kkHSNXCoLRu7Uq3LVuV","timestamp":"2026-02-21T02:11:26.838Z","uuid":"922ce100-be99-470c-930e-a64b5acaf3e1"}
{"parentUuid":"511f1ab2-8fdc-45aa-93af-710a6ddeb52d","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01L16kkHSNXCoLRu7Uq3LVuV","type":"tool_result","content":"The file /home/greg/Developer/openfang/README.md has been updated successfully."}]},"uuid":"8e09c42a-3466-40c1-bd81-611a5f201fb3","timestamp":"2026-02-21T02:11:26.837Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/README.md","oldString":"through 18 MCP tools and 6 resources","newString":"through 38 MCP tools and 6 resources","originalFile":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...38 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 38 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 38 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 18 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":247,"oldLines":7,"newStart":247,"newLines":7,"lines":[" "," ### MCP Tools & Resources"," ","-Claude interacts with OpenFang through 18 MCP tools and 6 resources, served over SSE at `/mcp/sse`.","+Claude interacts with OpenFang through 38 MCP tools and 6 resources, served over SSE at `/mcp/sse`."," "," **Tools** (auto-discovered from `fang/tools/`):"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"511f1ab2-8fdc-45aa-93af-710a6ddeb52d"}
{"parentUuid":"8e09c42a-3466-40c1-bd81-611a5f201fb3","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01NnwPCtWZaVLzQZ5RKshzHr","type":"message","role":"assistant","content":[{"type":"text","text":"Now add the `approval` step type to the Workflows table and add new feature sections after Workflows:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":708,"cache_read_input_tokens":38491,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":708},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQLENHD3VdxViaDeD9H","type":"assistant","uuid":"d7fa63b5-7147-4dc2-a6a9-22f963cb67ae","timestamp":"2026-02-21T02:11:31.448Z"}
{"parentUuid":"d7fa63b5-7147-4dc2-a6a9-22f963cb67ae","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01NnwPCtWZaVLzQZ5RKshzHr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PhKMLEYGXa8bA5XGiEKh5S","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/README.md","old_string":"| `notify` | Creates a notification |","new_string":"| `approval` | Pauses workflow until a human approves or rejects |\n| `notify` | Creates a notification |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":708,"cache_read_input_tokens":38491,"output_tokens":162,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":708,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQLENHD3VdxViaDeD9H","type":"assistant","uuid":"27a6a357-0cbd-4203-a755-780bc8028d91","timestamp":"2026-02-21T02:11:33.068Z"}
{"parentUuid":"27a6a357-0cbd-4203-a755-780bc8028d91","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01PhKMLEYGXa8bA5XGiEKh5S","toolUseID":"toolu_01PhKMLEYGXa8bA5XGiEKh5S","timestamp":"2026-02-21T02:11:33.074Z","uuid":"149eec1c-8413-49e4-8f6a-c8d21ebda8d7"}
{"parentUuid":"27a6a357-0cbd-4203-a755-780bc8028d91","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PhKMLEYGXa8bA5XGiEKh5S","type":"tool_result","content":"The file /home/greg/Developer/openfang/README.md has been updated successfully."}]},"uuid":"648672b8-2707-4912-b52e-1a449ec1dfaf","timestamp":"2026-02-21T02:11:33.074Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/README.md","oldString":"| `notify` | Creates a notification |","newString":"| `approval` | Pauses workflow until a human approves or rejects |\n| `notify` | Creates a notification |","originalFile":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...38 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 38 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 38 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 38 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":231,"oldLines":6,"newStart":231,"newLines":7,"lines":[" | `prompt` | Sends a message to Claude, gets a response |"," | `condition` | Evaluates an expression, optionally skips to a step |"," | `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |","+| `approval` | Pauses workflow until a human approves or rejects |"," | `notify` | Creates a notification |"," "," Steps pass data via a JSON context hash using `{{context.step_name}}` interpolation:"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"27a6a357-0cbd-4203-a755-780bc8028d91"}
{"parentUuid":"648672b8-2707-4912-b52e-1a449ec1dfaf","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_0183hFmSjgh5LLk8bWYSgAmN","type":"message","role":"assistant","content":[{"type":"text","text":"Now add the new feature sections after the Workflows section (before MCP Tools):"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":213,"cache_read_input_tokens":39199,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":213},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQLhCZq9hJPmhwaCCSw","type":"assistant","uuid":"7ed79334-ae7c-4ea8-96dc-f29e2298a957","timestamp":"2026-02-21T02:11:35.315Z"}
{"parentUuid":"7ed79334-ae7c-4ea8-96dc-f29e2298a957","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_0183hFmSjgh5LLk8bWYSgAmN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011uttZF23VwsAp1EcSTLJw6","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/README.md","old_string":"Workflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### MCP Tools & Resources","new_string":"Workflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### Documents — Upload, Parse, and Generate Files\n\nDocuments let you attach files (PDF, CSV, Excel, plain text) to conversations. On upload, `DocumentParser` extracts the text content so the agent can read it without re-parsing. Token-efficient: parse once, read many times.\n\nThe agent can also create documents programmatically — generating reports, exports, or formatted files and attaching them to the conversation for download.\n\n---\n\n### Dynamic Data Tables — AI-Created Structured Storage\n\nThe agent can create real SQLite tables on the fly with custom schemas via `create_data_table`. Once created, full CRUD is available through `insert_data_record`, `update_data_record`, `delete_data_record`, and `query_data_table`.\n\nUse cases: tracking lists, inventories, logs, or any structured data the agent needs to persist and query. Tables are first-class database objects — they support filtering, sorting, and aggregation via SQL.\n\n---\n\n### Approvals — Human-in-the-Loop Gates\n\nApprovals pause automation until a human decides. They work standalone or as workflow steps (`approval` step type). Each approval has a title, description, and optional timeout with auto-expiry.\n\nEvents are emitted on decision: `approval:approved:*`, `approval:rejected:*`, `approval:expired:*` — so downstream triggers and workflows can react.\n\n---\n\n### Gmail Integration\n\nFull OAuth2 Gmail integration with 6 dedicated tools: `gmail_search`, `gmail_read`, `gmail_send`, `gmail_draft`, `gmail_modify`, and `gmail_labels`. The agent can search your inbox, read messages, compose and send emails, manage drafts, and modify labels.\n\n---\n\n### Python Support\n\nRun Python code alongside Ruby via `manage_python`. Includes virtualenv management for dependency isolation. Python skills are auto-discovered from `skills/` alongside Ruby skills.\n\n---\n\n### MCP Tools & Resources"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":213,"cache_read_input_tokens":39199,"output_tokens":614,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":213,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQLhCZq9hJPmhwaCCSw","type":"assistant","uuid":"b18e30fc-e3ce-455e-bc04-761cd04b3140","timestamp":"2026-02-21T02:11:48.751Z"}
{"parentUuid":"b18e30fc-e3ce-455e-bc04-761cd04b3140","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_011uttZF23VwsAp1EcSTLJw6","toolUseID":"toolu_011uttZF23VwsAp1EcSTLJw6","timestamp":"2026-02-21T02:11:49.263Z","uuid":"dcb54549-4ba4-4806-8950-54ef490310e7"}
{"parentUuid":"b18e30fc-e3ce-455e-bc04-761cd04b3140","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011uttZF23VwsAp1EcSTLJw6","type":"tool_result","content":"The file /home/greg/Developer/openfang/README.md has been updated successfully."}]},"uuid":"6cbda8dd-2da8-4694-aa21-65a344b96df3","timestamp":"2026-02-21T02:11:49.261Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/README.md","oldString":"Workflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### MCP Tools & Resources","newString":"Workflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### Documents — Upload, Parse, and Generate Files\n\nDocuments let you attach files (PDF, CSV, Excel, plain text) to conversations. On upload, `DocumentParser` extracts the text content so the agent can read it without re-parsing. Token-efficient: parse once, read many times.\n\nThe agent can also create documents programmatically — generating reports, exports, or formatted files and attaching them to the conversation for download.\n\n---\n\n### Dynamic Data Tables — AI-Created Structured Storage\n\nThe agent can create real SQLite tables on the fly with custom schemas via `create_data_table`. Once created, full CRUD is available through `insert_data_record`, `update_data_record`, `delete_data_record`, and `query_data_table`.\n\nUse cases: tracking lists, inventories, logs, or any structured data the agent needs to persist and query. Tables are first-class database objects — they support filtering, sorting, and aggregation via SQL.\n\n---\n\n### Approvals — Human-in-the-Loop Gates\n\nApprovals pause automation until a human decides. They work standalone or as workflow steps (`approval` step type). Each approval has a title, description, and optional timeout with auto-expiry.\n\nEvents are emitted on decision: `approval:approved:*`, `approval:rejected:*`, `approval:expired:*` — so downstream triggers and workflows can react.\n\n---\n\n### Gmail Integration\n\nFull OAuth2 Gmail integration with 6 dedicated tools: `gmail_search`, `gmail_read`, `gmail_send`, `gmail_draft`, `gmail_modify`, and `gmail_labels`. The agent can search your inbox, read messages, compose and send emails, manage drafts, and modify labels.\n\n---\n\n### Python Support\n\nRun Python code alongside Ruby via `manage_python`. Includes virtualenv management for dependency isolation. Python skills are auto-discovered from `skills/` alongside Ruby skills.\n\n---\n\n### MCP Tools & Resources","originalFile":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...38 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 38 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 38 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `approval` | Pauses workflow until a human approves or rejects |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 38 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":246,"oldLines":6,"newStart":246,"newLines":42,"lines":[" "," ---"," ","+### Documents — Upload, Parse, and Generate Files","+","+Documents let you attach files (PDF, CSV, Excel, plain text) to conversations. On upload, `DocumentParser` extracts the text content so the agent can read it without re-parsing. Token-efficient: parse once, read many times.","+","+The agent can also create documents programmatically — generating reports, exports, or formatted files and attaching them to the conversation for download.","+","+---","+","+### Dynamic Data Tables — AI-Created Structured Storage","+","+The agent can create real SQLite tables on the fly with custom schemas via `create_data_table`. Once created, full CRUD is available through `insert_data_record`, `update_data_record`, `delete_data_record`, and `query_data_table`.","+","+Use cases: tracking lists, inventories, logs, or any structured data the agent needs to persist and query. Tables are first-class database objects — they support filtering, sorting, and aggregation via SQL.","+","+---","+","+### Approvals — Human-in-the-Loop Gates","+","+Approvals pause automation until a human decides. They work standalone or as workflow steps (`approval` step type). Each approval has a title, description, and optional timeout with auto-expiry.","+","+Events are emitted on decision: `approval:approved:*`, `approval:rejected:*`, `approval:expired:*` — so downstream triggers and workflows can react.","+","+---","+","+### Gmail Integration","+","+Full OAuth2 Gmail integration with 6 dedicated tools: `gmail_search`, `gmail_read`, `gmail_send`, `gmail_draft`, `gmail_modify`, and `gmail_labels`. The agent can search your inbox, read messages, compose and send emails, manage drafts, and modify labels.","+","+---","+","+### Python Support","+","+Run Python code alongside Ruby via `manage_python`. Includes virtualenv management for dependency isolation. Python skills are auto-discovered from `skills/` alongside Ruby skills.","+","+---","+"," ### MCP Tools & Resources"," "," Claude interacts with OpenFang through 38 MCP tools and 6 resources, served over SSE at `/mcp/sse`."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"b18e30fc-e3ce-455e-bc04-761cd04b3140"}
{"parentUuid":"6cbda8dd-2da8-4694-aa21-65a344b96df3","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01UwAJyXu7F44qXKNRcZPLiL","type":"message","role":"assistant","content":[{"type":"text","text":"Now update the MCP Tools table with all 38 tools:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":646,"cache_read_input_tokens":39412,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":646},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQMtNZL3EpvwwDnwJ3B","type":"assistant","uuid":"0313c6d1-8dad-4fc0-b0c6-71d41b36fc1f","timestamp":"2026-02-21T02:11:51.803Z"}
{"parentUuid":"0313c6d1-8dad-4fc0-b0c6-71d41b36fc1f","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01UwAJyXu7F44qXKNRcZPLiL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AiVc9YCUgmSmVbK7HMqKfZ","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/README.md","old_string":"| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |","new_string":"| Tool | Purpose |\n|---|---|\n| **Core** | |\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `manage_python` | Run Python code, manage virtualenv and dependencies |\n| `send_message` | Send a message to the conversation |\n| **Scheduling** | |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| **Pages & Canvas** | |\n| `create_page` | Create a new canvas page |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n| **Documents** | |\n| `create_document` | Upload or generate a document |\n| `read_document` | Read extracted text from a document |\n| `list_documents` | List documents in a conversation |\n| **Data Tables** | |\n| `create_data_table` | Create a dynamic SQLite table with custom schema |\n| `list_data_tables` | List all dynamic data tables |\n| `query_data_table` | Query records with filtering and sorting |\n| `insert_data_record` | Insert a row into a data table |\n| `update_data_record` | Update a row in a data table |\n| `delete_data_record` | Delete a row from a data table |\n| **Approvals** | |\n| `create_approval` | Create a human-in-the-loop approval gate |\n| `list_approvals` | List pending and resolved approvals |\n| `resolve_approval` | Approve or reject a pending approval |\n| **Automation** | |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| **Web** | |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `start_computer_use` | Launch a browser automation session |\n| **Gmail** | |\n| `gmail_search` | Search Gmail messages |\n| `gmail_read` | Read a Gmail message by ID |\n| `gmail_send` | Send an email via Gmail |\n| `gmail_draft` | Create a Gmail draft |\n| `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |\n| `gmail_labels` | List available Gmail labels |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":646,"cache_read_input_tokens":39412,"output_tokens":1148,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":646,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQMtNZL3EpvwwDnwJ3B","type":"assistant","uuid":"318a115d-adb7-4d56-962f-4fe7e0841eb7","timestamp":"2026-02-21T02:12:06.155Z"}
{"parentUuid":"318a115d-adb7-4d56-962f-4fe7e0841eb7","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01AiVc9YCUgmSmVbK7HMqKfZ","toolUseID":"toolu_01AiVc9YCUgmSmVbK7HMqKfZ","timestamp":"2026-02-21T02:12:06.179Z","uuid":"7c2619b3-5567-461b-8d67-8d16ed68ef55"}
{"parentUuid":"318a115d-adb7-4d56-962f-4fe7e0841eb7","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AiVc9YCUgmSmVbK7HMqKfZ","type":"tool_result","content":"The file /home/greg/Developer/openfang/README.md has been updated successfully."}]},"uuid":"2e2df09b-f2f3-44ea-8914-240deb867ca7","timestamp":"2026-02-21T02:12:06.178Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/README.md","oldString":"| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |","newString":"| Tool | Purpose |\n|---|---|\n| **Core** | |\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `manage_python` | Run Python code, manage virtualenv and dependencies |\n| `send_message` | Send a message to the conversation |\n| **Scheduling** | |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| **Pages & Canvas** | |\n| `create_page` | Create a new canvas page |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n| **Documents** | |\n| `create_document` | Upload or generate a document |\n| `read_document` | Read extracted text from a document |\n| `list_documents` | List documents in a conversation |\n| **Data Tables** | |\n| `create_data_table` | Create a dynamic SQLite table with custom schema |\n| `list_data_tables` | List all dynamic data tables |\n| `query_data_table` | Query records with filtering and sorting |\n| `insert_data_record` | Insert a row into a data table |\n| `update_data_record` | Update a row in a data table |\n| `delete_data_record` | Delete a row from a data table |\n| **Approvals** | |\n| `create_approval` | Create a human-in-the-loop approval gate |\n| `list_approvals` | List pending and resolved approvals |\n| `resolve_approval` | Approve or reject a pending approval |\n| **Automation** | |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| **Web** | |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `start_computer_use` | Launch a browser automation session |\n| **Gmail** | |\n| `gmail_search` | Search Gmail messages |\n| `gmail_read` | Read a Gmail message by ID |\n| `gmail_send` | Send an email via Gmail |\n| `gmail_draft` | Create a Gmail draft |\n| `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |\n| `gmail_labels` | List available Gmail labels |","originalFile":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...38 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 38 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 38 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `approval` | Pauses workflow until a human approves or rejects |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### Documents — Upload, Parse, and Generate Files\n\nDocuments let you attach files (PDF, CSV, Excel, plain text) to conversations. On upload, `DocumentParser` extracts the text content so the agent can read it without re-parsing. Token-efficient: parse once, read many times.\n\nThe agent can also create documents programmatically — generating reports, exports, or formatted files and attaching them to the conversation for download.\n\n---\n\n### Dynamic Data Tables — AI-Created Structured Storage\n\nThe agent can create real SQLite tables on the fly with custom schemas via `create_data_table`. Once created, full CRUD is available through `insert_data_record`, `update_data_record`, `delete_data_record`, and `query_data_table`.\n\nUse cases: tracking lists, inventories, logs, or any structured data the agent needs to persist and query. Tables are first-class database objects — they support filtering, sorting, and aggregation via SQL.\n\n---\n\n### Approvals — Human-in-the-Loop Gates\n\nApprovals pause automation until a human decides. They work standalone or as workflow steps (`approval` step type). Each approval has a title, description, and optional timeout with auto-expiry.\n\nEvents are emitted on decision: `approval:approved:*`, `approval:rejected:*`, `approval:expired:*` — so downstream triggers and workflows can react.\n\n---\n\n### Gmail Integration\n\nFull OAuth2 Gmail integration with 6 dedicated tools: `gmail_search`, `gmail_read`, `gmail_send`, `gmail_draft`, `gmail_modify`, and `gmail_labels`. The agent can search your inbox, read messages, compose and send emails, manage drafts, and modify labels.\n\n---\n\n### Python Support\n\nRun Python code alongside Ruby via `manage_python`. Includes virtualenv management for dependency isolation. Python skills are auto-discovered from `skills/` alongside Ruby skills.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 38 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `send_message` | Send a message to the conversation |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| `create_page` | Create a new canvas page |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":290,"oldLines":24,"newStart":290,"newLines":53,"lines":[" "," | Tool | Purpose |"," |---|---|","+| **Core** | |"," | `run_code` | Execute arbitrary Ruby with full model access |"," | `run_skill` | Execute a saved skill by name |","+| `manage_python` | Run Python code, manage virtualenv and dependencies |"," | `send_message` | Send a message to the conversation |","+| **Scheduling** | |"," | `schedule_task` | Schedule a one-shot or recurring task |","+| **Pages & Canvas** | |"," | `create_page` | Create a new canvas page |","+| `get_canvas` | Read current page's widget layout |","+| `update_canvas` | Set page HTML content |","+| `add_canvas_component` | Add a widget to the canvas |","+| `update_canvas_component` | Modify a widget's position/content/data |","+| `remove_canvas_component` | Remove a widget |","+| `define_widget` | Create a new widget type (writes Ruby to disk) |","+| **Documents** | |","+| `create_document` | Upload or generate a document |","+| `read_document` | Read extracted text from a document |","+| `list_documents` | List documents in a conversation |","+| **Data Tables** | |","+| `create_data_table` | Create a dynamic SQLite table with custom schema |","+| `list_data_tables` | List all dynamic data tables |","+| `query_data_table` | Query records with filtering and sorting |","+| `insert_data_record` | Insert a row into a data table |","+| `update_data_record` | Update a row in a data table |","+| `delete_data_record` | Delete a row from a data table |","+| **Approvals** | |","+| `create_approval` | Create a human-in-the-loop approval gate |","+| `list_approvals` | List pending and resolved approvals |","+| `resolve_approval` | Approve or reject a pending approval |","+| **Automation** | |"," | `create_notification` | Push a real-time notification |"," | `create_trigger` | Set up an event-driven trigger |"," | `create_workflow` | Build a multi-step automation pipeline |"," | `create_heartbeat` | Set up a token-efficient monitor |"," | `update_heartbeat` | Modify a heartbeat's config |"," | `list_heartbeats` | View all heartbeats and their stats |","+| **Web** | |"," | `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |","-| `get_canvas` | Read current page's widget layout |","-| `update_canvas` | Set page HTML content |","-| `add_canvas_component` | Add a widget to the canvas |","-| `update_canvas_component` | Modify a widget's position/content/data |","-| `remove_canvas_component` | Remove a widget |","-| `define_widget` | Create a new widget type (writes Ruby to disk) |","+| `start_computer_use` | Launch a browser automation session |","+| **Gmail** | |","+| `gmail_search` | Search Gmail messages |","+| `gmail_read` | Read a Gmail message by ID |","+| `gmail_send` | Send an email via Gmail |","+| `gmail_draft` | Create a Gmail draft |","+| `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |","+| `gmail_labels` | List available Gmail labels |"," "," **Resources** (context the agent can read):"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"318a115d-adb7-4d56-962f-4fe7e0841eb7"}
{"parentUuid":"2e2df09b-f2f3-44ea-8914-240deb867ca7","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01LFmkt299sNksWSkHpS3rok","type":"message","role":"assistant","content":[{"type":"text","text":"Now update the Widgets table to add missing widgets:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1337,"cache_read_input_tokens":40058,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1337},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQP8g4H1yUmdqtrbCgi","type":"assistant","uuid":"4eefbf3e-cf2d-4b15-9d5a-179fc61f6bab","timestamp":"2026-02-21T02:12:08.493Z"}
{"parentUuid":"4eefbf3e-cf2d-4b15-9d5a-179fc61f6bab","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01LFmkt299sNksWSkHpS3rok","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015EFaaj1Ai87dLCPTuymdnD","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/README.md","old_string":"| `list` | Items with optional links, auto-refresh from data source |","new_string":"| `list` | Items with optional links, auto-refresh from data source |\n| `data_table` | Dynamic data table with full CRUD, backed by AI-created schemas |\n| `approval` | Pending approval display with approve/reject actions |\n| `computer_use` | Browser automation session viewer |\n| `scheduled_jobs` | Upcoming and recent scheduled task overview |\n| `settings` | Configuration key/value editor |\n| `website` | Embedded website iframe |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1337,"cache_read_input_tokens":40058,"output_tokens":258,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":1337,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQP8g4H1yUmdqtrbCgi","type":"assistant","uuid":"460c75be-4b2f-4329-8196-745d00dd6939","timestamp":"2026-02-21T02:12:12.593Z"}
{"parentUuid":"460c75be-4b2f-4329-8196-745d00dd6939","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_015EFaaj1Ai87dLCPTuymdnD","toolUseID":"toolu_015EFaaj1Ai87dLCPTuymdnD","timestamp":"2026-02-21T02:12:12.600Z","uuid":"28222052-f2fd-41a2-a705-687e69ea4acc"}
{"parentUuid":"460c75be-4b2f-4329-8196-745d00dd6939","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015EFaaj1Ai87dLCPTuymdnD","type":"tool_result","content":"The file /home/greg/Developer/openfang/README.md has been updated successfully."}]},"uuid":"242957da-a822-4faf-87c0-81af381f5a5f","timestamp":"2026-02-21T02:12:12.599Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/README.md","oldString":"| `list` | Items with optional links, auto-refresh from data source |","newString":"| `list` | Items with optional links, auto-refresh from data source |\n| `data_table` | Dynamic data table with full CRUD, backed by AI-created schemas |\n| `approval` | Pending approval display with approve/reject actions |\n| `computer_use` | Browser automation session viewer |\n| `scheduled_jobs` | Upcoming and recent scheduled task overview |\n| `settings` | Configuration key/value editor |\n| `website` | Embedded website iframe |","originalFile":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...38 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 38 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 38 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `approval` | Pauses workflow until a human approves or rejects |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### Documents — Upload, Parse, and Generate Files\n\nDocuments let you attach files (PDF, CSV, Excel, plain text) to conversations. On upload, `DocumentParser` extracts the text content so the agent can read it without re-parsing. Token-efficient: parse once, read many times.\n\nThe agent can also create documents programmatically — generating reports, exports, or formatted files and attaching them to the conversation for download.\n\n---\n\n### Dynamic Data Tables — AI-Created Structured Storage\n\nThe agent can create real SQLite tables on the fly with custom schemas via `create_data_table`. Once created, full CRUD is available through `insert_data_record`, `update_data_record`, `delete_data_record`, and `query_data_table`.\n\nUse cases: tracking lists, inventories, logs, or any structured data the agent needs to persist and query. Tables are first-class database objects — they support filtering, sorting, and aggregation via SQL.\n\n---\n\n### Approvals — Human-in-the-Loop Gates\n\nApprovals pause automation until a human decides. They work standalone or as workflow steps (`approval` step type). Each approval has a title, description, and optional timeout with auto-expiry.\n\nEvents are emitted on decision: `approval:approved:*`, `approval:rejected:*`, `approval:expired:*` — so downstream triggers and workflows can react.\n\n---\n\n### Gmail Integration\n\nFull OAuth2 Gmail integration with 6 dedicated tools: `gmail_search`, `gmail_read`, `gmail_send`, `gmail_draft`, `gmail_modify`, and `gmail_labels`. The agent can search your inbox, read messages, compose and send emails, manage drafts, and modify labels.\n\n---\n\n### Python Support\n\nRun Python code alongside Ruby via `manage_python`. Includes virtualenv management for dependency isolation. Python skills are auto-discovered from `skills/` alongside Ruby skills.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 38 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| **Core** | |\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `manage_python` | Run Python code, manage virtualenv and dependencies |\n| `send_message` | Send a message to the conversation |\n| **Scheduling** | |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| **Pages & Canvas** | |\n| `create_page` | Create a new canvas page |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n| **Documents** | |\n| `create_document` | Upload or generate a document |\n| `read_document` | Read extracted text from a document |\n| `list_documents` | List documents in a conversation |\n| **Data Tables** | |\n| `create_data_table` | Create a dynamic SQLite table with custom schema |\n| `list_data_tables` | List all dynamic data tables |\n| `query_data_table` | Query records with filtering and sorting |\n| `insert_data_record` | Insert a row into a data table |\n| `update_data_record` | Update a row in a data table |\n| `delete_data_record` | Delete a row from a data table |\n| **Approvals** | |\n| `create_approval` | Create a human-in-the-loop approval gate |\n| `list_approvals` | List pending and resolved approvals |\n| `resolve_approval` | Approve or reject a pending approval |\n| **Automation** | |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| **Web** | |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `start_computer_use` | Launch a browser automation session |\n| **Gmail** | |\n| `gmail_search` | Search Gmail messages |\n| `gmail_read` | Read a Gmail message by ID |\n| `gmail_send` | Send an email via Gmail |\n| `gmail_draft` | Create a Gmail draft |\n| `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |\n| `gmail_labels` | List available Gmail labels |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":106,"oldLines":6,"newStart":106,"newLines":12,"lines":[" | `note` | Editable markdown |"," | `banner` | Colored alert bar |"," | `list` | Items with optional links, auto-refresh from data source |","+| `data_table` | Dynamic data table with full CRUD, backed by AI-created schemas |","+| `approval` | Pending approval display with approve/reject actions |","+| `computer_use` | Browser automation session viewer |","+| `scheduled_jobs` | Upcoming and recent scheduled task overview |","+| `settings` | Configuration key/value editor |","+| `website` | Embedded website iframe |"," "," Claude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart."," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"460c75be-4b2f-4329-8196-745d00dd6939"}
{"parentUuid":"242957da-a822-4faf-87c0-81af381f5a5f","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01KoWu2zyWdZcVT7jCJsP3ej","type":"message","role":"assistant","content":[{"type":"text","text":"Now add the project structure entries for new directories/files:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":290,"cache_read_input_tokens":41395,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":290},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQPc6KVE1jvRkBQUh4m","type":"assistant","uuid":"415322b7-8c89-4e34-aa92-e1da7a219336","timestamp":"2026-02-21T02:12:14.843Z"}
{"parentUuid":"415322b7-8c89-4e34-aa92-e1da7a219336","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01KoWu2zyWdZcVT7jCJsP3ej","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BBH9Se5T5qcMK7gWpaKNsc","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/README.md","old_string":"├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior","new_string":"├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n├── concerns/               # Shared model behavior\n├── clients/                # API client integrations\n├── computer_use/           # Browser automation (Playwright)\n├── document_parser.rb      # Multi-format text extraction\n├── python_runner.rb        # Python virtualenv and execution\n├── gmail.rb                # Gmail OAuth2 integration\n└── system_profile.rb       # Host system capability detection"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":290,"cache_read_input_tokens":41395,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":290},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQPc6KVE1jvRkBQUh4m","type":"assistant","uuid":"475282f2-6d26-4b40-9c7a-2ccdfde40efb","timestamp":"2026-02-21T02:12:18.440Z"}
{"parentUuid":"475282f2-6d26-4b40-9c7a-2ccdfde40efb","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01BBH9Se5T5qcMK7gWpaKNsc","toolUseID":"toolu_01BBH9Se5T5qcMK7gWpaKNsc","timestamp":"2026-02-21T02:12:18.447Z","uuid":"8efb4c8a-a462-4e3d-a931-32cddd05b063"}
{"parentUuid":"475282f2-6d26-4b40-9c7a-2ccdfde40efb","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BBH9Se5T5qcMK7gWpaKNsc","type":"tool_result","content":"The file /home/greg/Developer/openfang/README.md has been updated successfully."}]},"uuid":"df41c636-8bd6-4097-bb4c-c0029dbd116f","timestamp":"2026-02-21T02:12:18.447Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/README.md","oldString":"├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior","newString":"├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n├── concerns/               # Shared model behavior\n├── clients/                # API client integrations\n├── computer_use/           # Browser automation (Playwright)\n├── document_parser.rb      # Multi-format text extraction\n├── python_runner.rb        # Python virtualenv and execution\n├── gmail.rb                # Gmail OAuth2 integration\n└── system_profile.rb       # Host system capability detection","originalFile":"# OpenFang\n\nA personal AI assistant framework built in Ruby. One process, zero infrastructure. Claude thinks, Ruby acts.\n\nOpenFang wraps the Claude Code CLI as an agent runtime and gives it a full toolkit: scheduled tasks, heartbeat monitors, event-driven workflows, persistent canvas pages, and an extensible skill system — all served through a real-time web UI.\n\n---\n\n## How It Works\n\n```\nYou ──► Web UI ──► Conversation ──► Claude CLI subprocess\n                                         │\n                                         ▼\n                                    MCP Tool Server\n                                    ┌──────────────┐\n                                    │  run_code     │\n                                    │  run_skill    │\n                                    │  schedule_task│\n                                    │  create_page  │\n                                    │  web_fetch    │\n                                    │  ...38 tools  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  ActiveRecord │\n                                    │  SQLite / PG  │\n                                    └──────┬───────┘\n                                           │\n                                    ┌──────▼───────┐\n                                    │  SSE / Turbo  │\n                                    │  Streams      │\n                                    └──────┬───────┘\n                                           │\n                                           ▼\n                                    Real-time UI update\n```\n\nWhen you send a message, OpenFang spawns a `claude` CLI subprocess with access to 38 MCP tools. Claude can execute Ruby code, create pages, schedule tasks, build widgets, define skills, set up monitors — and every action streams back to your browser in real time via Server-Sent Events.\n\n---\n\n## Architecture\n\nEverything runs in a single Puma process. No Redis. No Sidekiq. No ActionCable.\n\n| Layer | Technology | Purpose |\n|---|---|---|\n| Web server | **Roda** + Puma | Lightweight routing, port 3000 |\n| Agent runtime | **Claude CLI** subprocess | One subprocess per conversation |\n| Tool protocol | **FastMCP** (SSE) | 38 tools + 6 resources exposed to Claude |\n| Database | **ActiveRecord 8** + SQLite | Models, migrations, the usual |\n| Background jobs | **ActiveJob** `:async` adapter | In-memory thread pool, no external deps |\n| Scheduler | **Rufus-Scheduler** | Polls for due tasks every 60s, heartbeats every 30s |\n| Real-time | **In-memory pub/sub** → SSE | Turbo Streams pushed to the browser |\n| Templates | **ERB** + Tailwind CDN | shadcn/ui-inspired design system |\n\n### Project Structure\n\n```\nopenfang.rb                 # CLI entrypoint (Thor)\nfang/\n├── agent.rb                # Spawns claude CLI, streams NDJSON\n├── bootstrap.rb            # Loads everything, connects DB\n├── mcp_server.rb           # Auto-discovers tools & resources\n├── scheduler.rb            # Rufus recurring jobs\n├── event_bus.rb            # In-process pub/sub\n├── skill_loader.rb         # Loads skills from skills/\n├── models/                 # ActiveRecord models\n├── tools/                  # MCP tools (auto-registered)\n├── resources/              # MCP resources (auto-registered)\n├── widgets/                # Canvas widget types\n├── jobs/                   # ActiveJob classes\n└── concerns/               # Shared model behavior\nweb/\n├── app.rb                  # All Roda routes\n├── views/                  # ERB templates\n├── turbo_broadcast.rb      # In-memory pub/sub → SSE\n└── public/                 # Static assets, CSS, JS\nskills/                     # Ruby skill files (auto-loaded)\nworkspace/\n├── CLAUDE.md               # System prompt for the inner agent\n├── .mcp.json               # MCP server config for subprocess\n└── migrations/             # Database migrations\n```\n\n---\n\n## Features\n\n### Canvas Pages — Persistent, Widget-Based Dashboards\n\nEvery page in OpenFang is an infinite canvas. Claude creates pages with positioned widget components that persist across sessions. Pages auto-appear in the sidebar navigation.\n\nWidgets are self-rendering Ruby classes. Built-in types include:\n\n| Widget | What It Does |\n|---|---|\n| `metric` | Big number with trend indicator, auto-refreshes from data source |\n| `chart` | Chart.js powered (bar, line, pie, doughnut) |\n| `data_table` | Paginated, sortable, filterable table backed by any ActiveRecord model |\n| `heartbeat_monitor` | Live status grid of all heartbeat monitors |\n| `weather` | Current conditions via Open-Meteo API |\n| `hacker_news` | Top stories from HN |\n| `clock` | Live clock with configurable timezone |\n| `note` | Editable markdown |\n| `banner` | Colored alert bar |\n| `list` | Items with optional links, auto-refresh from data source |\n| `data_table` | Dynamic data table with full CRUD, backed by AI-created schemas |\n| `approval` | Pending approval display with approve/reject actions |\n| `computer_use` | Browser automation session viewer |\n| `scheduled_jobs` | Upcoming and recent scheduled task overview |\n| `settings` | Configuration key/value editor |\n| `website` | Embedded website iframe |\n\nClaude can also **define entirely new widget types at runtime** using the `define_widget` tool — writing the Ruby class to disk and hot-loading it without a restart.\n\nWidgets that declare themselves `refreshable?` are auto-updated every 5 minutes by `WidgetRefreshJob`.\n\n---\n\n### Skills — Reusable Ruby Code That Saves Tokens\n\nSkills are the core mechanism for **not wasting tokens on repeated work**. Instead of Claude regenerating the same logic each time, it writes a skill once:\n\n```ruby\nclass WeatherCheck < Fang::Skill\n  description \"Check weather for a city\"\n  param :city, :string, required: true\n\n  def call(city:)\n    response = HTTParty.get(\"https://api.open-meteo.com/v1/forecast?...\")\n    { temperature: response[\"current\"][\"temperature_2m\"] }\n  end\nend\n```\n\nAfter that, `run_skill weather_check city: \"Portland\"` executes in pure Ruby — no AI tokens spent. Skills have full access to all models and built-in helpers like `send_message`, `schedule_task`, and `run_query`.\n\nThe `run_code` tool lets Claude execute arbitrary Ruby with access to every ActiveRecord model. When a pattern emerges, it promotes one-off code into a named skill.\n\n**Skills are auto-discovered** — drop a `.rb` file in `skills/` and it's available immediately.\n\n---\n\n### Scheduling — Cron, One-Shot, and Relative Times\n\nThe `schedule_task` tool handles any time-based request:\n\n```\n\"Remind me in 2 hours\"          → relative time parsing\n\"Run deploy check tomorrow\"     → natural date parsing\n\"Every weekday at 9am\"          → cron: \"0 9 * * 1-5\"\n```\n\nScheduled tasks can either:\n- **Run a skill** directly (zero tokens — pure Ruby execution)\n- **Send a prompt** to the agent (creates a conversation, invokes Claude)\n\nRecurring tasks use cron expressions (parsed by Fugit) and automatically schedule their next run after completion.\n\nThe scheduler polls every 60 seconds via Rufus-Scheduler. Completed and failed tasks emit events on the EventBus, enabling downstream automation.\n\n---\n\n### Heartbeats — Token-Efficient Monitoring\n\nHeartbeats are the most token-efficient pattern in OpenFang. They solve the problem of \"I want Claude to watch something, but I don't want to pay for constant AI polling.\"\n\n**How it works:**\n\n```\n┌─────────────────────────────────────────────────────┐\n│  Every 30 seconds, the scheduler checks due beats   │\n└──────────────────────┬──────────────────────────────┘\n                       │\n                       ▼\n┌──────────────────────────────────────────────────────┐\n│  Phase 1: Run skill in pure Ruby (ZERO tokens)       │\n│  e.g., check disk space, query an API, count errors  │\n└──────────────────────┬───────────────────────────────┘\n                       │\n              Is result meaningful?\n              (not nil, not empty, not false)\n                       │\n            ┌──────────┴──────────┐\n            │                     │\n         NO ▼                  YES ▼\n    ┌───────────┐        ┌─────────────────┐\n    │  Skip.    │        │  NOW invoke the  │\n    │  Log it.  │        │  agent with the  │\n    │  Move on. │        │  result data.    │\n    │  (free)   │        │  (tokens spent)  │\n    └───────────┘        └─────────────────┘\n```\n\nA heartbeat that checks disk space every 5 minutes will run the skill 288 times per day. If the disk is fine, that's 288 free checks. The moment it crosses a threshold, *then* Claude gets involved to analyze and respond.\n\nThe `heartbeat_monitor` widget shows a live dashboard with run history sparkbars and a visible \"skipped (tokens saved)\" counter.\n\nEach heartbeat has a `prompt_template` with interpolation:\n\n```\n\"Disk usage on {{name}} returned: {{result}}. Analyze and take action if needed.\"\n```\n\n---\n\n### Events, Triggers, and Workflows\n\n**EventBus** is an in-process pub/sub that ties the system together:\n\n```ruby\nEventBus.emit(\"task:completed:deploy\", { task_id: 5 })\n```\n\nEvents are emitted automatically by:\n- Scheduled task completion/failure → `task:completed:*` / `task:failed:*`\n- Heartbeat escalation/error → `heartbeat:escalated:*` / `heartbeat:error:*`\n- Notification creation → `notification:created:*`\n- Workflow completion → `workflow:completed:*`\n\n**Triggers** listen for events via glob patterns and fire actions:\n\n```\nPattern: \"heartbeat:error:*\"  →  Action: run skill \"alert_admin\"\nPattern: \"task:failed:deploy\" →  Action: prompt \"The deploy failed. Investigate.\"\n```\n\nTriggers auto-disable after 5 consecutive failures for safety.\n\n**Workflows** are multi-step pipelines with data passing between steps:\n\n| Step Type | What It Does |\n|---|---|\n| `skill` | Runs a skill, stores result in context |\n| `prompt` | Sends a message to Claude, gets a response |\n| `condition` | Evaluates an expression, optionally skips to a step |\n| `wait` | Pauses the workflow for a duration (creates a scheduled task to resume) |\n| `approval` | Pauses workflow until a human approves or rejects |\n| `notify` | Creates a notification |\n\nSteps pass data via a JSON context hash using `{{context.step_name}}` interpolation:\n\n```\nStep 1 (skill: \"check_status\")    → result stored as context.check_status\nStep 2 (prompt: \"Status is {{context.check_status}}. What should we do?\")\nStep 3 (notify: \"Action taken: {{context.step_2}}\")\n```\n\nWorkflows can auto-start on a trigger event or be kicked off immediately.\n\n---\n\n### Documents — Upload, Parse, and Generate Files\n\nDocuments let you attach files (PDF, CSV, Excel, plain text) to conversations. On upload, `DocumentParser` extracts the text content so the agent can read it without re-parsing. Token-efficient: parse once, read many times.\n\nThe agent can also create documents programmatically — generating reports, exports, or formatted files and attaching them to the conversation for download.\n\n---\n\n### Dynamic Data Tables — AI-Created Structured Storage\n\nThe agent can create real SQLite tables on the fly with custom schemas via `create_data_table`. Once created, full CRUD is available through `insert_data_record`, `update_data_record`, `delete_data_record`, and `query_data_table`.\n\nUse cases: tracking lists, inventories, logs, or any structured data the agent needs to persist and query. Tables are first-class database objects — they support filtering, sorting, and aggregation via SQL.\n\n---\n\n### Approvals — Human-in-the-Loop Gates\n\nApprovals pause automation until a human decides. They work standalone or as workflow steps (`approval` step type). Each approval has a title, description, and optional timeout with auto-expiry.\n\nEvents are emitted on decision: `approval:approved:*`, `approval:rejected:*`, `approval:expired:*` — so downstream triggers and workflows can react.\n\n---\n\n### Gmail Integration\n\nFull OAuth2 Gmail integration with 6 dedicated tools: `gmail_search`, `gmail_read`, `gmail_send`, `gmail_draft`, `gmail_modify`, and `gmail_labels`. The agent can search your inbox, read messages, compose and send emails, manage drafts, and modify labels.\n\n---\n\n### Python Support\n\nRun Python code alongside Ruby via `manage_python`. Includes virtualenv management for dependency isolation. Python skills are auto-discovered from `skills/` alongside Ruby skills.\n\n---\n\n### MCP Tools & Resources\n\nClaude interacts with OpenFang through 38 MCP tools and 6 resources, served over SSE at `/mcp/sse`.\n\n**Tools** (auto-discovered from `fang/tools/`):\n\n| Tool | Purpose |\n|---|---|\n| **Core** | |\n| `run_code` | Execute arbitrary Ruby with full model access |\n| `run_skill` | Execute a saved skill by name |\n| `manage_python` | Run Python code, manage virtualenv and dependencies |\n| `send_message` | Send a message to the conversation |\n| **Scheduling** | |\n| `schedule_task` | Schedule a one-shot or recurring task |\n| **Pages & Canvas** | |\n| `create_page` | Create a new canvas page |\n| `get_canvas` | Read current page's widget layout |\n| `update_canvas` | Set page HTML content |\n| `add_canvas_component` | Add a widget to the canvas |\n| `update_canvas_component` | Modify a widget's position/content/data |\n| `remove_canvas_component` | Remove a widget |\n| `define_widget` | Create a new widget type (writes Ruby to disk) |\n| **Documents** | |\n| `create_document` | Upload or generate a document |\n| `read_document` | Read extracted text from a document |\n| `list_documents` | List documents in a conversation |\n| **Data Tables** | |\n| `create_data_table` | Create a dynamic SQLite table with custom schema |\n| `list_data_tables` | List all dynamic data tables |\n| `query_data_table` | Query records with filtering and sorting |\n| `insert_data_record` | Insert a row into a data table |\n| `update_data_record` | Update a row in a data table |\n| `delete_data_record` | Delete a row from a data table |\n| **Approvals** | |\n| `create_approval` | Create a human-in-the-loop approval gate |\n| `list_approvals` | List pending and resolved approvals |\n| `resolve_approval` | Approve or reject a pending approval |\n| **Automation** | |\n| `create_notification` | Push a real-time notification |\n| `create_trigger` | Set up an event-driven trigger |\n| `create_workflow` | Build a multi-step automation pipeline |\n| `create_heartbeat` | Set up a token-efficient monitor |\n| `update_heartbeat` | Modify a heartbeat's config |\n| `list_heartbeats` | View all heartbeats and their stats |\n| **Web** | |\n| `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| `start_computer_use` | Launch a browser automation session |\n| **Gmail** | |\n| `gmail_search` | Search Gmail messages |\n| `gmail_read` | Read a Gmail message by ID |\n| `gmail_send` | Send an email via Gmail |\n| `gmail_draft` | Create a Gmail draft |\n| `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |\n| `gmail_labels` | List available Gmail labels |\n\n**Resources** (context the agent can read):\n\n| Resource | What It Provides |\n|---|---|\n| `config://user` | All config key/values, framework version |\n| `conversation://current` | Current conversation context, last 10 messages |\n| `skills://available` | All registered skills with usage counts |\n| `database://schema` | Full schema: tables, columns, indexes, row counts |\n| `gems://available` | All bundled gems and versions |\n| `system://profile` | OS, hardware, disk, network, installed CLI tools, services |\n\n**Auto-discovery**: Just create a file in `fang/tools/` that inherits `FastMcp::Tool` and restart. No registration code needed — `ObjectSpace` scanning handles it.\n\n---\n\n### Real-Time Web UI\n\nThe UI uses Turbo Streams over Server-Sent Events for instant updates. No WebSocket server, no Redis — just an in-memory pub/sub (`TurboBroadcast`) pushing HTML fragments to open SSE connections.\n\n**What updates in real time:**\n- Chat messages stream in as Claude generates them (thinking → tool use → text)\n- Canvas widgets refresh when data changes\n- Notifications appear instantly in the bell menu\n- Heartbeat monitor updates after each run\n\n**Canvas architecture:** The UI has a persistent chat footer at the bottom. Each canvas page can have multiple conversations. Tabs let you switch between canvases and conversations.\n\n**Design system:** shadcn/ui-inspired with terminal green accent (`#22c55e`). Light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows. Tailwind CSS via CDN with custom color tokens.\n\n---\n\n### WhatsApp Integration\n\nOptional integration via GOWA (Go WhatsApp gateway). Inbound messages hit `/webhooks/whatsapp`, create a conversation with `source: 'whatsapp'`, and route through the same agent pipeline. Responses are sent back to the phone automatically.\n\n---\n\n## Quick Start\n\n### Requirements\n\n- Ruby 3.3+\n- SQLite3 (or PostgreSQL)\n- Claude Code CLI (`claude`) installed and authenticated\n\n### Setup\n\n```bash\ngit clone https://github.com/youruser/openfang.git\ncd openfang\n./setup.sh\n```\n\n### Authentication\n\nOpenFang needs an Anthropic API key for the agent subprocess:\n\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\n```\n\n### Running\n\n```bash\n./openfang.rb server        # Web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # MCP server standalone (port 9292)\n```\n\nOpen `http://localhost:3000` and start chatting.\n\n---\n\n## Adding a Skill\n\nCreate `skills/my_skill.rb`:\n\n```ruby\nclass MySkill < Fang::Skill\n  description \"What this skill does\"\n  param :name, :string, required: true, description: \"Who to greet\"\n\n  def call(name:)\n    send_message(\"Hello, #{name}!\")\n    { greeted: name }\n  end\nend\n```\n\nRestart the server. The skill is auto-discovered and available via `run_skill my_skill name: \"World\"`.\n\nOr let Claude create skills for you — ask it to build something repeatable and it will write the skill file, register it, and use it going forward.\n\n---\n\n## Adding an MCP Tool\n\nCreate `fang/tools/my_tool.rb`:\n\n```ruby\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:input).filled(:string).description('The input')\n      end\n\n      def call(input:)\n        { success: true, result: input.upcase }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\nRestart. Auto-discovered via `ObjectSpace`.\n\n---\n\n## Token Efficiency by Design\n\nOpenFang is built around the idea that **AI should only be invoked when it's actually needed**.\n\n| Pattern | How It Saves Tokens |\n|---|---|\n| **Skills** | Write code once, run it forever in pure Ruby. No AI round-trip for repeated operations. |\n| **Heartbeats** | Skill runs every N seconds for free. AI is only invoked when the result is meaningful. |\n| **Widgets** | Self-rendering Ruby classes. Once defined, they produce HTML without any AI involvement. |\n| **Scheduled skill tasks** | Recurring cron tasks that run skills execute entirely in Ruby. |\n| **`run_code`** | Claude writes Ruby that runs against the database directly — one tool call instead of multiple back-and-forth messages. |\n\nThe philosophy: Claude's job is to *build the automation*, not *be the automation*.\n\n---\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":71,"oldLines":7,"newStart":71,"newLines":13,"lines":[" ├── resources/              # MCP resources (auto-registered)"," ├── widgets/                # Canvas widget types"," ├── jobs/                   # ActiveJob classes","-└── concerns/               # Shared model behavior","+├── concerns/               # Shared model behavior","+├── clients/                # API client integrations","+├── computer_use/           # Browser automation (Playwright)","+├── document_parser.rb      # Multi-format text extraction","+├── python_runner.rb        # Python virtualenv and execution","+├── gmail.rb                # Gmail OAuth2 integration","+└── system_profile.rb       # Host system capability detection"," web/"," ├── app.rb                  # All Roda routes"," ├── views/                  # ERB templates"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"475282f2-6d26-4b40-9c7a-2ccdfde40efb"}
{"parentUuid":"df41c636-8bd6-4097-bb4c-c0029dbd116f","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01CLcwK8yFoPkcVeQewXTwuw","type":"message","role":"assistant","content":[{"type":"text","text":"README.md is done. Now update CLAUDE.md:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":311,"cache_read_input_tokens":41685,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":311},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQQ3DfhudtXuX9TJRST","type":"assistant","uuid":"87a5ca89-27c0-49f9-9636-07fef70a95e4","timestamp":"2026-02-21T02:12:20.985Z"}
{"parentUuid":"87a5ca89-27c0-49f9-9636-07fef70a95e4","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01CLcwK8yFoPkcVeQewXTwuw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KEMR3ciEdLsHyCfPpohgqe","name":"TaskUpdate","input":{"taskId":"1","status":"completed"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":311,"cache_read_input_tokens":41685,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":311},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQQ3DfhudtXuX9TJRST","type":"assistant","uuid":"a50a083b-b151-48b4-843a-2b2bf4dcb321","timestamp":"2026-02-21T02:12:21.395Z"}
{"parentUuid":"a50a083b-b151-48b4-843a-2b2bf4dcb321","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KEMR3ciEdLsHyCfPpohgqe","type":"tool_result","content":"Updated task #1 status"}]},"uuid":"a850ef4a-a210-4448-a304-bff32bb3b694","timestamp":"2026-02-21T02:12:21.397Z","toolUseResult":{"success":true,"taskId":"1","updatedFields":["status"],"statusChange":{"from":"in_progress","to":"completed"}},"sourceToolAssistantUUID":"a50a083b-b151-48b4-843a-2b2bf4dcb321"}
{"parentUuid":"a850ef4a-a210-4448-a304-bff32bb3b694","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01CLcwK8yFoPkcVeQewXTwuw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FSaShPLkwQNefHdn85K7xq","name":"TaskUpdate","input":{"taskId":"2","status":"in_progress"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":311,"cache_read_input_tokens":41685,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":311},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQQ3DfhudtXuX9TJRST","type":"assistant","uuid":"7d96686c-3e58-467d-a821-6dbbce4841b1","timestamp":"2026-02-21T02:12:21.697Z"}
{"parentUuid":"7d96686c-3e58-467d-a821-6dbbce4841b1","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FSaShPLkwQNefHdn85K7xq","type":"tool_result","content":"Updated task #2 status"}]},"uuid":"40909f14-c993-433e-9903-43a32b20c655","timestamp":"2026-02-21T02:12:21.698Z","toolUseResult":{"success":true,"taskId":"2","updatedFields":["status"],"statusChange":{"from":"pending","to":"in_progress"}},"sourceToolAssistantUUID":"7d96686c-3e58-467d-a821-6dbbce4841b1"}
{"parentUuid":"40909f14-c993-433e-9903-43a32b20c655","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01RzLSzohUCdvzfRHzu3RGD2","type":"message","role":"assistant","content":[{"type":"text","text":"Update the architecture tree in CLAUDE.md:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":212,"cache_read_input_tokens":41996,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":212},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQQKcekuBAw1TCiSXr8","type":"assistant","uuid":"81434b07-bb9e-4aef-9fa4-e6da487e62c9","timestamp":"2026-02-21T02:12:24.467Z"}
{"type":"file-history-snapshot","messageId":"cafd59c9-fb65-42dc-8331-6814f4f2cd35","snapshot":{"messageId":"2a16f9a6-b9ac-47c4-b037-39bf0d9bffda","trackedFileBackups":{"README.md":{"backupFileName":"d67d4985e8911acf@v1","version":1,"backupTime":"2026-02-21T02:11:24.277Z"},"CLAUDE.md":{"backupFileName":"e76642578ae24c9d@v1","version":1,"backupTime":"2026-02-21T02:12:30.123Z"}},"timestamp":"2026-02-21T02:10:15.794Z"},"isSnapshotUpdate":true}
{"parentUuid":"81434b07-bb9e-4aef-9fa4-e6da487e62c9","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01RzLSzohUCdvzfRHzu3RGD2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ut7WfmmV4Lax8VryXT2zqB","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/CLAUDE.md","old_string":"openfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb          Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n└── fang/scheduler.rb     Rufus-scheduler for recurring tasks","new_string":"openfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb            Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n├── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n├── fang/computer_use/    Browser automation (Playwright)\n├── fang/document_parser.rb  Multi-format text extraction\n├── fang/python_runner.rb    Python virtualenv and execution\n└── fang/gmail.rb            Gmail OAuth2 integration"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":212,"cache_read_input_tokens":41996,"output_tokens":433,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":212,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQQKcekuBAw1TCiSXr8","type":"assistant","uuid":"cafd59c9-fb65-42dc-8331-6814f4f2cd35","timestamp":"2026-02-21T02:12:30.103Z"}
{"parentUuid":"cafd59c9-fb65-42dc-8331-6814f4f2cd35","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Ut7WfmmV4Lax8VryXT2zqB","toolUseID":"toolu_01Ut7WfmmV4Lax8VryXT2zqB","timestamp":"2026-02-21T02:12:30.126Z","uuid":"39cfb045-db21-4148-9645-5d126a65bbba"}
{"parentUuid":"cafd59c9-fb65-42dc-8331-6814f4f2cd35","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ut7WfmmV4Lax8VryXT2zqB","type":"tool_result","content":"The file /home/greg/Developer/openfang/CLAUDE.md has been updated successfully."}]},"uuid":"497606eb-793a-469c-bbfc-907963cb7899","timestamp":"2026-02-21T02:12:30.125Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/CLAUDE.md","oldString":"openfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb          Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n└── fang/scheduler.rb     Rufus-scheduler for recurring tasks","newString":"openfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb            Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n├── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n├── fang/computer_use/    Browser automation (Playwright)\n├── fang/document_parser.rb  Multi-format text extraction\n├── fang/python_runner.rb    Python virtualenv and execution\n└── fang/gmail.rb            Gmail OAuth2 integration","originalFile":"# OpenFang — Claude Code Guide\n\n## What This Is\n\nA personal AI assistant framework (\"OpenFang\") built in Ruby. It combines a Roda web UI, ActiveRecord models (SQLite), FastMCP tool server, and a Claude Code CLI subprocess as the agent runtime.\n\n## Architecture\n\n```\nopenfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb          Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n└── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n```\n\n**Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process.\n\n**Agent execution**: When a user sends a message, `AgentExecutorJob` runs `Fang::Agent.execute`, which spawns a `claude` CLI subprocess with MCP tools. The subprocess uses `workspace/.mcp.json` and `workspace/CLAUDE.md` as its system prompt.\n\n## Key Conventions\n\n- **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed.\n- **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.\n- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`).\n\n## Running the App\n\n```bash\n./openfang.rb server        # Start web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # Start MCP server standalone\n```\n\n## Adding a New MCP Tool\n\n1. Create `fang/tools/my_tool.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:name).filled(:string).description('Argument description')\n        optional(:option).filled(:string).description('Optional argument')\n      end\n\n      def call(name:, option: nil)\n        # Tool logic here — all Fang:: models are available\n        { success: true, result: 'done' }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. The tool is auto-discovered.\n\n## Adding a Route/View\n\n1. Add route in `web/app.rb` following Roda `r.on` / `r.is` patterns\n2. Create ERB template in `web/views/`\n3. Add nav link in `web/views/layout.erb` sidebar `<nav>` section\n\n## Adding a Model\n\n1. Create migration in `workspace/migrations/YYYYMMDDNNNNNN_description.rb`:\n\n```ruby\nclass CreateThings < ActiveRecord::Migration[8.0]\n  def change\n    create_table :things do |t|\n      t.string :name, null: false\n      t.timestamps\n    end\n  end\nend\n```\n\n2. Create model in `fang/models/thing.rb`:\n\n```ruby\nmodule Fang\n  class Thing < ActiveRecord::Base\n    self.table_name = 'things'\n  end\nend\n```\n\n3. Run `./openfang.rb db:migrate`\n\n## Adding an API Client\n\n`Fang::ApplicationClient` (`fang/application_client.rb`) is a base HTTP client using `Net::HTTP`. Subclasses get their own `Response`, `Error`, `NotFound`, etc. classes automatically.\n\n1. Create `fang/clients/my_service_client.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Clients\n    class MyService < ApplicationClient\n      BASE_URI = \"https://api.myservice.com/v1\"\n\n      # Override if the API uses a different auth scheme\n      # def authorization_header = { \"X-API-Key\" => token }\n\n      def widgets\n        get(\"/widgets\")\n      rescue *NET_HTTP_ERRORS\n        raise Error, \"Unable to fetch widgets\"\n      end\n\n      def create_widget(name:)\n        post(\"/widgets\", body: { name: name })\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. Clients in `fang/clients/` are auto-loaded.\n\n### Key features\n\n- **HTTP methods**: `get`, `post`, `patch`, `put`, `delete` — all accept `headers:`, `query:`, `body:`, `form_data:`\n- **JSON by default**: Request bodies are serialized to JSON. Responses with `application/json` are parsed to `OpenStruct` for dot-access (e.g., `response.name`).\n- **Auth**: Pass `token:` on init. Override `authorization_header` for non-Bearer schemes.\n- **Error handling**: Raises typed errors (`NotFound`, `Unauthorized`, `RateLimit`, etc.). Rescue `*NET_HTTP_ERRORS` for network failures.\n- **Pagination**: `with_pagination(path) { |response| next_page_or_nil }` loops until the block returns nil.\n- **Custom response parsers**: Override per-client with `Response::PARSER[\"text/html\"] = ->(r) { Nokogiri::HTML(r.body) }`\n\n### Usage\n\n```ruby\nclient = Fang::Clients::MyService.new(token: ENV[\"MY_SERVICE_API_KEY\"])\nclient.widgets          # => Response with dot-access to parsed JSON\nclient.create_widget(name: \"Foo\")\n```\n\n## Design System\n\nClean, minimal shadcn/ui-inspired design with terminal green accent. Supports light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows.\n\n### CSS Tokens (defined in `web/public/css/style.css`)\n\nLight and dark mode tokens are defined as CSS custom properties. The `--fang-*` aliases are used by Tailwind classes.\n\n| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#ffffff` | `#09090b` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#ffffff` | `#18181b` | Card backgrounds |\n| `--muted` | `#f1f5f9` | `#27272a` | Muted backgrounds |\n| `--muted-foreground` | `#64748b` | `#a1a1aa` | Muted text |\n| `--primary` | `#16a34a` | `#22c55e` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#e2e8f0` | `#27272a` | Borders |\n| `--ring` | `#16a34a` | `#22c55e` | Focus rings |\n\n### Components\n- **`.card`** — rounded card with subtle border and shadow\n- **`.badge`** — pill label (variants: `.success`, `.error`, `.warning`, `.info`)\n- **`button`** — green bg, rounded. Variants: `.ghost`, `.outline`, `.sm`, `.xs`, `.icon`\n- **`.chat-msg.user`** / **`.chat-msg.ai`** — rounded chat bubbles\n- **`.prose-bubble`** — markdown content inside chat bubbles\n- **`.section-heading`** — card section titles\n- **`.msg-meta`** — chat message metadata (small, uppercase, muted)\n- **`.notification-unread`** — unread notification left border accent\n- **`.nav-trigger`** — hamburger menu button\n- **`.notification-badge`** — small pill badge for notification counts\n\n### Rules\n- **No inline styles** — all styling via Tailwind utilities or CSS classes\n- **No `text-transform: uppercase`** on headings — use `font-semibold tracking-tight`\n\nTailwind CSS is loaded via CDN with custom colors: `fang-bg`, `fang-fg`, `fang-muted`, `fang-muted-fg`, `fang-accent`, `fang-accent-fg`, `fang-border`, `fang-card`, `fang-primary`, `fang-ring`.\n\n## Event System\n\n`Fang::EventBus` is a simple in-process pub/sub for decoupled automation. Call `EventBus.emit(\"event:name\", data)` to fire an event. Triggers and workflows listen for matching events.\n\n**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n\n**Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt.\n\n**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.\n\n## Key Files\n\n| File | Purpose |\n|---|---|\n| `openfang.rb` | CLI entrypoint |\n| `fang/bootstrap.rb` | Framework loader |\n| `fang/agent.rb` | Claude subprocess execution |\n| `fang/mcp_server.rb` | FastMCP tool/resource registration |\n| `fang/application_client.rb` | Base HTTP API client (subclass for new integrations) |\n| `fang/event_bus.rb` | In-process event pub/sub for triggers and workflows |\n| `web/app.rb` | All Roda routes |\n| `web/views/layout.erb` | Main layout with sidebar nav |\n| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n| `web/public/css/style.css` | Complete design system |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n\n## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |\n","structuredPatch":[{"oldStart":8,"oldLines":11,"newStart":8,"newLines":15,"lines":[" "," ```"," openfang.rb (entrypoint) → Fang::CLI (Thor)","-├── web/app.rb          Roda web server (port 3000)","+├── web/app.rb            Roda web server (port 3000)"," ├── fang/mcp_server.rb    FastMCP tool server (port 9292)"," ├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation"," ├── fang/bootstrap.rb     Loads everything, connects DB","-└── fang/scheduler.rb     Rufus-scheduler for recurring tasks","+├── fang/scheduler.rb     Rufus-scheduler for recurring tasks","+├── fang/computer_use/    Browser automation (Playwright)","+├── fang/document_parser.rb  Multi-format text extraction","+├── fang/python_runner.rb    Python virtualenv and execution","+└── fang/gmail.rb            Gmail OAuth2 integration"," ```"," "," **Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"cafd59c9-fb65-42dc-8331-6814f4f2cd35"}
{"parentUuid":"497606eb-793a-469c-bbfc-907963cb7899","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Sd4hC2EEZhU5AeLSY91jne","type":"message","role":"assistant","content":[{"type":"text","text":"Update the concerns mention:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":466,"cache_read_input_tokens":42208,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":466},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQQtzbgPUn6icSa2mbn","type":"assistant","uuid":"9c6e37a3-b05a-4f1e-9b69-6014708f0ec4","timestamp":"2026-02-21T02:12:33.171Z"}
{"parentUuid":"9c6e37a3-b05a-4f1e-9b69-6014708f0ec4","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Sd4hC2EEZhU5AeLSY91jne","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014f8USDRijtJiujpQBvgbct","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/CLAUDE.md","old_string":"- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`).","new_string":"- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`, `HasJsonDefaults`)."},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":466,"cache_read_input_tokens":42208,"output_tokens":188,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":466,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQQtzbgPUn6icSa2mbn","type":"assistant","uuid":"fb3be328-c245-47cf-bef8-382623d391ee","timestamp":"2026-02-21T02:12:34.916Z"}
{"parentUuid":"fb3be328-c245-47cf-bef8-382623d391ee","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_014f8USDRijtJiujpQBvgbct","toolUseID":"toolu_014f8USDRijtJiujpQBvgbct","timestamp":"2026-02-21T02:12:34.924Z","uuid":"800ab76f-5637-4589-908f-05bb93de1820"}
{"parentUuid":"fb3be328-c245-47cf-bef8-382623d391ee","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014f8USDRijtJiujpQBvgbct","type":"tool_result","content":"The file /home/greg/Developer/openfang/CLAUDE.md has been updated successfully."}]},"uuid":"5659935d-980d-4666-8d42-ca5ffac452b1","timestamp":"2026-02-21T02:12:34.923Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/CLAUDE.md","oldString":"- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`).","newString":"- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`, `HasJsonDefaults`).","originalFile":"# OpenFang — Claude Code Guide\n\n## What This Is\n\nA personal AI assistant framework (\"OpenFang\") built in Ruby. It combines a Roda web UI, ActiveRecord models (SQLite), FastMCP tool server, and a Claude Code CLI subprocess as the agent runtime.\n\n## Architecture\n\n```\nopenfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb            Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n├── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n├── fang/computer_use/    Browser automation (Playwright)\n├── fang/document_parser.rb  Multi-format text extraction\n├── fang/python_runner.rb    Python virtualenv and execution\n└── fang/gmail.rb            Gmail OAuth2 integration\n```\n\n**Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process.\n\n**Agent execution**: When a user sends a message, `AgentExecutorJob` runs `Fang::Agent.execute`, which spawns a `claude` CLI subprocess with MCP tools. The subprocess uses `workspace/.mcp.json` and `workspace/CLAUDE.md` as its system prompt.\n\n## Key Conventions\n\n- **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed.\n- **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.\n- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`).\n\n## Running the App\n\n```bash\n./openfang.rb server        # Start web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # Start MCP server standalone\n```\n\n## Adding a New MCP Tool\n\n1. Create `fang/tools/my_tool.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:name).filled(:string).description('Argument description')\n        optional(:option).filled(:string).description('Optional argument')\n      end\n\n      def call(name:, option: nil)\n        # Tool logic here — all Fang:: models are available\n        { success: true, result: 'done' }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. The tool is auto-discovered.\n\n## Adding a Route/View\n\n1. Add route in `web/app.rb` following Roda `r.on` / `r.is` patterns\n2. Create ERB template in `web/views/`\n3. Add nav link in `web/views/layout.erb` sidebar `<nav>` section\n\n## Adding a Model\n\n1. Create migration in `workspace/migrations/YYYYMMDDNNNNNN_description.rb`:\n\n```ruby\nclass CreateThings < ActiveRecord::Migration[8.0]\n  def change\n    create_table :things do |t|\n      t.string :name, null: false\n      t.timestamps\n    end\n  end\nend\n```\n\n2. Create model in `fang/models/thing.rb`:\n\n```ruby\nmodule Fang\n  class Thing < ActiveRecord::Base\n    self.table_name = 'things'\n  end\nend\n```\n\n3. Run `./openfang.rb db:migrate`\n\n## Adding an API Client\n\n`Fang::ApplicationClient` (`fang/application_client.rb`) is a base HTTP client using `Net::HTTP`. Subclasses get their own `Response`, `Error`, `NotFound`, etc. classes automatically.\n\n1. Create `fang/clients/my_service_client.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Clients\n    class MyService < ApplicationClient\n      BASE_URI = \"https://api.myservice.com/v1\"\n\n      # Override if the API uses a different auth scheme\n      # def authorization_header = { \"X-API-Key\" => token }\n\n      def widgets\n        get(\"/widgets\")\n      rescue *NET_HTTP_ERRORS\n        raise Error, \"Unable to fetch widgets\"\n      end\n\n      def create_widget(name:)\n        post(\"/widgets\", body: { name: name })\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. Clients in `fang/clients/` are auto-loaded.\n\n### Key features\n\n- **HTTP methods**: `get`, `post`, `patch`, `put`, `delete` — all accept `headers:`, `query:`, `body:`, `form_data:`\n- **JSON by default**: Request bodies are serialized to JSON. Responses with `application/json` are parsed to `OpenStruct` for dot-access (e.g., `response.name`).\n- **Auth**: Pass `token:` on init. Override `authorization_header` for non-Bearer schemes.\n- **Error handling**: Raises typed errors (`NotFound`, `Unauthorized`, `RateLimit`, etc.). Rescue `*NET_HTTP_ERRORS` for network failures.\n- **Pagination**: `with_pagination(path) { |response| next_page_or_nil }` loops until the block returns nil.\n- **Custom response parsers**: Override per-client with `Response::PARSER[\"text/html\"] = ->(r) { Nokogiri::HTML(r.body) }`\n\n### Usage\n\n```ruby\nclient = Fang::Clients::MyService.new(token: ENV[\"MY_SERVICE_API_KEY\"])\nclient.widgets          # => Response with dot-access to parsed JSON\nclient.create_widget(name: \"Foo\")\n```\n\n## Design System\n\nClean, minimal shadcn/ui-inspired design with terminal green accent. Supports light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows.\n\n### CSS Tokens (defined in `web/public/css/style.css`)\n\nLight and dark mode tokens are defined as CSS custom properties. The `--fang-*` aliases are used by Tailwind classes.\n\n| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#ffffff` | `#09090b` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#ffffff` | `#18181b` | Card backgrounds |\n| `--muted` | `#f1f5f9` | `#27272a` | Muted backgrounds |\n| `--muted-foreground` | `#64748b` | `#a1a1aa` | Muted text |\n| `--primary` | `#16a34a` | `#22c55e` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#e2e8f0` | `#27272a` | Borders |\n| `--ring` | `#16a34a` | `#22c55e` | Focus rings |\n\n### Components\n- **`.card`** — rounded card with subtle border and shadow\n- **`.badge`** — pill label (variants: `.success`, `.error`, `.warning`, `.info`)\n- **`button`** — green bg, rounded. Variants: `.ghost`, `.outline`, `.sm`, `.xs`, `.icon`\n- **`.chat-msg.user`** / **`.chat-msg.ai`** — rounded chat bubbles\n- **`.prose-bubble`** — markdown content inside chat bubbles\n- **`.section-heading`** — card section titles\n- **`.msg-meta`** — chat message metadata (small, uppercase, muted)\n- **`.notification-unread`** — unread notification left border accent\n- **`.nav-trigger`** — hamburger menu button\n- **`.notification-badge`** — small pill badge for notification counts\n\n### Rules\n- **No inline styles** — all styling via Tailwind utilities or CSS classes\n- **No `text-transform: uppercase`** on headings — use `font-semibold tracking-tight`\n\nTailwind CSS is loaded via CDN with custom colors: `fang-bg`, `fang-fg`, `fang-muted`, `fang-muted-fg`, `fang-accent`, `fang-accent-fg`, `fang-border`, `fang-card`, `fang-primary`, `fang-ring`.\n\n## Event System\n\n`Fang::EventBus` is a simple in-process pub/sub for decoupled automation. Call `EventBus.emit(\"event:name\", data)` to fire an event. Triggers and workflows listen for matching events.\n\n**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n\n**Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt.\n\n**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.\n\n## Key Files\n\n| File | Purpose |\n|---|---|\n| `openfang.rb` | CLI entrypoint |\n| `fang/bootstrap.rb` | Framework loader |\n| `fang/agent.rb` | Claude subprocess execution |\n| `fang/mcp_server.rb` | FastMCP tool/resource registration |\n| `fang/application_client.rb` | Base HTTP API client (subclass for new integrations) |\n| `fang/event_bus.rb` | In-process event pub/sub for triggers and workflows |\n| `web/app.rb` | All Roda routes |\n| `web/views/layout.erb` | Main layout with sidebar nav |\n| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n| `web/public/css/style.css` | Complete design system |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n\n## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |\n","structuredPatch":[{"oldStart":27,"oldLines":7,"newStart":27,"newLines":7,"lines":[" "," - **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed."," - **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.","-- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`).","+- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`, `HasJsonDefaults`)."," "," ## Running the App"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"fb3be328-c245-47cf-bef8-382623d391ee"}
{"parentUuid":"5659935d-980d-4666-8d42-ca5ffac452b1","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Ca2ZXL8UhbVq5DQaQpmV1V","type":"message","role":"assistant","content":[{"type":"text","text":"Update CSS tokens to match actual style.css values:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":221,"cache_read_input_tokens":42674,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":221},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQRFZ6zRaBM4CMZqY4N","type":"assistant","uuid":"ca3b2ca0-b830-4252-b71c-a986e615d8a6","timestamp":"2026-02-21T02:12:37.472Z"}
{"parentUuid":"ca3b2ca0-b830-4252-b71c-a986e615d8a6","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Ca2ZXL8UhbVq5DQaQpmV1V","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Rcbh2ouZiNVULPGPBQirCe","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/CLAUDE.md","old_string":"| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#ffffff` | `#09090b` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#ffffff` | `#18181b` | Card backgrounds |\n| `--muted` | `#f1f5f9` | `#27272a` | Muted backgrounds |\n| `--muted-foreground` | `#64748b` | `#a1a1aa` | Muted text |\n| `--primary` | `#16a34a` | `#22c55e` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#e2e8f0` | `#27272a` | Borders |\n| `--ring` | `#16a34a` | `#22c55e` | Focus rings |","new_string":"| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#c8ccd1` | `#1a1a1e` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#dde0e4` | `#242428` | Card backgrounds |\n| `--muted` | `#b8bcc2` | `#2e2e33` | Muted backgrounds |\n| `--muted-foreground` | `#4a5568` | `#9a9aaa` | Muted text |\n| `--primary` | `#16a34a` | `#16a34a` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#a8adb4` | `#3a3a40` | Borders |\n| `--ring` | `#16a34a` | `#16a34a` | Focus rings |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":221,"cache_read_input_tokens":42674,"output_tokens":653,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":221,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQRFZ6zRaBM4CMZqY4N","type":"assistant","uuid":"c684cd20-24ac-46f9-b6cf-e4b329c2e9d6","timestamp":"2026-02-21T02:12:44.094Z"}
{"parentUuid":"c684cd20-24ac-46f9-b6cf-e4b329c2e9d6","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Rcbh2ouZiNVULPGPBQirCe","toolUseID":"toolu_01Rcbh2ouZiNVULPGPBQirCe","timestamp":"2026-02-21T02:12:44.102Z","uuid":"5a971db8-fb00-4ec2-9379-dfe0cb6f7c99"}
{"parentUuid":"c684cd20-24ac-46f9-b6cf-e4b329c2e9d6","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Rcbh2ouZiNVULPGPBQirCe","type":"tool_result","content":"The file /home/greg/Developer/openfang/CLAUDE.md has been updated successfully."}]},"uuid":"8c2410f9-8b3e-466e-befc-0d0742e340ae","timestamp":"2026-02-21T02:12:44.101Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/CLAUDE.md","oldString":"| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#ffffff` | `#09090b` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#ffffff` | `#18181b` | Card backgrounds |\n| `--muted` | `#f1f5f9` | `#27272a` | Muted backgrounds |\n| `--muted-foreground` | `#64748b` | `#a1a1aa` | Muted text |\n| `--primary` | `#16a34a` | `#22c55e` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#e2e8f0` | `#27272a` | Borders |\n| `--ring` | `#16a34a` | `#22c55e` | Focus rings |","newString":"| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#c8ccd1` | `#1a1a1e` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#dde0e4` | `#242428` | Card backgrounds |\n| `--muted` | `#b8bcc2` | `#2e2e33` | Muted backgrounds |\n| `--muted-foreground` | `#4a5568` | `#9a9aaa` | Muted text |\n| `--primary` | `#16a34a` | `#16a34a` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#a8adb4` | `#3a3a40` | Borders |\n| `--ring` | `#16a34a` | `#16a34a` | Focus rings |","originalFile":"# OpenFang — Claude Code Guide\n\n## What This Is\n\nA personal AI assistant framework (\"OpenFang\") built in Ruby. It combines a Roda web UI, ActiveRecord models (SQLite), FastMCP tool server, and a Claude Code CLI subprocess as the agent runtime.\n\n## Architecture\n\n```\nopenfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb            Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n├── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n├── fang/computer_use/    Browser automation (Playwright)\n├── fang/document_parser.rb  Multi-format text extraction\n├── fang/python_runner.rb    Python virtualenv and execution\n└── fang/gmail.rb            Gmail OAuth2 integration\n```\n\n**Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process.\n\n**Agent execution**: When a user sends a message, `AgentExecutorJob` runs `Fang::Agent.execute`, which spawns a `claude` CLI subprocess with MCP tools. The subprocess uses `workspace/.mcp.json` and `workspace/CLAUDE.md` as its system prompt.\n\n## Key Conventions\n\n- **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed.\n- **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.\n- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`, `HasJsonDefaults`).\n\n## Running the App\n\n```bash\n./openfang.rb server        # Start web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # Start MCP server standalone\n```\n\n## Adding a New MCP Tool\n\n1. Create `fang/tools/my_tool.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:name).filled(:string).description('Argument description')\n        optional(:option).filled(:string).description('Optional argument')\n      end\n\n      def call(name:, option: nil)\n        # Tool logic here — all Fang:: models are available\n        { success: true, result: 'done' }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. The tool is auto-discovered.\n\n## Adding a Route/View\n\n1. Add route in `web/app.rb` following Roda `r.on` / `r.is` patterns\n2. Create ERB template in `web/views/`\n3. Add nav link in `web/views/layout.erb` sidebar `<nav>` section\n\n## Adding a Model\n\n1. Create migration in `workspace/migrations/YYYYMMDDNNNNNN_description.rb`:\n\n```ruby\nclass CreateThings < ActiveRecord::Migration[8.0]\n  def change\n    create_table :things do |t|\n      t.string :name, null: false\n      t.timestamps\n    end\n  end\nend\n```\n\n2. Create model in `fang/models/thing.rb`:\n\n```ruby\nmodule Fang\n  class Thing < ActiveRecord::Base\n    self.table_name = 'things'\n  end\nend\n```\n\n3. Run `./openfang.rb db:migrate`\n\n## Adding an API Client\n\n`Fang::ApplicationClient` (`fang/application_client.rb`) is a base HTTP client using `Net::HTTP`. Subclasses get their own `Response`, `Error`, `NotFound`, etc. classes automatically.\n\n1. Create `fang/clients/my_service_client.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Clients\n    class MyService < ApplicationClient\n      BASE_URI = \"https://api.myservice.com/v1\"\n\n      # Override if the API uses a different auth scheme\n      # def authorization_header = { \"X-API-Key\" => token }\n\n      def widgets\n        get(\"/widgets\")\n      rescue *NET_HTTP_ERRORS\n        raise Error, \"Unable to fetch widgets\"\n      end\n\n      def create_widget(name:)\n        post(\"/widgets\", body: { name: name })\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. Clients in `fang/clients/` are auto-loaded.\n\n### Key features\n\n- **HTTP methods**: `get`, `post`, `patch`, `put`, `delete` — all accept `headers:`, `query:`, `body:`, `form_data:`\n- **JSON by default**: Request bodies are serialized to JSON. Responses with `application/json` are parsed to `OpenStruct` for dot-access (e.g., `response.name`).\n- **Auth**: Pass `token:` on init. Override `authorization_header` for non-Bearer schemes.\n- **Error handling**: Raises typed errors (`NotFound`, `Unauthorized`, `RateLimit`, etc.). Rescue `*NET_HTTP_ERRORS` for network failures.\n- **Pagination**: `with_pagination(path) { |response| next_page_or_nil }` loops until the block returns nil.\n- **Custom response parsers**: Override per-client with `Response::PARSER[\"text/html\"] = ->(r) { Nokogiri::HTML(r.body) }`\n\n### Usage\n\n```ruby\nclient = Fang::Clients::MyService.new(token: ENV[\"MY_SERVICE_API_KEY\"])\nclient.widgets          # => Response with dot-access to parsed JSON\nclient.create_widget(name: \"Foo\")\n```\n\n## Design System\n\nClean, minimal shadcn/ui-inspired design with terminal green accent. Supports light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows.\n\n### CSS Tokens (defined in `web/public/css/style.css`)\n\nLight and dark mode tokens are defined as CSS custom properties. The `--fang-*` aliases are used by Tailwind classes.\n\n| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#ffffff` | `#09090b` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#ffffff` | `#18181b` | Card backgrounds |\n| `--muted` | `#f1f5f9` | `#27272a` | Muted backgrounds |\n| `--muted-foreground` | `#64748b` | `#a1a1aa` | Muted text |\n| `--primary` | `#16a34a` | `#22c55e` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#e2e8f0` | `#27272a` | Borders |\n| `--ring` | `#16a34a` | `#22c55e` | Focus rings |\n\n### Components\n- **`.card`** — rounded card with subtle border and shadow\n- **`.badge`** — pill label (variants: `.success`, `.error`, `.warning`, `.info`)\n- **`button`** — green bg, rounded. Variants: `.ghost`, `.outline`, `.sm`, `.xs`, `.icon`\n- **`.chat-msg.user`** / **`.chat-msg.ai`** — rounded chat bubbles\n- **`.prose-bubble`** — markdown content inside chat bubbles\n- **`.section-heading`** — card section titles\n- **`.msg-meta`** — chat message metadata (small, uppercase, muted)\n- **`.notification-unread`** — unread notification left border accent\n- **`.nav-trigger`** — hamburger menu button\n- **`.notification-badge`** — small pill badge for notification counts\n\n### Rules\n- **No inline styles** — all styling via Tailwind utilities or CSS classes\n- **No `text-transform: uppercase`** on headings — use `font-semibold tracking-tight`\n\nTailwind CSS is loaded via CDN with custom colors: `fang-bg`, `fang-fg`, `fang-muted`, `fang-muted-fg`, `fang-accent`, `fang-accent-fg`, `fang-border`, `fang-card`, `fang-primary`, `fang-ring`.\n\n## Event System\n\n`Fang::EventBus` is a simple in-process pub/sub for decoupled automation. Call `EventBus.emit(\"event:name\", data)` to fire an event. Triggers and workflows listen for matching events.\n\n**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n\n**Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt.\n\n**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.\n\n## Key Files\n\n| File | Purpose |\n|---|---|\n| `openfang.rb` | CLI entrypoint |\n| `fang/bootstrap.rb` | Framework loader |\n| `fang/agent.rb` | Claude subprocess execution |\n| `fang/mcp_server.rb` | FastMCP tool/resource registration |\n| `fang/application_client.rb` | Base HTTP API client (subclass for new integrations) |\n| `fang/event_bus.rb` | In-process event pub/sub for triggers and workflows |\n| `web/app.rb` | All Roda routes |\n| `web/views/layout.erb` | Main layout with sidebar nav |\n| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n| `web/public/css/style.css` | Complete design system |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n\n## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |\n","structuredPatch":[{"oldStart":162,"oldLines":15,"newStart":162,"newLines":15,"lines":[" "," | Token | Light | Dark | Usage |"," |---|---|---|---|","-| `--background` | `#ffffff` | `#09090b` | Page background |","+| `--background` | `#c8ccd1` | `#1a1a1e` | Page background |"," | `--foreground` | `#0f172a` | `#fafafa` | Primary text |","-| `--card` | `#ffffff` | `#18181b` | Card backgrounds |","-| `--muted` | `#f1f5f9` | `#27272a` | Muted backgrounds |","-| `--muted-foreground` | `#64748b` | `#a1a1aa` | Muted text |","-| `--primary` | `#16a34a` | `#22c55e` | Accent (green) |","+| `--card` | `#dde0e4` | `#242428` | Card backgrounds |","+| `--muted` | `#b8bcc2` | `#2e2e33` | Muted backgrounds |","+| `--muted-foreground` | `#4a5568` | `#9a9aaa` | Muted text |","+| `--primary` | `#16a34a` | `#16a34a` | Accent (green) |"," | `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |","-| `--border` | `#e2e8f0` | `#27272a` | Borders |","-| `--ring` | `#16a34a` | `#22c55e` | Focus rings |","+| `--border` | `#a8adb4` | `#3a3a40` | Borders |","+| `--ring` | `#16a34a` | `#16a34a` | Focus rings |"," "," ### Components"," - **`.card`** — rounded card with subtle border and shadow"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"c684cd20-24ac-46f9-b6cf-e4b329c2e9d6"}
{"parentUuid":"8c2410f9-8b3e-466e-befc-0d0742e340ae","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01AqY544JSkdUw7PAinPU5Un","type":"message","role":"assistant","content":[{"type":"text","text":"Update Event System with missing events:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":686,"cache_read_input_tokens":42895,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":686},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQRvgpP3GhcLtczNBZK","type":"assistant","uuid":"eabfa438-4cb6-41cb-9a78-a43db98fb8f6","timestamp":"2026-02-21T02:12:46.545Z"}
{"parentUuid":"eabfa438-4cb6-41cb-9a78-a43db98fb8f6","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01AqY544JSkdUw7PAinPU5Un","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UaSw97KmVkZejtenNqSDB5","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/CLAUDE.md","old_string":"**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`","new_string":"**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n- `WorkflowRunnerJob` → `workflow:completed:*` / `workflow:failed:*`\n- `Approval` → `approval:approved:*` / `approval:rejected:*` / `approval:expired:*`"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":686,"cache_read_input_tokens":42895,"output_tokens":354,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":686,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQRvgpP3GhcLtczNBZK","type":"assistant","uuid":"eabf0a08-0fdd-45ca-b4c8-451ba1da1221","timestamp":"2026-02-21T02:12:50.788Z"}
{"parentUuid":"eabf0a08-0fdd-45ca-b4c8-451ba1da1221","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01UaSw97KmVkZejtenNqSDB5","toolUseID":"toolu_01UaSw97KmVkZejtenNqSDB5","timestamp":"2026-02-21T02:12:50.809Z","uuid":"47516eea-25d5-4af4-a901-462b150960a3"}
{"parentUuid":"eabf0a08-0fdd-45ca-b4c8-451ba1da1221","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UaSw97KmVkZejtenNqSDB5","type":"tool_result","content":"The file /home/greg/Developer/openfang/CLAUDE.md has been updated successfully."}]},"uuid":"686e0a44-cfbb-40c2-9747-87bbff5e2690","timestamp":"2026-02-21T02:12:50.808Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/CLAUDE.md","oldString":"**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`","newString":"**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n- `WorkflowRunnerJob` → `workflow:completed:*` / `workflow:failed:*`\n- `Approval` → `approval:approved:*` / `approval:rejected:*` / `approval:expired:*`","originalFile":"# OpenFang — Claude Code Guide\n\n## What This Is\n\nA personal AI assistant framework (\"OpenFang\") built in Ruby. It combines a Roda web UI, ActiveRecord models (SQLite), FastMCP tool server, and a Claude Code CLI subprocess as the agent runtime.\n\n## Architecture\n\n```\nopenfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb            Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n├── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n├── fang/computer_use/    Browser automation (Playwright)\n├── fang/document_parser.rb  Multi-format text extraction\n├── fang/python_runner.rb    Python virtualenv and execution\n└── fang/gmail.rb            Gmail OAuth2 integration\n```\n\n**Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process.\n\n**Agent execution**: When a user sends a message, `AgentExecutorJob` runs `Fang::Agent.execute`, which spawns a `claude` CLI subprocess with MCP tools. The subprocess uses `workspace/.mcp.json` and `workspace/CLAUDE.md` as its system prompt.\n\n## Key Conventions\n\n- **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed.\n- **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.\n- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`, `HasJsonDefaults`).\n\n## Running the App\n\n```bash\n./openfang.rb server        # Start web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # Start MCP server standalone\n```\n\n## Adding a New MCP Tool\n\n1. Create `fang/tools/my_tool.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:name).filled(:string).description('Argument description')\n        optional(:option).filled(:string).description('Optional argument')\n      end\n\n      def call(name:, option: nil)\n        # Tool logic here — all Fang:: models are available\n        { success: true, result: 'done' }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. The tool is auto-discovered.\n\n## Adding a Route/View\n\n1. Add route in `web/app.rb` following Roda `r.on` / `r.is` patterns\n2. Create ERB template in `web/views/`\n3. Add nav link in `web/views/layout.erb` sidebar `<nav>` section\n\n## Adding a Model\n\n1. Create migration in `workspace/migrations/YYYYMMDDNNNNNN_description.rb`:\n\n```ruby\nclass CreateThings < ActiveRecord::Migration[8.0]\n  def change\n    create_table :things do |t|\n      t.string :name, null: false\n      t.timestamps\n    end\n  end\nend\n```\n\n2. Create model in `fang/models/thing.rb`:\n\n```ruby\nmodule Fang\n  class Thing < ActiveRecord::Base\n    self.table_name = 'things'\n  end\nend\n```\n\n3. Run `./openfang.rb db:migrate`\n\n## Adding an API Client\n\n`Fang::ApplicationClient` (`fang/application_client.rb`) is a base HTTP client using `Net::HTTP`. Subclasses get their own `Response`, `Error`, `NotFound`, etc. classes automatically.\n\n1. Create `fang/clients/my_service_client.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Clients\n    class MyService < ApplicationClient\n      BASE_URI = \"https://api.myservice.com/v1\"\n\n      # Override if the API uses a different auth scheme\n      # def authorization_header = { \"X-API-Key\" => token }\n\n      def widgets\n        get(\"/widgets\")\n      rescue *NET_HTTP_ERRORS\n        raise Error, \"Unable to fetch widgets\"\n      end\n\n      def create_widget(name:)\n        post(\"/widgets\", body: { name: name })\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. Clients in `fang/clients/` are auto-loaded.\n\n### Key features\n\n- **HTTP methods**: `get`, `post`, `patch`, `put`, `delete` — all accept `headers:`, `query:`, `body:`, `form_data:`\n- **JSON by default**: Request bodies are serialized to JSON. Responses with `application/json` are parsed to `OpenStruct` for dot-access (e.g., `response.name`).\n- **Auth**: Pass `token:` on init. Override `authorization_header` for non-Bearer schemes.\n- **Error handling**: Raises typed errors (`NotFound`, `Unauthorized`, `RateLimit`, etc.). Rescue `*NET_HTTP_ERRORS` for network failures.\n- **Pagination**: `with_pagination(path) { |response| next_page_or_nil }` loops until the block returns nil.\n- **Custom response parsers**: Override per-client with `Response::PARSER[\"text/html\"] = ->(r) { Nokogiri::HTML(r.body) }`\n\n### Usage\n\n```ruby\nclient = Fang::Clients::MyService.new(token: ENV[\"MY_SERVICE_API_KEY\"])\nclient.widgets          # => Response with dot-access to parsed JSON\nclient.create_widget(name: \"Foo\")\n```\n\n## Design System\n\nClean, minimal shadcn/ui-inspired design with terminal green accent. Supports light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows.\n\n### CSS Tokens (defined in `web/public/css/style.css`)\n\nLight and dark mode tokens are defined as CSS custom properties. The `--fang-*` aliases are used by Tailwind classes.\n\n| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#c8ccd1` | `#1a1a1e` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#dde0e4` | `#242428` | Card backgrounds |\n| `--muted` | `#b8bcc2` | `#2e2e33` | Muted backgrounds |\n| `--muted-foreground` | `#4a5568` | `#9a9aaa` | Muted text |\n| `--primary` | `#16a34a` | `#16a34a` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#a8adb4` | `#3a3a40` | Borders |\n| `--ring` | `#16a34a` | `#16a34a` | Focus rings |\n\n### Components\n- **`.card`** — rounded card with subtle border and shadow\n- **`.badge`** — pill label (variants: `.success`, `.error`, `.warning`, `.info`)\n- **`button`** — green bg, rounded. Variants: `.ghost`, `.outline`, `.sm`, `.xs`, `.icon`\n- **`.chat-msg.user`** / **`.chat-msg.ai`** — rounded chat bubbles\n- **`.prose-bubble`** — markdown content inside chat bubbles\n- **`.section-heading`** — card section titles\n- **`.msg-meta`** — chat message metadata (small, uppercase, muted)\n- **`.notification-unread`** — unread notification left border accent\n- **`.nav-trigger`** — hamburger menu button\n- **`.notification-badge`** — small pill badge for notification counts\n\n### Rules\n- **No inline styles** — all styling via Tailwind utilities or CSS classes\n- **No `text-transform: uppercase`** on headings — use `font-semibold tracking-tight`\n\nTailwind CSS is loaded via CDN with custom colors: `fang-bg`, `fang-fg`, `fang-muted`, `fang-muted-fg`, `fang-accent`, `fang-accent-fg`, `fang-border`, `fang-card`, `fang-primary`, `fang-ring`.\n\n## Event System\n\n`Fang::EventBus` is a simple in-process pub/sub for decoupled automation. Call `EventBus.emit(\"event:name\", data)` to fire an event. Triggers and workflows listen for matching events.\n\n**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n\n**Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt.\n\n**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.\n\n## Key Files\n\n| File | Purpose |\n|---|---|\n| `openfang.rb` | CLI entrypoint |\n| `fang/bootstrap.rb` | Framework loader |\n| `fang/agent.rb` | Claude subprocess execution |\n| `fang/mcp_server.rb` | FastMCP tool/resource registration |\n| `fang/application_client.rb` | Base HTTP API client (subclass for new integrations) |\n| `fang/event_bus.rb` | In-process event pub/sub for triggers and workflows |\n| `web/app.rb` | All Roda routes |\n| `web/views/layout.erb` | Main layout with sidebar nav |\n| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n| `web/public/css/style.css` | Complete design system |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n\n## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |\n","structuredPatch":[{"oldStart":198,"oldLines":6,"newStart":198,"newLines":8,"lines":[" - `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`"," - `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`"," - `Notification#broadcast!` → `notification:created:*`","+- `WorkflowRunnerJob` → `workflow:completed:*` / `workflow:failed:*`","+- `Approval` → `approval:approved:*` / `approval:rejected:*` / `approval:expired:*`"," "," **Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt."," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"eabf0a08-0fdd-45ca-b4c8-451ba1da1221"}
{"parentUuid":"686e0a44-cfbb-40c2-9747-87bbff5e2690","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01TebCpCB8dSwkmPyrnpBiFw","type":"message","role":"assistant","content":[{"type":"text","text":"Update Workflow step types:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":387,"cache_read_input_tokens":43581,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":387},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQSRRxRaow9vVK3gBqd","type":"assistant","uuid":"1c691a67-76bf-4119-90c5-433060496b17","timestamp":"2026-02-21T02:12:53.344Z"}
{"parentUuid":"1c691a67-76bf-4119-90c5-433060496b17","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01TebCpCB8dSwkmPyrnpBiFw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PKiNtvsX62MZ5CgLnrGnkT","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/CLAUDE.md","old_string":"step types: `skill`, `prompt`, `condition`, `wait`, `notify`","new_string":"step types: `skill`, `prompt`, `condition`, `wait`, `notify`, `approval`"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":387,"cache_read_input_tokens":43581,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":387},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQSRRxRaow9vVK3gBqd","type":"assistant","uuid":"6973db13-250e-4219-ae7b-892bbefeee65","timestamp":"2026-02-21T02:12:54.810Z"}
{"parentUuid":"6973db13-250e-4219-ae7b-892bbefeee65","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01PKiNtvsX62MZ5CgLnrGnkT","toolUseID":"toolu_01PKiNtvsX62MZ5CgLnrGnkT","timestamp":"2026-02-21T02:12:54.817Z","uuid":"dcf3c99c-508e-475b-91f6-57b10d90a2bf"}
{"parentUuid":"6973db13-250e-4219-ae7b-892bbefeee65","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PKiNtvsX62MZ5CgLnrGnkT","type":"tool_result","content":"The file /home/greg/Developer/openfang/CLAUDE.md has been updated successfully."}]},"uuid":"f32f0952-bceb-41d2-944b-0b3b99884446","timestamp":"2026-02-21T02:12:54.816Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/CLAUDE.md","oldString":"step types: `skill`, `prompt`, `condition`, `wait`, `notify`","newString":"step types: `skill`, `prompt`, `condition`, `wait`, `notify`, `approval`","originalFile":"# OpenFang — Claude Code Guide\n\n## What This Is\n\nA personal AI assistant framework (\"OpenFang\") built in Ruby. It combines a Roda web UI, ActiveRecord models (SQLite), FastMCP tool server, and a Claude Code CLI subprocess as the agent runtime.\n\n## Architecture\n\n```\nopenfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb            Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n├── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n├── fang/computer_use/    Browser automation (Playwright)\n├── fang/document_parser.rb  Multi-format text extraction\n├── fang/python_runner.rb    Python virtualenv and execution\n└── fang/gmail.rb            Gmail OAuth2 integration\n```\n\n**Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process.\n\n**Agent execution**: When a user sends a message, `AgentExecutorJob` runs `Fang::Agent.execute`, which spawns a `claude` CLI subprocess with MCP tools. The subprocess uses `workspace/.mcp.json` and `workspace/CLAUDE.md` as its system prompt.\n\n## Key Conventions\n\n- **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed.\n- **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.\n- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`, `HasJsonDefaults`).\n\n## Running the App\n\n```bash\n./openfang.rb server        # Start web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # Start MCP server standalone\n```\n\n## Adding a New MCP Tool\n\n1. Create `fang/tools/my_tool.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:name).filled(:string).description('Argument description')\n        optional(:option).filled(:string).description('Optional argument')\n      end\n\n      def call(name:, option: nil)\n        # Tool logic here — all Fang:: models are available\n        { success: true, result: 'done' }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. The tool is auto-discovered.\n\n## Adding a Route/View\n\n1. Add route in `web/app.rb` following Roda `r.on` / `r.is` patterns\n2. Create ERB template in `web/views/`\n3. Add nav link in `web/views/layout.erb` sidebar `<nav>` section\n\n## Adding a Model\n\n1. Create migration in `workspace/migrations/YYYYMMDDNNNNNN_description.rb`:\n\n```ruby\nclass CreateThings < ActiveRecord::Migration[8.0]\n  def change\n    create_table :things do |t|\n      t.string :name, null: false\n      t.timestamps\n    end\n  end\nend\n```\n\n2. Create model in `fang/models/thing.rb`:\n\n```ruby\nmodule Fang\n  class Thing < ActiveRecord::Base\n    self.table_name = 'things'\n  end\nend\n```\n\n3. Run `./openfang.rb db:migrate`\n\n## Adding an API Client\n\n`Fang::ApplicationClient` (`fang/application_client.rb`) is a base HTTP client using `Net::HTTP`. Subclasses get their own `Response`, `Error`, `NotFound`, etc. classes automatically.\n\n1. Create `fang/clients/my_service_client.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Clients\n    class MyService < ApplicationClient\n      BASE_URI = \"https://api.myservice.com/v1\"\n\n      # Override if the API uses a different auth scheme\n      # def authorization_header = { \"X-API-Key\" => token }\n\n      def widgets\n        get(\"/widgets\")\n      rescue *NET_HTTP_ERRORS\n        raise Error, \"Unable to fetch widgets\"\n      end\n\n      def create_widget(name:)\n        post(\"/widgets\", body: { name: name })\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. Clients in `fang/clients/` are auto-loaded.\n\n### Key features\n\n- **HTTP methods**: `get`, `post`, `patch`, `put`, `delete` — all accept `headers:`, `query:`, `body:`, `form_data:`\n- **JSON by default**: Request bodies are serialized to JSON. Responses with `application/json` are parsed to `OpenStruct` for dot-access (e.g., `response.name`).\n- **Auth**: Pass `token:` on init. Override `authorization_header` for non-Bearer schemes.\n- **Error handling**: Raises typed errors (`NotFound`, `Unauthorized`, `RateLimit`, etc.). Rescue `*NET_HTTP_ERRORS` for network failures.\n- **Pagination**: `with_pagination(path) { |response| next_page_or_nil }` loops until the block returns nil.\n- **Custom response parsers**: Override per-client with `Response::PARSER[\"text/html\"] = ->(r) { Nokogiri::HTML(r.body) }`\n\n### Usage\n\n```ruby\nclient = Fang::Clients::MyService.new(token: ENV[\"MY_SERVICE_API_KEY\"])\nclient.widgets          # => Response with dot-access to parsed JSON\nclient.create_widget(name: \"Foo\")\n```\n\n## Design System\n\nClean, minimal shadcn/ui-inspired design with terminal green accent. Supports light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows.\n\n### CSS Tokens (defined in `web/public/css/style.css`)\n\nLight and dark mode tokens are defined as CSS custom properties. The `--fang-*` aliases are used by Tailwind classes.\n\n| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#c8ccd1` | `#1a1a1e` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#dde0e4` | `#242428` | Card backgrounds |\n| `--muted` | `#b8bcc2` | `#2e2e33` | Muted backgrounds |\n| `--muted-foreground` | `#4a5568` | `#9a9aaa` | Muted text |\n| `--primary` | `#16a34a` | `#16a34a` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#a8adb4` | `#3a3a40` | Borders |\n| `--ring` | `#16a34a` | `#16a34a` | Focus rings |\n\n### Components\n- **`.card`** — rounded card with subtle border and shadow\n- **`.badge`** — pill label (variants: `.success`, `.error`, `.warning`, `.info`)\n- **`button`** — green bg, rounded. Variants: `.ghost`, `.outline`, `.sm`, `.xs`, `.icon`\n- **`.chat-msg.user`** / **`.chat-msg.ai`** — rounded chat bubbles\n- **`.prose-bubble`** — markdown content inside chat bubbles\n- **`.section-heading`** — card section titles\n- **`.msg-meta`** — chat message metadata (small, uppercase, muted)\n- **`.notification-unread`** — unread notification left border accent\n- **`.nav-trigger`** — hamburger menu button\n- **`.notification-badge`** — small pill badge for notification counts\n\n### Rules\n- **No inline styles** — all styling via Tailwind utilities or CSS classes\n- **No `text-transform: uppercase`** on headings — use `font-semibold tracking-tight`\n\nTailwind CSS is loaded via CDN with custom colors: `fang-bg`, `fang-fg`, `fang-muted`, `fang-muted-fg`, `fang-accent`, `fang-accent-fg`, `fang-border`, `fang-card`, `fang-primary`, `fang-ring`.\n\n## Event System\n\n`Fang::EventBus` is a simple in-process pub/sub for decoupled automation. Call `EventBus.emit(\"event:name\", data)` to fire an event. Triggers and workflows listen for matching events.\n\n**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n- `WorkflowRunnerJob` → `workflow:completed:*` / `workflow:failed:*`\n- `Approval` → `approval:approved:*` / `approval:rejected:*` / `approval:expired:*`\n\n**Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt.\n\n**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.\n\n## Key Files\n\n| File | Purpose |\n|---|---|\n| `openfang.rb` | CLI entrypoint |\n| `fang/bootstrap.rb` | Framework loader |\n| `fang/agent.rb` | Claude subprocess execution |\n| `fang/mcp_server.rb` | FastMCP tool/resource registration |\n| `fang/application_client.rb` | Base HTTP API client (subclass for new integrations) |\n| `fang/event_bus.rb` | In-process event pub/sub for triggers and workflows |\n| `web/app.rb` | All Roda routes |\n| `web/views/layout.erb` | Main layout with sidebar nav |\n| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n| `web/public/css/style.css` | Complete design system |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n\n## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |\n","structuredPatch":[{"oldStart":203,"oldLines":7,"newStart":203,"newLines":7,"lines":[" "," **Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt."," ","-**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.","+**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`, `approval`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`."," "," ## Key Files"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"6973db13-250e-4219-ae7b-892bbefeee65"}
{"parentUuid":"f32f0952-bceb-41d2-944b-0b3b99884446","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Saq4RGa1PYPw9E37wch7hF","type":"message","role":"assistant","content":[{"type":"text","text":"Update Key Files table:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":358,"cache_read_input_tokens":43968,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":358},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQSiwQodzxWdYKBbbtc","type":"assistant","uuid":"00dabd0d-b450-498c-8ea6-92dbc3ebd865","timestamp":"2026-02-21T02:12:57.068Z"}
{"parentUuid":"00dabd0d-b450-498c-8ea6-92dbc3ebd865","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Saq4RGa1PYPw9E37wch7hF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GQv2psWP6XB5qFTtBVCAMC","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/CLAUDE.md","old_string":"| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |","new_string":"| `fang/skill_loader.rb` | Skill discovery and execution |\n| `fang/python_runner.rb` | Python virtualenv and code execution |\n| `fang/document_parser.rb` | Multi-format document text extraction |\n| `fang/gmail.rb` | Gmail OAuth2 integration |\n| `fang/whatsapp.rb` | WhatsApp message routing |\n| `fang/system_profile.rb` | Host system capability detection |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":358,"cache_read_input_tokens":43968,"output_tokens":327,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":358,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQSiwQodzxWdYKBbbtc","type":"assistant","uuid":"f4096647-90aa-4712-88c4-6884440fade7","timestamp":"2026-02-21T02:13:01.239Z"}
{"parentUuid":"f4096647-90aa-4712-88c4-6884440fade7","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01GQv2psWP6XB5qFTtBVCAMC","toolUseID":"toolu_01GQv2psWP6XB5qFTtBVCAMC","timestamp":"2026-02-21T02:13:01.264Z","uuid":"1d037e06-c84d-4579-ab7e-262872c9876d"}
{"parentUuid":"f4096647-90aa-4712-88c4-6884440fade7","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GQv2psWP6XB5qFTtBVCAMC","type":"tool_result","content":"The file /home/greg/Developer/openfang/CLAUDE.md has been updated successfully."}]},"uuid":"bec57aca-8ef6-4c03-b2e4-aaf375319890","timestamp":"2026-02-21T02:13:01.262Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/CLAUDE.md","oldString":"| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |","newString":"| `fang/skill_loader.rb` | Skill discovery and execution |\n| `fang/python_runner.rb` | Python virtualenv and code execution |\n| `fang/document_parser.rb` | Multi-format document text extraction |\n| `fang/gmail.rb` | Gmail OAuth2 integration |\n| `fang/whatsapp.rb` | WhatsApp message routing |\n| `fang/system_profile.rb` | Host system capability detection |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |","originalFile":"# OpenFang — Claude Code Guide\n\n## What This Is\n\nA personal AI assistant framework (\"OpenFang\") built in Ruby. It combines a Roda web UI, ActiveRecord models (SQLite), FastMCP tool server, and a Claude Code CLI subprocess as the agent runtime.\n\n## Architecture\n\n```\nopenfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb            Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n├── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n├── fang/computer_use/    Browser automation (Playwright)\n├── fang/document_parser.rb  Multi-format text extraction\n├── fang/python_runner.rb    Python virtualenv and execution\n└── fang/gmail.rb            Gmail OAuth2 integration\n```\n\n**Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process.\n\n**Agent execution**: When a user sends a message, `AgentExecutorJob` runs `Fang::Agent.execute`, which spawns a `claude` CLI subprocess with MCP tools. The subprocess uses `workspace/.mcp.json` and `workspace/CLAUDE.md` as its system prompt.\n\n## Key Conventions\n\n- **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed.\n- **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.\n- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`, `HasJsonDefaults`).\n\n## Running the App\n\n```bash\n./openfang.rb server        # Start web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # Start MCP server standalone\n```\n\n## Adding a New MCP Tool\n\n1. Create `fang/tools/my_tool.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:name).filled(:string).description('Argument description')\n        optional(:option).filled(:string).description('Optional argument')\n      end\n\n      def call(name:, option: nil)\n        # Tool logic here — all Fang:: models are available\n        { success: true, result: 'done' }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. The tool is auto-discovered.\n\n## Adding a Route/View\n\n1. Add route in `web/app.rb` following Roda `r.on` / `r.is` patterns\n2. Create ERB template in `web/views/`\n3. Add nav link in `web/views/layout.erb` sidebar `<nav>` section\n\n## Adding a Model\n\n1. Create migration in `workspace/migrations/YYYYMMDDNNNNNN_description.rb`:\n\n```ruby\nclass CreateThings < ActiveRecord::Migration[8.0]\n  def change\n    create_table :things do |t|\n      t.string :name, null: false\n      t.timestamps\n    end\n  end\nend\n```\n\n2. Create model in `fang/models/thing.rb`:\n\n```ruby\nmodule Fang\n  class Thing < ActiveRecord::Base\n    self.table_name = 'things'\n  end\nend\n```\n\n3. Run `./openfang.rb db:migrate`\n\n## Adding an API Client\n\n`Fang::ApplicationClient` (`fang/application_client.rb`) is a base HTTP client using `Net::HTTP`. Subclasses get their own `Response`, `Error`, `NotFound`, etc. classes automatically.\n\n1. Create `fang/clients/my_service_client.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Clients\n    class MyService < ApplicationClient\n      BASE_URI = \"https://api.myservice.com/v1\"\n\n      # Override if the API uses a different auth scheme\n      # def authorization_header = { \"X-API-Key\" => token }\n\n      def widgets\n        get(\"/widgets\")\n      rescue *NET_HTTP_ERRORS\n        raise Error, \"Unable to fetch widgets\"\n      end\n\n      def create_widget(name:)\n        post(\"/widgets\", body: { name: name })\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. Clients in `fang/clients/` are auto-loaded.\n\n### Key features\n\n- **HTTP methods**: `get`, `post`, `patch`, `put`, `delete` — all accept `headers:`, `query:`, `body:`, `form_data:`\n- **JSON by default**: Request bodies are serialized to JSON. Responses with `application/json` are parsed to `OpenStruct` for dot-access (e.g., `response.name`).\n- **Auth**: Pass `token:` on init. Override `authorization_header` for non-Bearer schemes.\n- **Error handling**: Raises typed errors (`NotFound`, `Unauthorized`, `RateLimit`, etc.). Rescue `*NET_HTTP_ERRORS` for network failures.\n- **Pagination**: `with_pagination(path) { |response| next_page_or_nil }` loops until the block returns nil.\n- **Custom response parsers**: Override per-client with `Response::PARSER[\"text/html\"] = ->(r) { Nokogiri::HTML(r.body) }`\n\n### Usage\n\n```ruby\nclient = Fang::Clients::MyService.new(token: ENV[\"MY_SERVICE_API_KEY\"])\nclient.widgets          # => Response with dot-access to parsed JSON\nclient.create_widget(name: \"Foo\")\n```\n\n## Design System\n\nClean, minimal shadcn/ui-inspired design with terminal green accent. Supports light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows.\n\n### CSS Tokens (defined in `web/public/css/style.css`)\n\nLight and dark mode tokens are defined as CSS custom properties. The `--fang-*` aliases are used by Tailwind classes.\n\n| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#c8ccd1` | `#1a1a1e` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#dde0e4` | `#242428` | Card backgrounds |\n| `--muted` | `#b8bcc2` | `#2e2e33` | Muted backgrounds |\n| `--muted-foreground` | `#4a5568` | `#9a9aaa` | Muted text |\n| `--primary` | `#16a34a` | `#16a34a` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#a8adb4` | `#3a3a40` | Borders |\n| `--ring` | `#16a34a` | `#16a34a` | Focus rings |\n\n### Components\n- **`.card`** — rounded card with subtle border and shadow\n- **`.badge`** — pill label (variants: `.success`, `.error`, `.warning`, `.info`)\n- **`button`** — green bg, rounded. Variants: `.ghost`, `.outline`, `.sm`, `.xs`, `.icon`\n- **`.chat-msg.user`** / **`.chat-msg.ai`** — rounded chat bubbles\n- **`.prose-bubble`** — markdown content inside chat bubbles\n- **`.section-heading`** — card section titles\n- **`.msg-meta`** — chat message metadata (small, uppercase, muted)\n- **`.notification-unread`** — unread notification left border accent\n- **`.nav-trigger`** — hamburger menu button\n- **`.notification-badge`** — small pill badge for notification counts\n\n### Rules\n- **No inline styles** — all styling via Tailwind utilities or CSS classes\n- **No `text-transform: uppercase`** on headings — use `font-semibold tracking-tight`\n\nTailwind CSS is loaded via CDN with custom colors: `fang-bg`, `fang-fg`, `fang-muted`, `fang-muted-fg`, `fang-accent`, `fang-accent-fg`, `fang-border`, `fang-card`, `fang-primary`, `fang-ring`.\n\n## Event System\n\n`Fang::EventBus` is a simple in-process pub/sub for decoupled automation. Call `EventBus.emit(\"event:name\", data)` to fire an event. Triggers and workflows listen for matching events.\n\n**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n- `WorkflowRunnerJob` → `workflow:completed:*` / `workflow:failed:*`\n- `Approval` → `approval:approved:*` / `approval:rejected:*` / `approval:expired:*`\n\n**Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt.\n\n**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`, `approval`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.\n\n## Key Files\n\n| File | Purpose |\n|---|---|\n| `openfang.rb` | CLI entrypoint |\n| `fang/bootstrap.rb` | Framework loader |\n| `fang/agent.rb` | Claude subprocess execution |\n| `fang/mcp_server.rb` | FastMCP tool/resource registration |\n| `fang/application_client.rb` | Base HTTP API client (subclass for new integrations) |\n| `fang/event_bus.rb` | In-process event pub/sub for triggers and workflows |\n| `web/app.rb` | All Roda routes |\n| `web/views/layout.erb` | Main layout with sidebar nav |\n| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n| `web/public/css/style.css` | Complete design system |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n\n## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |\n","structuredPatch":[{"oldStart":220,"oldLines":6,"newStart":220,"newLines":12,"lines":[" | `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |"," | `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |"," | `web/public/css/style.css` | Complete design system |","+| `fang/skill_loader.rb` | Skill discovery and execution |","+| `fang/python_runner.rb` | Python virtualenv and code execution |","+| `fang/document_parser.rb` | Multi-format document text extraction |","+| `fang/gmail.rb` | Gmail OAuth2 integration |","+| `fang/whatsapp.rb` | WhatsApp message routing |","+| `fang/system_profile.rb` | Host system capability detection |"," | `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |"," | `workspace/.mcp.json` | MCP config passed to claude subprocess |"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"f4096647-90aa-4712-88c4-6884440fade7"}
{"parentUuid":"bec57aca-8ef6-4c03-b2e4-aaf375319890","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_016steJQocGbefrwSowjB6Eh","type":"message","role":"assistant","content":[{"type":"text","text":"Now replace the MCP Tools table with the complete list:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":360,"cache_read_input_tokens":44326,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":360},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQTC7HsAm9S65XVbXVh","type":"assistant","uuid":"be57d377-4240-421f-af05-2643b2dfba79","timestamp":"2026-02-21T02:13:03.382Z"}
{"parentUuid":"be57d377-4240-421f-af05-2643b2dfba79","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_016steJQocGbefrwSowjB6Eh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014ZAAGCtMAbruMwz72xUpTo","name":"Edit","input":{"replace_all":false,"file_path":"/home/greg/Developer/openfang/CLAUDE.md","old_string":"## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |","new_string":"## Existing MCP Tools (38 total)\n\nAll tools live in `fang/tools/` and are auto-discovered via ObjectSpace.\n\n| Category | Tool | Purpose |\n|---|---|---|\n| **Core** | `run_code` | Execute Ruby code with model access |\n| | `run_skill` | Execute saved skills by name |\n| | `manage_python` | Run Python code, manage virtualenv and dependencies |\n| | `send_message` | Send message + broadcast via SSE |\n| **Scheduling** | `schedule_task` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| **Pages & Canvas** | `create_page` | Create Page (appears in nav) |\n| | `get_canvas` | Read current page's widget layout |\n| | `update_canvas` | Set page HTML content |\n| | `add_canvas_component` | Add a widget to the canvas |\n| | `update_canvas_component` | Modify a widget's position/content/data |\n| | `remove_canvas_component` | Remove a widget |\n| | `define_widget` | Create a new widget type (writes Ruby to disk) |\n| **Documents** | `create_document` | Upload or generate a document |\n| | `read_document` | Read extracted text from a document |\n| | `list_documents` | List documents in a conversation |\n| **Data Tables** | `create_data_table` | Create a dynamic SQLite table with custom schema |\n| | `list_data_tables` | List all dynamic data tables |\n| | `query_data_table` | Query records with filtering and sorting |\n| | `insert_data_record` | Insert a row into a data table |\n| | `update_data_record` | Update a row in a data table |\n| | `delete_data_record` | Delete a row from a data table |\n| **Approvals** | `create_approval` | Create a human-in-the-loop approval gate |\n| | `list_approvals` | List pending and resolved approvals |\n| | `resolve_approval` | Approve or reject a pending approval |\n| **Automation** | `create_notification` | Create + broadcast notification |\n| | `create_trigger` | Create event trigger (fires skill/prompt on matching event) |\n| | `create_workflow` | Create multi-step workflow pipeline |\n| | `create_heartbeat` | Set up a token-efficient monitor |\n| | `update_heartbeat` | Modify a heartbeat's config |\n| | `list_heartbeats` | View all heartbeats and their stats |\n| **Web** | `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| | `start_computer_use` | Launch a browser automation session |\n| **Gmail** | `gmail_search` | Search Gmail messages |\n| | `gmail_read` | Read a Gmail message by ID |\n| | `gmail_send` | Send an email via Gmail |\n| | `gmail_draft` | Create a Gmail draft |\n| | `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |\n| | `gmail_labels` | List available Gmail labels |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":360,"cache_read_input_tokens":44326,"output_tokens":1161,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":360,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQTC7HsAm9S65XVbXVh","type":"assistant","uuid":"9f9b0737-59f3-4922-bbaa-21ddbc316c65","timestamp":"2026-02-21T02:13:19.719Z"}
{"parentUuid":"9f9b0737-59f3-4922-bbaa-21ddbc316c65","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_014ZAAGCtMAbruMwz72xUpTo","toolUseID":"toolu_014ZAAGCtMAbruMwz72xUpTo","timestamp":"2026-02-21T02:13:19.726Z","uuid":"0d56f7b8-3ce6-4042-b3b7-254fb91ec46e"}
{"parentUuid":"9f9b0737-59f3-4922-bbaa-21ddbc316c65","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014ZAAGCtMAbruMwz72xUpTo","type":"tool_result","content":"The file /home/greg/Developer/openfang/CLAUDE.md has been updated successfully."}]},"uuid":"fde5bc74-09bf-4faf-a616-3d2bf64412a8","timestamp":"2026-02-21T02:13:19.725Z","toolUseResult":{"filePath":"/home/greg/Developer/openfang/CLAUDE.md","oldString":"## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |","newString":"## Existing MCP Tools (38 total)\n\nAll tools live in `fang/tools/` and are auto-discovered via ObjectSpace.\n\n| Category | Tool | Purpose |\n|---|---|---|\n| **Core** | `run_code` | Execute Ruby code with model access |\n| | `run_skill` | Execute saved skills by name |\n| | `manage_python` | Run Python code, manage virtualenv and dependencies |\n| | `send_message` | Send message + broadcast via SSE |\n| **Scheduling** | `schedule_task` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| **Pages & Canvas** | `create_page` | Create Page (appears in nav) |\n| | `get_canvas` | Read current page's widget layout |\n| | `update_canvas` | Set page HTML content |\n| | `add_canvas_component` | Add a widget to the canvas |\n| | `update_canvas_component` | Modify a widget's position/content/data |\n| | `remove_canvas_component` | Remove a widget |\n| | `define_widget` | Create a new widget type (writes Ruby to disk) |\n| **Documents** | `create_document` | Upload or generate a document |\n| | `read_document` | Read extracted text from a document |\n| | `list_documents` | List documents in a conversation |\n| **Data Tables** | `create_data_table` | Create a dynamic SQLite table with custom schema |\n| | `list_data_tables` | List all dynamic data tables |\n| | `query_data_table` | Query records with filtering and sorting |\n| | `insert_data_record` | Insert a row into a data table |\n| | `update_data_record` | Update a row in a data table |\n| | `delete_data_record` | Delete a row from a data table |\n| **Approvals** | `create_approval` | Create a human-in-the-loop approval gate |\n| | `list_approvals` | List pending and resolved approvals |\n| | `resolve_approval` | Approve or reject a pending approval |\n| **Automation** | `create_notification` | Create + broadcast notification |\n| | `create_trigger` | Create event trigger (fires skill/prompt on matching event) |\n| | `create_workflow` | Create multi-step workflow pipeline |\n| | `create_heartbeat` | Set up a token-efficient monitor |\n| | `update_heartbeat` | Modify a heartbeat's config |\n| | `list_heartbeats` | View all heartbeats and their stats |\n| **Web** | `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| | `start_computer_use` | Launch a browser automation session |\n| **Gmail** | `gmail_search` | Search Gmail messages |\n| | `gmail_read` | Read a Gmail message by ID |\n| | `gmail_send` | Send an email via Gmail |\n| | `gmail_draft` | Create a Gmail draft |\n| | `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |\n| | `gmail_labels` | List available Gmail labels |","originalFile":"# OpenFang — Claude Code Guide\n\n## What This Is\n\nA personal AI assistant framework (\"OpenFang\") built in Ruby. It combines a Roda web UI, ActiveRecord models (SQLite), FastMCP tool server, and a Claude Code CLI subprocess as the agent runtime.\n\n## Architecture\n\n```\nopenfang.rb (entrypoint) → Fang::CLI (Thor)\n├── web/app.rb            Roda web server (port 3000)\n├── fang/mcp_server.rb    FastMCP tool server (port 9292)\n├── fang/agent.rb         Spawns `claude` CLI subprocess per conversation\n├── fang/bootstrap.rb     Loads everything, connects DB\n├── fang/scheduler.rb     Rufus-scheduler for recurring tasks\n├── fang/computer_use/    Browser automation (Playwright)\n├── fang/document_parser.rb  Multi-format text extraction\n├── fang/python_runner.rb    Python virtualenv and execution\n└── fang/gmail.rb            Gmail OAuth2 integration\n```\n\n**Real-time updates**: In-memory pub/sub (`web/turbo_broadcast.rb`) → SSE → Turbo Streams in the browser. No ActionCable or Redis needed — everything runs in one process.\n\n**Agent execution**: When a user sends a message, `AgentExecutorJob` runs `Fang::Agent.execute`, which spawns a `claude` CLI subprocess with MCP tools. The subprocess uses `workspace/.mcp.json` and `workspace/CLAUDE.md` as its system prompt.\n\n## Key Conventions\n\n- **Auto-discovery via ObjectSpace**: MCP tools (`fang/tools/`) and resources (`fang/resources/`) are auto-registered by scanning for subclasses of `FastMcp::Tool` and `FastMcp::Resource`. Just create the file — no manual registration needed.\n- **No index pages for content types**: When the AI creates a new page/content type, add a direct link to it in the nav bar (`web/views/layout.erb`) instead of creating a separate listing page. Each page is served at `/pages/:slug`.\n- **Models use concerns**: Shared behavior lives in `fang/concerns/` (e.g., `HasStatus`, `HasJsonDefaults`).\n\n## Running the App\n\n```bash\n./openfang.rb server        # Start web UI on port 3000\n./openfang.rb console       # IRB with all models loaded\n./openfang.rb db:migrate    # Run pending migrations\n./openfang.rb mcp           # Start MCP server standalone\n```\n\n## Adding a New MCP Tool\n\n1. Create `fang/tools/my_tool.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Tools\n    class MyTool < FastMcp::Tool\n      tool_name 'my_tool'\n      description 'What this tool does'\n\n      arguments do\n        required(:name).filled(:string).description('Argument description')\n        optional(:option).filled(:string).description('Optional argument')\n      end\n\n      def call(name:, option: nil)\n        # Tool logic here — all Fang:: models are available\n        { success: true, result: 'done' }\n      rescue => e\n        { success: false, error: e.message }\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. The tool is auto-discovered.\n\n## Adding a Route/View\n\n1. Add route in `web/app.rb` following Roda `r.on` / `r.is` patterns\n2. Create ERB template in `web/views/`\n3. Add nav link in `web/views/layout.erb` sidebar `<nav>` section\n\n## Adding a Model\n\n1. Create migration in `workspace/migrations/YYYYMMDDNNNNNN_description.rb`:\n\n```ruby\nclass CreateThings < ActiveRecord::Migration[8.0]\n  def change\n    create_table :things do |t|\n      t.string :name, null: false\n      t.timestamps\n    end\n  end\nend\n```\n\n2. Create model in `fang/models/thing.rb`:\n\n```ruby\nmodule Fang\n  class Thing < ActiveRecord::Base\n    self.table_name = 'things'\n  end\nend\n```\n\n3. Run `./openfang.rb db:migrate`\n\n## Adding an API Client\n\n`Fang::ApplicationClient` (`fang/application_client.rb`) is a base HTTP client using `Net::HTTP`. Subclasses get their own `Response`, `Error`, `NotFound`, etc. classes automatically.\n\n1. Create `fang/clients/my_service_client.rb`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Fang\n  module Clients\n    class MyService < ApplicationClient\n      BASE_URI = \"https://api.myservice.com/v1\"\n\n      # Override if the API uses a different auth scheme\n      # def authorization_header = { \"X-API-Key\" => token }\n\n      def widgets\n        get(\"/widgets\")\n      rescue *NET_HTTP_ERRORS\n        raise Error, \"Unable to fetch widgets\"\n      end\n\n      def create_widget(name:)\n        post(\"/widgets\", body: { name: name })\n      end\n    end\n  end\nend\n```\n\n2. Restart the server. Clients in `fang/clients/` are auto-loaded.\n\n### Key features\n\n- **HTTP methods**: `get`, `post`, `patch`, `put`, `delete` — all accept `headers:`, `query:`, `body:`, `form_data:`\n- **JSON by default**: Request bodies are serialized to JSON. Responses with `application/json` are parsed to `OpenStruct` for dot-access (e.g., `response.name`).\n- **Auth**: Pass `token:` on init. Override `authorization_header` for non-Bearer schemes.\n- **Error handling**: Raises typed errors (`NotFound`, `Unauthorized`, `RateLimit`, etc.). Rescue `*NET_HTTP_ERRORS` for network failures.\n- **Pagination**: `with_pagination(path) { |response| next_page_or_nil }` loops until the block returns nil.\n- **Custom response parsers**: Override per-client with `Response::PARSER[\"text/html\"] = ->(r) { Nokogiri::HTML(r.body) }`\n\n### Usage\n\n```ruby\nclient = Fang::Clients::MyService.new(token: ENV[\"MY_SERVICE_API_KEY\"])\nclient.widgets          # => Response with dot-access to parsed JSON\nclient.create_widget(name: \"Foo\")\n```\n\n## Design System\n\nClean, minimal shadcn/ui-inspired design with terminal green accent. Supports light/dark mode via `prefers-color-scheme`. Inter font, rounded corners, subtle shadows.\n\n### CSS Tokens (defined in `web/public/css/style.css`)\n\nLight and dark mode tokens are defined as CSS custom properties. The `--fang-*` aliases are used by Tailwind classes.\n\n| Token | Light | Dark | Usage |\n|---|---|---|---|\n| `--background` | `#c8ccd1` | `#1a1a1e` | Page background |\n| `--foreground` | `#0f172a` | `#fafafa` | Primary text |\n| `--card` | `#dde0e4` | `#242428` | Card backgrounds |\n| `--muted` | `#b8bcc2` | `#2e2e33` | Muted backgrounds |\n| `--muted-foreground` | `#4a5568` | `#9a9aaa` | Muted text |\n| `--primary` | `#16a34a` | `#16a34a` | Accent (green) |\n| `--primary-foreground` | `#ffffff` | `#ffffff` | Text on accent |\n| `--border` | `#a8adb4` | `#3a3a40` | Borders |\n| `--ring` | `#16a34a` | `#16a34a` | Focus rings |\n\n### Components\n- **`.card`** — rounded card with subtle border and shadow\n- **`.badge`** — pill label (variants: `.success`, `.error`, `.warning`, `.info`)\n- **`button`** — green bg, rounded. Variants: `.ghost`, `.outline`, `.sm`, `.xs`, `.icon`\n- **`.chat-msg.user`** / **`.chat-msg.ai`** — rounded chat bubbles\n- **`.prose-bubble`** — markdown content inside chat bubbles\n- **`.section-heading`** — card section titles\n- **`.msg-meta`** — chat message metadata (small, uppercase, muted)\n- **`.notification-unread`** — unread notification left border accent\n- **`.nav-trigger`** — hamburger menu button\n- **`.notification-badge`** — small pill badge for notification counts\n\n### Rules\n- **No inline styles** — all styling via Tailwind utilities or CSS classes\n- **No `text-transform: uppercase`** on headings — use `font-semibold tracking-tight`\n\nTailwind CSS is loaded via CDN with custom colors: `fang-bg`, `fang-fg`, `fang-muted`, `fang-muted-fg`, `fang-accent`, `fang-accent-fg`, `fang-border`, `fang-card`, `fang-primary`, `fang-ring`.\n\n## Event System\n\n`Fang::EventBus` is a simple in-process pub/sub for decoupled automation. Call `EventBus.emit(\"event:name\", data)` to fire an event. Triggers and workflows listen for matching events.\n\n**Emit points** are wired into:\n- `ScheduledTaskRunnerJob` → `task:completed:*` / `task:failed:*`\n- `HeartbeatRunnerJob` → `heartbeat:escalated:*` / `heartbeat:error:*`\n- `Notification#broadcast!` → `notification:created:*`\n- `WorkflowRunnerJob` → `workflow:completed:*` / `workflow:failed:*`\n- `Approval` → `approval:approved:*` / `approval:rejected:*` / `approval:expired:*`\n\n**Triggers** (`fang/models/trigger.rb`) match events via glob patterns and fire a skill or prompt.\n\n**Workflows** (`fang/models/workflow.rb`) are multi-step pipelines with step types: `skill`, `prompt`, `condition`, `wait`, `notify`, `approval`. Steps pass data via a JSON context hash with `{{context.step_name}}` interpolation. Workflows can auto-start on a `trigger_event`.\n\n## Key Files\n\n| File | Purpose |\n|---|---|\n| `openfang.rb` | CLI entrypoint |\n| `fang/bootstrap.rb` | Framework loader |\n| `fang/agent.rb` | Claude subprocess execution |\n| `fang/mcp_server.rb` | FastMCP tool/resource registration |\n| `fang/application_client.rb` | Base HTTP API client (subclass for new integrations) |\n| `fang/event_bus.rb` | In-process event pub/sub for triggers and workflows |\n| `web/app.rb` | All Roda routes |\n| `web/views/layout.erb` | Main layout with sidebar nav |\n| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n| `web/public/css/style.css` | Complete design system |\n| `fang/skill_loader.rb` | Skill discovery and execution |\n| `fang/python_runner.rb` | Python virtualenv and code execution |\n| `fang/document_parser.rb` | Multi-format document text extraction |\n| `fang/gmail.rb` | Gmail OAuth2 integration |\n| `fang/whatsapp.rb` | WhatsApp message routing |\n| `fang/system_profile.rb` | Host system capability detection |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n\n## Existing MCP Tools\n\n| Tool | File | Purpose |\n|---|---|---|\n| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |\n| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |\n| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |\n| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |\n| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |\n| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |\n| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |\n","structuredPatch":[{"oldStart":229,"oldLines":15,"newStart":229,"newLines":47,"lines":[" | `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |"," | `workspace/.mcp.json` | MCP config passed to claude subprocess |"," ","-## Existing MCP Tools","+## Existing MCP Tools (38 total)"," ","-| Tool | File | Purpose |","+All tools live in `fang/tools/` and are auto-discovered via ObjectSpace.","+","+| Category | Tool | Purpose |"," |---|---|---|","-| `run_code` | `fang/tools/run_code_tool.rb` | Execute Ruby code with model access |","-| `run_skill` | `fang/tools/run_skill_tool.rb` | Execute saved skills by name |","-| `send_message` | `fang/tools/send_message_tool.rb` | Send message + broadcast via SSE |","-| `schedule_task` | `fang/tools/schedule_task_tool.rb` | Schedule future tasks/reminders (supports `cron:` for recurring) |","-| `create_page` | `fang/tools/create_page_tool.rb` | Create Page (appears in nav) |","-| `create_notification` | `fang/tools/create_notification_tool.rb` | Create + broadcast notification |","-| `create_trigger` | `fang/tools/create_trigger_tool.rb` | Create event trigger (fires skill/prompt on matching event) |","-| `create_workflow` | `fang/tools/create_workflow_tool.rb` | Create multi-step workflow pipeline |","+| **Core** | `run_code` | Execute Ruby code with model access |","+| | `run_skill` | Execute saved skills by name |","+| | `manage_python` | Run Python code, manage virtualenv and dependencies |","+| | `send_message` | Send message + broadcast via SSE |","+| **Scheduling** | `schedule_task` | Schedule future tasks/reminders (supports `cron:` for recurring) |","+| **Pages & Canvas** | `create_page` | Create Page (appears in nav) |","+| | `get_canvas` | Read current page's widget layout |","+| | `update_canvas` | Set page HTML content |","+| | `add_canvas_component` | Add a widget to the canvas |","+| | `update_canvas_component` | Modify a widget's position/content/data |","+| | `remove_canvas_component` | Remove a widget |","+| | `define_widget` | Create a new widget type (writes Ruby to disk) |","+| **Documents** | `create_document` | Upload or generate a document |","+| | `read_document` | Read extracted text from a document |","+| | `list_documents` | List documents in a conversation |","+| **Data Tables** | `create_data_table` | Create a dynamic SQLite table with custom schema |","+| | `list_data_tables` | List all dynamic data tables |","+| | `query_data_table` | Query records with filtering and sorting |","+| | `insert_data_record` | Insert a row into a data table |","+| | `update_data_record` | Update a row in a data table |","+| | `delete_data_record` | Delete a row from a data table |","+| **Approvals** | `create_approval` | Create a human-in-the-loop approval gate |","+| | `list_approvals` | List pending and resolved approvals |","+| | `resolve_approval` | Approve or reject a pending approval |","+| **Automation** | `create_notification` | Create + broadcast notification |","+| | `create_trigger` | Create event trigger (fires skill/prompt on matching event) |","+| | `create_workflow` | Create multi-step workflow pipeline |","+| | `create_heartbeat` | Set up a token-efficient monitor |","+| | `update_heartbeat` | Modify a heartbeat's config |","+| | `list_heartbeats` | View all heartbeats and their stats |","+| **Web** | `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |","+| | `start_computer_use` | Launch a browser automation session |","+| **Gmail** | `gmail_search` | Search Gmail messages |","+| | `gmail_read` | Read a Gmail message by ID |","+| | `gmail_send` | Send an email via Gmail |","+| | `gmail_draft` | Create a Gmail draft |","+| | `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |","+| | `gmail_labels` | List available Gmail labels |"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"9f9b0737-59f3-4922-bbaa-21ddbc316c65"}
{"parentUuid":"fde5bc74-09bf-4faf-a616-3d2bf64412a8","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_012Wp7PHXku1FXchUzWfp7Gd","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me verify both files look correct:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1194,"cache_read_input_tokens":44686,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1194},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQUahsMpKTD5cxt9u1D","type":"assistant","uuid":"3d6c2c35-0a2a-4547-ae47-dd6312d3f462","timestamp":"2026-02-21T02:13:22.733Z"}
{"parentUuid":"3d6c2c35-0a2a-4547-ae47-dd6312d3f462","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_012Wp7PHXku1FXchUzWfp7Gd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N3wcZEpQPCwAetUoanWtCw","name":"Bash","input":{"command":"grep -n \"18 \" /home/greg/Developer/openfang/README.md /home/greg/Developer/openfang/CLAUDE.md 2>/dev/null | grep -i tool","description":"Check for any remaining \"18 tools\" references"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1194,"cache_read_input_tokens":44686,"output_tokens":134,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":1194,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQUahsMpKTD5cxt9u1D","type":"assistant","uuid":"7536f5b6-607e-4062-bdb6-ca69ec38fa8d","timestamp":"2026-02-21T02:13:23.660Z"}
{"parentUuid":"7536f5b6-607e-4062-bdb6-ca69ec38fa8d","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N3wcZEpQPCwAetUoanWtCw","type":"tool_result","content":"","is_error":false}]},"uuid":"5a22e242-2a9b-493f-9b87-9539cd143a57","timestamp":"2026-02-21T02:13:23.749Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false,"returnCodeInterpretation":"No matches found","noOutputExpected":false},"sourceToolAssistantUUID":"7536f5b6-607e-4062-bdb6-ca69ec38fa8d"}
{"parentUuid":"5a22e242-2a9b-493f-9b87-9539cd143a57","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01CFJfdwSgNJFZWPp2M7JtaR","type":"message","role":"assistant","content":[{"type":"text","text":"No stale \"18 tools\" references remain. Let me do a final verification of the tool count in the CLAUDE.md table:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":160,"cache_read_input_tokens":45880,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":160},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQUrTuReTxiNLRnkwUD","type":"assistant","uuid":"36480565-616d-410d-b674-2535266c2be0","timestamp":"2026-02-21T02:13:27.165Z"}
{"parentUuid":"36480565-616d-410d-b674-2535266c2be0","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01CFJfdwSgNJFZWPp2M7JtaR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U6QUA4n9t5WhCgPVgsTwKn","name":"Bash","input":{"command":"grep -c '^\\| |' /home/greg/Developer/openfang/CLAUDE.md; grep -c '^\\| \\*\\*' /home/greg/Developer/openfang/CLAUDE.md","description":"Count tool entries in CLAUDE.md table"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":160,"cache_read_input_tokens":45880,"output_tokens":156,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":160,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQUrTuReTxiNLRnkwUD","type":"assistant","uuid":"402cb77b-c5a9-4870-9944-881ee0963b29","timestamp":"2026-02-21T02:13:28.468Z"}
{"parentUuid":"402cb77b-c5a9-4870-9944-881ee0963b29","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U6QUA4n9t5WhCgPVgsTwKn","type":"tool_result","content":"275\n275","is_error":false}]},"uuid":"ec4e7b72-d8c5-4bd6-b0f1-66878e43e29e","timestamp":"2026-02-21T02:13:28.548Z","toolUseResult":{"stdout":"275\n275","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"402cb77b-c5a9-4870-9944-881ee0963b29"}
{"parentUuid":"ec4e7b72-d8c5-4bd6-b0f1-66878e43e29e","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01ADMWzsup4USKT8FkrcXrQg","type":"message","role":"assistant","content":[{"type":"text","text":"That's matching all table rows — let me count more precisely:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":46040,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":171},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQVE9PAYaYrNcQL6kYg","type":"assistant","uuid":"3db4f80c-0d84-49e4-ac8c-3c4978fdc432","timestamp":"2026-02-21T02:13:32.050Z"}
{"parentUuid":"3db4f80c-0d84-49e4-ac8c-3c4978fdc432","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01ADMWzsup4USKT8FkrcXrQg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UzN6HPj4bodtW8c6Wm1Dtr","name":"Grep","input":{"pattern":"^\\| .* \\| `[a-z_]+` \\|","path":"/home/greg/Developer/openfang/CLAUDE.md","output_mode":"count"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":46040,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":171},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQVE9PAYaYrNcQL6kYg","type":"assistant","uuid":"52dee3bd-1374-4844-8ebb-80a4f149b789","timestamp":"2026-02-21T02:13:32.789Z"}
{"parentUuid":"52dee3bd-1374-4844-8ebb-80a4f149b789","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01UzN6HPj4bodtW8c6Wm1Dtr","toolUseID":"toolu_01UzN6HPj4bodtW8c6Wm1Dtr","timestamp":"2026-02-21T02:13:32.895Z","uuid":"f19f1941-4d75-42e0-9c03-55bd30f40ccd"}
{"parentUuid":"52dee3bd-1374-4844-8ebb-80a4f149b789","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UzN6HPj4bodtW8c6Wm1Dtr","type":"tool_result","content":"9\n\nFound 0 total occurrences across 0 files."}]},"uuid":"b8041043-018a-4df2-9727-0ab36c82c4eb","timestamp":"2026-02-21T02:13:32.893Z","toolUseResult":{"mode":"count","numFiles":0,"filenames":[],"content":"9","numMatches":0},"sourceToolAssistantUUID":"52dee3bd-1374-4844-8ebb-80a4f149b789"}
{"parentUuid":"b8041043-018a-4df2-9727-0ab36c82c4eb","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Kz6nS4ADCdiRmEsZGTE7B5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013wDurT3EMq12aizeyZVPWo","name":"Grep","input":{"pattern":"`(run_code|run_skill|manage_python|send_message|schedule_task|create_page|get_canvas|update_canvas|add_canvas|update_canvas_component|remove_canvas|define_widget|create_document|read_document|list_documents|create_data_table|list_data_tables|query_data_table|insert_data_record|update_data_record|delete_data_record|create_approval|list_approvals|resolve_approval|create_notification|create_trigger|create_workflow|create_heartbeat|update_heartbeat|list_heartbeats|web_fetch|start_computer_use|gmail_search|gmail_read|gmail_send|gmail_draft|gmail_modify|gmail_labels)`","path":"/home/greg/Developer/openfang/CLAUDE.md","output_mode":"count"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":315,"cache_read_input_tokens":46211,"output_tokens":276,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":315,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQVXb8CpdMEtLdKnGzi","type":"assistant","uuid":"177ce776-2858-4d28-84f8-87214215e7a1","timestamp":"2026-02-21T02:13:37.889Z"}
{"parentUuid":"177ce776-2858-4d28-84f8-87214215e7a1","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_013wDurT3EMq12aizeyZVPWo","toolUseID":"toolu_013wDurT3EMq12aizeyZVPWo","timestamp":"2026-02-21T02:13:37.994Z","uuid":"021a3c90-e050-427e-afa9-966ee75e67e3"}
{"parentUuid":"177ce776-2858-4d28-84f8-87214215e7a1","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013wDurT3EMq12aizeyZVPWo","type":"tool_result","content":"36\n\nFound 0 total occurrences across 0 files."}]},"uuid":"9a4e81fe-1f0e-4325-870e-eb9c42e7390e","timestamp":"2026-02-21T02:13:37.993Z","toolUseResult":{"mode":"count","numFiles":0,"filenames":[],"content":"36","numMatches":0},"sourceToolAssistantUUID":"177ce776-2858-4d28-84f8-87214215e7a1"}
{"parentUuid":"9a4e81fe-1f0e-4325-870e-eb9c42e7390e","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_019RTAomEMeNSmfQiZiYXxfh","type":"message","role":"assistant","content":[{"type":"text","text":"That's 36 matches but some tools appear in both the table and the event system text. The table itself has 38 tool rows. Let me just quickly scan the table section to confirm it looks right:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":303,"cache_read_input_tokens":46526,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":303},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQVuKpq1xXroyiVCPwV","type":"assistant","uuid":"0526eab7-bb7b-4f39-aff7-3cee1d2b405b","timestamp":"2026-02-21T02:13:41.808Z"}
{"parentUuid":"0526eab7-bb7b-4f39-aff7-3cee1d2b405b","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_019RTAomEMeNSmfQiZiYXxfh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01A4rdjoSfPQn4RgkSezrANe","name":"Read","input":{"file_path":"/home/greg/Developer/openfang/CLAUDE.md","offset":220},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":303,"cache_read_input_tokens":46526,"output_tokens":129,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":303,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQVuKpq1xXroyiVCPwV","type":"assistant","uuid":"fd59da25-abdd-43c5-a896-b521a115cc2e","timestamp":"2026-02-21T02:13:42.320Z"}
{"parentUuid":"fd59da25-abdd-43c5-a896-b521a115cc2e","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01A4rdjoSfPQn4RgkSezrANe","toolUseID":"toolu_01A4rdjoSfPQn4RgkSezrANe","timestamp":"2026-02-21T02:13:42.356Z","uuid":"f1d6a7a4-7bd5-4872-8c3b-0b5c1dda5911"}
{"parentUuid":"fd59da25-abdd-43c5-a896-b521a115cc2e","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01A4rdjoSfPQn4RgkSezrANe","type":"tool_result","content":"   220→| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n   221→| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n   222→| `web/public/css/style.css` | Complete design system |\n   223→| `fang/skill_loader.rb` | Skill discovery and execution |\n   224→| `fang/python_runner.rb` | Python virtualenv and code execution |\n   225→| `fang/document_parser.rb` | Multi-format document text extraction |\n   226→| `fang/gmail.rb` | Gmail OAuth2 integration |\n   227→| `fang/whatsapp.rb` | WhatsApp message routing |\n   228→| `fang/system_profile.rb` | Host system capability detection |\n   229→| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n   230→| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n   231→\n   232→## Existing MCP Tools (38 total)\n   233→\n   234→All tools live in `fang/tools/` and are auto-discovered via ObjectSpace.\n   235→\n   236→| Category | Tool | Purpose |\n   237→|---|---|---|\n   238→| **Core** | `run_code` | Execute Ruby code with model access |\n   239→| | `run_skill` | Execute saved skills by name |\n   240→| | `manage_python` | Run Python code, manage virtualenv and dependencies |\n   241→| | `send_message` | Send message + broadcast via SSE |\n   242→| **Scheduling** | `schedule_task` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n   243→| **Pages & Canvas** | `create_page` | Create Page (appears in nav) |\n   244→| | `get_canvas` | Read current page's widget layout |\n   245→| | `update_canvas` | Set page HTML content |\n   246→| | `add_canvas_component` | Add a widget to the canvas |\n   247→| | `update_canvas_component` | Modify a widget's position/content/data |\n   248→| | `remove_canvas_component` | Remove a widget |\n   249→| | `define_widget` | Create a new widget type (writes Ruby to disk) |\n   250→| **Documents** | `create_document` | Upload or generate a document |\n   251→| | `read_document` | Read extracted text from a document |\n   252→| | `list_documents` | List documents in a conversation |\n   253→| **Data Tables** | `create_data_table` | Create a dynamic SQLite table with custom schema |\n   254→| | `list_data_tables` | List all dynamic data tables |\n   255→| | `query_data_table` | Query records with filtering and sorting |\n   256→| | `insert_data_record` | Insert a row into a data table |\n   257→| | `update_data_record` | Update a row in a data table |\n   258→| | `delete_data_record` | Delete a row from a data table |\n   259→| **Approvals** | `create_approval` | Create a human-in-the-loop approval gate |\n   260→| | `list_approvals` | List pending and resolved approvals |\n   261→| | `resolve_approval` | Approve or reject a pending approval |\n   262→| **Automation** | `create_notification` | Create + broadcast notification |\n   263→| | `create_trigger` | Create event trigger (fires skill/prompt on matching event) |\n   264→| | `create_workflow` | Create multi-step workflow pipeline |\n   265→| | `create_heartbeat` | Set up a token-efficient monitor |\n   266→| | `update_heartbeat` | Modify a heartbeat's config |\n   267→| | `list_heartbeats` | View all heartbeats and their stats |\n   268→| **Web** | `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n   269→| | `start_computer_use` | Launch a browser automation session |\n   270→| **Gmail** | `gmail_search` | Search Gmail messages |\n   271→| | `gmail_read` | Read a Gmail message by ID |\n   272→| | `gmail_send` | Send an email via Gmail |\n   273→| | `gmail_draft` | Create a Gmail draft |\n   274→| | `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |\n   275→| | `gmail_labels` | List available Gmail labels |\n   276→"}]},"uuid":"04fceb69-52a2-42f3-b77e-f8ec5295f9b0","timestamp":"2026-02-21T02:13:42.355Z","toolUseResult":{"type":"text","file":{"filePath":"/home/greg/Developer/openfang/CLAUDE.md","content":"| `web/view_helpers.rb` | HTML rendering helpers (turbo_stream, markdown, message/notification cards) |\n| `web/turbo_broadcast.rb` | In-memory pub/sub for SSE |\n| `web/public/css/style.css` | Complete design system |\n| `fang/skill_loader.rb` | Skill discovery and execution |\n| `fang/python_runner.rb` | Python virtualenv and code execution |\n| `fang/document_parser.rb` | Multi-format document text extraction |\n| `fang/gmail.rb` | Gmail OAuth2 integration |\n| `fang/whatsapp.rb` | WhatsApp message routing |\n| `fang/system_profile.rb` | Host system capability detection |\n| `workspace/CLAUDE.md` | OpenFang's system prompt (the inner agent reads this) |\n| `workspace/.mcp.json` | MCP config passed to claude subprocess |\n\n## Existing MCP Tools (38 total)\n\nAll tools live in `fang/tools/` and are auto-discovered via ObjectSpace.\n\n| Category | Tool | Purpose |\n|---|---|---|\n| **Core** | `run_code` | Execute Ruby code with model access |\n| | `run_skill` | Execute saved skills by name |\n| | `manage_python` | Run Python code, manage virtualenv and dependencies |\n| | `send_message` | Send message + broadcast via SSE |\n| **Scheduling** | `schedule_task` | Schedule future tasks/reminders (supports `cron:` for recurring) |\n| **Pages & Canvas** | `create_page` | Create Page (appears in nav) |\n| | `get_canvas` | Read current page's widget layout |\n| | `update_canvas` | Set page HTML content |\n| | `add_canvas_component` | Add a widget to the canvas |\n| | `update_canvas_component` | Modify a widget's position/content/data |\n| | `remove_canvas_component` | Remove a widget |\n| | `define_widget` | Create a new widget type (writes Ruby to disk) |\n| **Documents** | `create_document` | Upload or generate a document |\n| | `read_document` | Read extracted text from a document |\n| | `list_documents` | List documents in a conversation |\n| **Data Tables** | `create_data_table` | Create a dynamic SQLite table with custom schema |\n| | `list_data_tables` | List all dynamic data tables |\n| | `query_data_table` | Query records with filtering and sorting |\n| | `insert_data_record` | Insert a row into a data table |\n| | `update_data_record` | Update a row in a data table |\n| | `delete_data_record` | Delete a row from a data table |\n| **Approvals** | `create_approval` | Create a human-in-the-loop approval gate |\n| | `list_approvals` | List pending and resolved approvals |\n| | `resolve_approval` | Approve or reject a pending approval |\n| **Automation** | `create_notification` | Create + broadcast notification |\n| | `create_trigger` | Create event trigger (fires skill/prompt on matching event) |\n| | `create_workflow` | Create multi-step workflow pipeline |\n| | `create_heartbeat` | Set up a token-efficient monitor |\n| | `update_heartbeat` | Modify a heartbeat's config |\n| | `list_heartbeats` | View all heartbeats and their stats |\n| **Web** | `web_fetch` | HTTP requests (GET/POST/PUT/PATCH/DELETE) |\n| | `start_computer_use` | Launch a browser automation session |\n| **Gmail** | `gmail_search` | Search Gmail messages |\n| | `gmail_read` | Read a Gmail message by ID |\n| | `gmail_send` | Send an email via Gmail |\n| | `gmail_draft` | Create a Gmail draft |\n| | `gmail_modify` | Modify Gmail message labels (archive, star, etc.) |\n| | `gmail_labels` | List available Gmail labels |\n","numLines":57,"startLine":220,"totalLines":276}},"sourceToolAssistantUUID":"fd59da25-abdd-43c5-a896-b521a115cc2e"}
{"parentUuid":"04fceb69-52a2-42f3-b77e-f8ec5295f9b0","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_019s9pgBZoW6pURGwvXrLFz5","type":"message","role":"assistant","content":[{"type":"text","text":"All 38 tools accounted for in CLAUDE.md. Let me count the tool rows to be sure: lines 238-275 = 38 rows. Correct."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1295,"cache_read_input_tokens":46829,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1295},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQWGiSbohpNhuR6CXN8","type":"assistant","uuid":"3cb55a74-c986-43c7-b5b2-ea9b11f09afa","timestamp":"2026-02-21T02:13:47.142Z"}
{"parentUuid":"3cb55a74-c986-43c7-b5b2-ea9b11f09afa","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_019s9pgBZoW6pURGwvXrLFz5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YFpjsggSj9jp49NMG9JpGc","name":"TaskUpdate","input":{"taskId":"2","status":"completed"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1295,"cache_read_input_tokens":46829,"output_tokens":110,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":1295,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQWGiSbohpNhuR6CXN8","type":"assistant","uuid":"e9b71dfb-49da-4728-bb57-f4bc6fb03d58","timestamp":"2026-02-21T02:13:47.514Z"}
{"parentUuid":"e9b71dfb-49da-4728-bb57-f4bc6fb03d58","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YFpjsggSj9jp49NMG9JpGc","type":"tool_result","content":"Updated task #2 status"}]},"uuid":"4de856a0-ebcd-4502-9bb2-f24b617dd969","timestamp":"2026-02-21T02:13:47.517Z","toolUseResult":{"success":true,"taskId":"2","updatedFields":["status"],"statusChange":{"from":"in_progress","to":"completed"}},"sourceToolAssistantUUID":"e9b71dfb-49da-4728-bb57-f4bc6fb03d58"}
{"parentUuid":"4de856a0-ebcd-4502-9bb2-f24b617dd969","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01StLXLysZhYewsUEiFZxae7","type":"message","role":"assistant","content":[{"type":"text","text":"Both files are updated. Here's a summary of all changes:\n\n### README.md\n- **Tool counts**: Updated \"18 tools\" → \"38 tools\" in all 4 places (diagram, paragraph, architecture table, MCP heading)\n- **Project structure**: Added `clients/`, `computer_use/`, `document_parser.rb`, `python_runner.rb`, `gmail.rb`, `system_profile.rb`\n- **New feature sections** (5 added after Workflows): Documents, Dynamic Data Tables, Approvals, Gmail Integration, Python Support\n- **Widgets table**: Added 6 missing widgets (`data_table`, `approval`, `computer_use`, `scheduled_jobs`, `settings`, `website`)\n- **Workflow step types**: Added `approval` step type\n- **MCP Tools table**: Expanded from 18 to all 38 tools, organized by category (Core, Scheduling, Pages & Canvas, Documents, Data Tables, Approvals, Automation, Web, Gmail)\n\n### CLAUDE.md\n- **Architecture tree**: Added `computer_use/`, `document_parser.rb`, `python_runner.rb`, `gmail.rb`\n- **Concerns**: Added `HasJsonDefaults` alongside `HasStatus`\n- **CSS tokens**: Updated all light/dark values to match actual `style.css`\n- **Event System**: Added `workflow:completed/failed` and `approval:approved/rejected/expired` events\n- **Workflow step types**: Added `approval`\n- **Key Files table**: Added 6 entries (`skill_loader.rb`, `python_runner.rb`, `document_parser.rb`, `gmail.rb`, `whatsapp.rb`, `system_profile.rb`)\n- **MCP Tools table**: Replaced 8-tool table with complete 38-tool table organized by category"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":128,"cache_read_input_tokens":48124,"output_tokens":421,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":128,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQWc6GcEFfKk9YBCC3S","type":"assistant","uuid":"fcbc393e-0b5a-4e72-b2f7-69a655f8617c","timestamp":"2026-02-21T02:13:58.567Z"}
{"parentUuid":"fcbc393e-0b5a-4e72-b2f7-69a655f8617c","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"efba9e4e-ac52-449b-a7ad-fa416ca94573","toolUseID":"efba9e4e-ac52-449b-a7ad-fa416ca94573","timestamp":"2026-02-21T02:13:58.570Z","uuid":"7bb3bb8b-4795-4728-808c-fb67f4c673b5"}
{"parentUuid":"7bb3bb8b-4795-4728-808c-fb67f4c673b5","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"entire hooks claude-code stop","durationMs":169}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-21T02:13:58.740Z","uuid":"36f850a3-c140-4312-a201-441361f92664","toolUseID":"efba9e4e-ac52-449b-a7ad-fa416ca94573"}
{"parentUuid":"36f850a3-c140-4312-a201-441361f92664","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"system","subtype":"turn_duration","durationMs":183150,"timestamp":"2026-02-21T02:13:58.741Z","uuid":"b0946e57-2448-4908-93a4-1654b1ba6f5a","isMeta":false}
{"type":"file-history-snapshot","messageId":"64ae682b-ab29-4b54-9df9-1def9ea7abef","snapshot":{"messageId":"64ae682b-ab29-4b54-9df9-1def9ea7abef","trackedFileBackups":{"README.md":{"backupFileName":"d67d4985e8911acf@v2","version":2,"backupTime":"2026-02-21T02:14:05.585Z"},"CLAUDE.md":{"backupFileName":"e76642578ae24c9d@v2","version":2,"backupTime":"2026-02-21T02:14:05.586Z"}},"timestamp":"2026-02-21T02:14:05.583Z"},"isSnapshotUpdate":false}
{"parentUuid":"b0946e57-2448-4908-93a4-1654b1ba6f5a","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":"commit this"},"uuid":"64ae682b-ab29-4b54-9df9-1def9ea7abef","timestamp":"2026-02-21T02:14:05.537Z","permissionMode":"acceptEdits"}
{"parentUuid":"64ae682b-ab29-4b54-9df9-1def9ea7abef","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Xk3kYbUqnyq2tueD8Zb7d7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BfhFKPxkaEiLhTzNzpmQmN","name":"Bash","input":{"command":"git diff --stat","description":"Show changed files summary"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5,"cache_read_input_tokens":48671,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":5},"output_tokens":27,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQXwDVL9RJfTKe9uhQC","type":"assistant","uuid":"ed98e6f7-62f1-454f-bcc4-dfea3ee22845","timestamp":"2026-02-21T02:14:09.458Z"}
{"parentUuid":"ed98e6f7-62f1-454f-bcc4-dfea3ee22845","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BfhFKPxkaEiLhTzNzpmQmN","type":"tool_result","content":" CLAUDE.md |  86 ++++++++++++++++++++++++++++++++++++++++-------------\n README.md | 100 +++++++++++++++++++++++++++++++++++++++++++++++++++++++-------\n 2 files changed, 154 insertions(+), 32 deletions(-)","is_error":false}]},"uuid":"e69930ac-9ea5-4e45-afaf-235579f29107","timestamp":"2026-02-21T02:14:09.569Z","toolUseResult":{"stdout":" CLAUDE.md |  86 ++++++++++++++++++++++++++++++++++++++++-------------\n README.md | 100 +++++++++++++++++++++++++++++++++++++++++++++++++++++++-------\n 2 files changed, 154 insertions(+), 32 deletions(-)","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"ed98e6f7-62f1-454f-bcc4-dfea3ee22845"}
{"parentUuid":"e69930ac-9ea5-4e45-afaf-235579f29107","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01Xk3kYbUqnyq2tueD8Zb7d7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01419RswBfLR9MAc2Wmp956F","name":"Bash","input":{"command":"git log --oneline -5","description":"Recent commit messages"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":5,"cache_read_input_tokens":48671,"output_tokens":160,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":5,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYLQXwDVL9RJfTKe9uhQC","type":"assistant","uuid":"afc560bb-6dbb-4a0b-b1f5-d248965cf034","timestamp":"2026-02-21T02:14:10.043Z"}
{"parentUuid":"afc560bb-6dbb-4a0b-b1f5-d248965cf034","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01419RswBfLR9MAc2Wmp956F","type":"tool_result","content":"cd24fc0 Add tests for documents, dynamic data tables, and approval workflows\n823bc6c Add documents, dynamic data tables, and approval workflows\nb3a71e7 Add collapsible agent metadata to conversation messages\n6dfd1df Add sidebar canvas archive button and click-outside-to-close fix\nfa2c56b Add double-click to rename tab names in chat footer","is_error":false}]},"uuid":"740c718f-43ea-4efb-a3ac-8f9f1a3457e5","timestamp":"2026-02-21T02:14:10.127Z","toolUseResult":{"stdout":"cd24fc0 Add tests for documents, dynamic data tables, and approval workflows\n823bc6c Add documents, dynamic data tables, and approval workflows\nb3a71e7 Add collapsible agent metadata to conversation messages\n6dfd1df Add sidebar canvas archive button and click-outside-to-close fix\nfa2c56b Add double-click to rename tab names in chat footer","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"afc560bb-6dbb-4a0b-b1f5-d248965cf034"}
{"parentUuid":"740c718f-43ea-4efb-a3ac-8f9f1a3457e5","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01TgxtctuBpWVHfrFBWcjrsB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SeeqXEDFSWJZqF3jdVHyrd","name":"Bash","input":{"command":"git add README.md CLAUDE.md && git commit -m \"$(cat <<'EOF'\nUpdate README.md and CLAUDE.md to reflect current framework state\n\nTool count 18→38, add docs for documents, data tables, approvals, Gmail,\nPython support, computer use. Update CSS tokens, event system, key files,\nand architecture tree to match reality.\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\"","description":"Commit documentation updates"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":358,"cache_read_input_tokens":48676,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":358},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQYGf2qfJkx3aQax2vZ","type":"assistant","uuid":"c165e535-c2ef-41f5-8064-85860cc98b21","timestamp":"2026-02-21T02:14:15.321Z"}
{"parentUuid":"c165e535-c2ef-41f5-8064-85860cc98b21","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SeeqXEDFSWJZqF3jdVHyrd","type":"tool_result","content":"[master 0e2aed4] Update README.md and CLAUDE.md to reflect current framework state\n 2 files changed, 154 insertions(+), 32 deletions(-)","is_error":false}]},"uuid":"5eeb7fdc-7882-4eeb-874b-e1ed6cc8a081","timestamp":"2026-02-21T02:14:15.529Z","toolUseResult":{"stdout":"[master 0e2aed4] Update README.md and CLAUDE.md to reflect current framework state\n 2 files changed, 154 insertions(+), 32 deletions(-)","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"c165e535-c2ef-41f5-8064-85860cc98b21"}
{"parentUuid":"5eeb7fdc-7882-4eeb-874b-e1ed6cc8a081","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","message":{"model":"claude-opus-4-6","id":"msg_01AarMMsohkmD1tTfVMPAHDC","type":"message","role":"assistant","content":[{"type":"text","text":"Committed as `0e2aed4`."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":239,"cache_read_input_tokens":49034,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":239},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYLQYfdthhRN5zxMXnqKh","type":"assistant","uuid":"89207d29-2d65-455b-928e-ed21b79a2dee","timestamp":"2026-02-21T02:14:17.552Z"}
{"parentUuid":"89207d29-2d65-455b-928e-ed21b79a2dee","isSidechain":false,"userType":"external","cwd":"/home/greg/Developer/openfang","sessionId":"ae4e7552-5677-46ed-bc8f-1e67ee5a7148","version":"2.1.50","gitBranch":"master","slug":"enchanted-percolating-badger","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"bbad604f-4839-46fe-8d48-824c9a74aa84","toolUseID":"bbad604f-4839-46fe-8d48-824c9a74aa84","timestamp":"2026-02-21T02:14:17.600Z","uuid":"d133f4d0-b652-4f77-923f-904a468a0cfa"}
